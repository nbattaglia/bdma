<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BDMA ‚Äì Iteraci√≥n 1 ¬∑ Sitio de soporte a la evaluaci√≥n</title>
<style>
  :root{
    --bg:#0b0c10;
    --panel:#0e1117;
    --muted:#a3a3a3;
    --text:#f1f5f9;
    --brand:#60a5fa;
    --accent:#34d399;
    --warn:#fbbf24;
    --danger:#f87171;
    --card:#0f172a;
    --code:#0b1220;
    --link:#93c5fd;
    --border:#1f2937;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font: 15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
    color:var(--text);
    background:linear-gradient(180deg, #0b1020, #0b0c10 30% 100%);
  }
  header{
    position:sticky; top:0; z-index:5;
    background:rgba(10,14,24,.85); backdrop-filter: blur(8px);
    border-bottom:1px solid var(--border);
  }
  .wrap{max-width:1160px; margin:0 auto; padding:16px}
  .title{display:flex; align-items:flex-start; justify-content:space-between; gap:16px; flex-wrap:wrap}
  .title h1{font-size:22px; margin:0}
  .lead{margin:6px 0 0 0; color:#cbd5e1}
  nav{display:flex; gap:10px; margin-top:12px; flex-wrap:wrap}
  nav button{
    background:#0c1220; color:#dbe6ff; border:1px solid var(--border); border-radius:10px;
    padding:8px 12px; cursor:pointer; transition:.2s;
  }
  nav button.active{border-color:#2b66ff; box-shadow: 0 0 0 2px rgba(43,102,255,.25) inset}
  main{padding:24px 0}
  section{display:none}
  section.active{display:block; animation:fade .2s ease}
  @keyframes fade{from{opacity:.6; transform:translateY(4px)} to{opacity:1; transform:none}}

  /* layout */
  .grid{display:grid; grid-template-columns:repeat(12,1fr); gap:14px}
  .card{grid-column: span 12; background:linear-gradient(180deg,#0f172a,#0b1220 40% 100%);
        border:1px solid var(--border); border-radius:16px; padding:16px}
  .card h3{margin:0 0 8px 0; font-size:18px}
  .muted{color:var(--muted)}
  .kpi{display:flex; gap:12px; flex-wrap:wrap}
  .kpi .pill{background:#0b1220; border:1px solid var(--border); border-radius:999px; padding:4px 10px; color:#cbd5e1}
  .info{border-left:3px solid var(--brand); padding:8px 12px; background:#0b1220; color:#c7d2fe; border-radius:8px}

  table{width:100%; border-collapse:collapse; background:#0b1220; border:1px solid var(--border); border-radius:12px; overflow:hidden}
  th,td{padding:10px 12px; border-bottom:1px solid var(--border); vertical-align:top}
  th{background:#0f172a; text-align:left; color:#cbd5e1; position:sticky; top:0; z-index:1}
  tr:hover td{background:#0e1528}
  .controls{display:flex; gap:10px; justify-content:space-between; align-items:center; margin:8px 0 14px}
  .search{display:flex; gap:8px; align-items:center}
  .search input{background:#0b1220; color:#e2e8f0; border:1px solid var(--border); border-radius:10px; padding:8px 10px; width:280px}
  .btn{appearance:none; background:#0c1220; color:#e5edff; border:1px solid var(--border); border-radius:10px; padding:8px 12px; cursor:pointer}
  .btn:hover{border-color:#2b66ff}
  a{color:var(--link); text-decoration:none}
  a:hover{text-decoration:underline}

  pre{background:var(--code); border:1px solid var(--border); color:#e2e8f0; border-radius:12px; padding:12px; overflow:auto}
  code{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,monospace; font-size:13px}
  .codebar{display:flex; justify-content:space-between; align-items:center; gap:8px; margin:6px 0}
  .tag{font-size:12px; color:#a3bffa; background:#0b1220; border:1px solid var(--border); border-radius:999px; padding:2px 8px}

  /* Context map */
  #mapWrap{position:relative; background:#0b1220; border:1px solid var(--border); border-radius:16px; padding:12px; min-height:500px}
  #mapSvg{position:absolute; inset:0; pointer-events:none}
  .ctx{position:absolute; width:240px; min-height:72px; background:#0f172a; border:1px solid var(--border); border-radius:12px; padding:10px}
  .ctx h4{margin:0 0 6px 0; font-size:15px; color:#e5e7eb}
  .ctx p{margin:0; color:#a1a1aa; font-size:13px}
  .edge{stroke:#64b5f6; stroke-width:2; marker-end:url(#arrow)}

  /* Responsive */
  @media (min-width:860px){
    .card.span6{grid-column: span 6}
  }
  @media print{
    header, nav, .controls{display:none !important}
    body{background:white; color:black}
    .card, table, pre{border-color:#ddd}
    a{color:black; text-decoration:none}
  }

  footer{padding:28px 16px; border-top:1px solid var(--border); color:#98a2b3}
</style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="title">
        <div>
          <h1>BDMA ‚Äì Iteraci√≥n 1 ¬∑ Sitio de soporte a la evaluaci√≥n</h1>
          <p class="lead">Recolecci√≥n curada de artefactos: requisitos, escenarios BDD, derivaciones de Fase 1 a 5, contratos API y trazabilidad integral.</p>
        </div>
        <div class="kpi">
          <span class="pill">8 bounded contexts</span>
          <span class="pill">25+ endpoints</span>
          <span class="pill">Gherkin listo para copiar</span>
          <span class="pill">Context map interactivo</span>
        </div>
      </div>
      <nav id="tabs"></nav>
    </div>
  </header>

  <main class="wrap">
    <!-- RESUMEN -->
    <section id="intro" class="active">
      <div class="grid">
        <div class="card">
          <h3>Prop√≥sito</h3>
          <p class="muted">Este sitio acompa√±a la evaluaci√≥n del art√≠culo sobre <strong>BDMA (Behavior-Driven Microservice Architecture)</strong>, un marco metodol√≥gico sistem√°tico y reproducible que gu√≠a la identificaci√≥n, dise√±o y evoluci√≥n de arquitecturas de microservicios en contextos √°giles greenfield.</p>
          <p class="muted">BDMA transforma escenarios funcionales BDD en bounded contexts, contratos de servicio e interfaces verificables, integrando principios de Domain-Driven Design (DDD), t√©cnicas de Behavior-Driven Development (BDD) y pr√°cticas de arquitectura evolutiva.</p>
          <div class="info">Se exponen artefactos trazables que evidencian c√≥mo los escenarios BDD conducen, paso a paso, a decisiones arquitect√≥nicas verificables aplicadas a una plataforma de publicaciones cient√≠ficas.</div>
        </div>

        <div class="card span6">
          <h3>C√≥mo navegar</h3>
          <ol class="muted">
            <li>Usar las pesta√±as superiores para acceder a cada fase y artefacto.</li>
            <li>Filtrar tablas con el cuadro de <em>Buscar‚Ä¶</em>.</li>
            <li>Copiar fragmentos Gherkin mediante el bot√≥n <em>Copiar</em>.</li>
            <li>Utilizar <em>Imprimir</em> para exportar secciones a PDF.</li>
          </ol>
        </div>

        <div class="card span6">
          <h3>Alcance</h3>
          <p class="muted">Primera iteraci√≥n: desde requisitos y escenarios clave hasta contratos contract‚Äëfirst y bit√°cora ADR inicial. Las decisiones se establecen con una granularidad adecuada para su verificaci√≥n emp√≠rica.</p>
        </div>
      </div>
    </section>

    <!-- MARCO BDMA -->
    <section id="marco"></section>

    <!-- REQUISITOS -->
    <section id="requisitos"></section>

    <!-- BDD -->
    <section id="bdd"></section>

    <!-- FASE 1 -->
    <section id="fase1"></section>

    <!-- FASE 2 -->
    <section id="fase2"></section>

    <!-- FASE 3 -->
    <section id="fase3"></section>

    <!-- FASE 4 -->
    <section id="fase4"></section>

    <!-- FASE 5 -->
    <section id="fase5"></section>
  </main>

  <footer class="wrap">
    <small>BDMA ‚Äì Sitio de soporte para evaluaci√≥n. Versi√≥n de demostraci√≥n est√°tica.</small>
  </footer>

<script>
/* ---------- Data (curada a partir de la Iteraci√≥n 1) ---------- */
const requisitos = {
  contexto: "Una organizaci√≥n acad√©mica internacional quiere desarrollar una plataforma distribuida para la gesti√≥n integral de publicaciones cient√≠ficas en revistas y congresos, abierta a investigadores de todo el mundo. La plataforma debe permitir a autores, revisores, editores y organizadores de eventos interactuar de manera asincr√≥nica y conforme a reglas definidas por pol√≠ticas editoriales din√°micas, garantizando escalabilidad y evoluci√≥n controlada.",
  noFunc: [
    "Trazabilidad: escenarios ‚Üî comandos ‚Üî eventos ‚Üî contratos ‚Üî ADR",
    "Auditabilidad de acciones cr√≠ticas (login, decisiones, emisiones)",
    "Evoluci√≥n controlada de pol√≠ticas y reglas editoriales",
    "Integraci√≥n segura con proveedores externos (ORCID, Scholar/Scopus, DOI)",
    "Escalabilidad del sistema para equipos distribuidos",
    "Estabilidad general ante cambios en reglas editoriales"
  ],
  funcionales: [
    "Registro y autenticaci√≥n de investigadores",
    "Perfiles con afiliaci√≥n institucional, ORCID, √°reas de inter√©s y m√©tricas de impacto",
    "Env√≠o de art√≠culos a congresos o revistas cient√≠ficas",
    "Versionado de env√≠os y control de fechas l√≠mite",
    "Registro de revisores con especialidades",
    "Asignaci√≥n autom√°tica y manual de revisores; revisi√≥n ciega simple o doble",
    "Historial de revisiones por art√≠culo",
    "Alta de revistas y eventos; configuraci√≥n de reglas editoriales versionadas",
    "Administraci√≥n de editores y comit√©s cient√≠ficos",
    "Emisi√≥n de cartas de aceptaci√≥n y certificados autom√°ticos",
    "Generaci√≥n de m√©tricas por autor, art√≠culo, evento y revista",
    "Exportaci√≥n a formatos est√°ndar (CSV, JSON-LD, XML)",
    "Notificaciones autom√°ticas con resumen mensual personalizado",
    "Sincronizaci√≥n con ORCID, Scopus y Google Scholar",
    "Validaci√≥n de DOI y metadatos para cada publicaci√≥n"
  ]
};

const gruposF1 = [
  {id:"G01", nombre:"Identity & Access", proposito:"Alta y autenticaci√≥n; control de acceso/bloqueo", escenarios:["registro-exitoso","autenticacion-ok","autenticacion-falla","bloqueo"]},
  {id:"G02", nombre:"Profiles", proposito:"Perfil, afiliaci√≥n, √°reas y m√©tricas de impacto", escenarios:["perfil-basico","sincronizacion-metricas"]},
  {id:"G03", nombre:"Submissions", proposito:"Ciclo de vida de env√≠os y versionado; deadlines", escenarios:["envio-evento","envio-revista","deadline","versionado"]},
  {id:"G04", nombre:"Reviewing", proposito:"Revisores, conflictos, asignaci√≥n e informes", escenarios:["alta-revisor","conflictos","auto-assign","manual-assign","ceguera-simple","aceptacion","declinacion","entrega","historial"]},
  {id:"G05", nombre:"Editorial Decisioning", proposito:"C√°lculo de decisi√≥n, cierre y certificados", escenarios:["decision","aceptacion-final"]},
  {id:"G06", nombre:"Venue Management", proposito:"Revistas/eventos, reglas versionadas y roles", escenarios:["alta-revista","alta-evento","versionado-reglas","roles-editoriales"]},
  {id:"G07", nombre:"Metrics & Reporting", proposito:"KPIs, exportaciones y boletines", escenarios:["metricas-autor","metricas-revista","export","boletin"]},
  {id:"G08", nombre:"External Integrations", proposito:"ORCID/Scopus/Scholar y validaci√≥n de DOI", escenarios:["orcid","scopus-scholar","doi"]}
];

const fase2ComEv = [
  {ctx:"G01 Identity & Access", comandos:["RegistrarCuenta","Autenticar","RegistrarIntentoFallido","BloquearCuenta"], eventos:["CuentaActivada","SesionIniciada","AccesoDenegado","CuentaBloqueada"]},
  {ctx:"G02 Profiles", comandos:["ActualizarPerfil","SincronizarMetricas"], eventos:["PerfilActualizado","MetricasSincronizadas"]},
  {ctx:"G03 Submissions", comandos:["RegistrarEnvioEvento","RegistrarEnvioRevista","ValidarDeadline/IntentarRegistrarEnvio","AdjuntarVersion"], eventos:["EnvioRegistrado","EnvioRechazadoPorDeadline","VersionAdjuntada"]},
  {ctx:"G04 Reviewing", comandos:["RegistrarRevisor","DeclararConflicto","AsignarRevisoresAutomaticamente","AsignarRevisorManual","ConfigurarCeguera","AceptarInvitacion","DeclinarInvitacion","RegistrarRevision","ConsultarHistorial"], eventos:["RevisorRegistrado","ConflictoRegistrado","RevisoresAsignados","RevisorAsignadoManual","InvitacionAceptada","InvitacionDeclinada","RevisionRegistrada"]},
  {ctx:"G05 Editorial Decisioning", comandos:["CalcularDecisionEditorial","EmitirCertificado"], eventos:["DecisionEmitida","CertificadoEmitido","ExpedienteCerrado"]},
  {ctx:"G06 Venue Management", comandos:["CrearRevista","CrearEvento","PublicarReglas","AsignarRolesEditoriales"], eventos:["RevistaCreada","EventoCreado","ReglasPublicadas","RolesAsignados"]},
  {ctx:"G07 Metrics & Reporting", comandos:["GenerarMetricasAutor","GenerarMetricasRevista","ExportarDatos","EnviarBoletin"], eventos:["ReporteGenerado","ExportacionLista","BoletinEnviado"]},
  {ctx:"G08 External Integrations", comandos:["SincronizarORCID","ImportarDesdeScopusScholar","ValidarDOI","ValidarMetadatos"], eventos:["PerfilSincronizado","PublicacionesImportadas","DOIVerificado","MetadatosValidados"]},
];

const bc = [
  {id:"BC01", name:"Identity & Access", resp:"Gesti√≥n de identidad, autenticaci√≥n y autorizaci√≥n"},
  {id:"BC02", name:"Profiles", resp:"Gesti√≥n de perfil, afiliaci√≥n y m√©tricas del investigador"},
  {id:"BC03", name:"Submissions", resp:"Registro y gesti√≥n de env√≠os a revistas o eventos"},
  {id:"BC04", name:"Reviewing", resp:"Gesti√≥n de revisores, conflictos, asignaciones y revisiones"},
  {id:"BC05", name:"Editorial Decisioning", resp:"C√°lculo/registro de decisiones; cierre/ certificados"},
  {id:"BC06", name:"Venue Management", resp:"Alta de venues; publicaci√≥n de reglas y roles"},
  {id:"BC07", name:"Metrics & Reporting", resp:"Generaci√≥n de m√©tricas, reportes y boletines"},
  {id:"BC08", name:"External Integrations", resp:"ORCID/Scholar/Scopus; validaci√≥n DOI"}
];

const interactions = [
  {from:"BC03", to:"BC04", type:"Event Publisher / Partnership", note:"Al registrar env√≠o"},
  {from:"BC03", to:"BC05", type:"Event Publisher / Partnership", note:"Dispara decisi√≥n"},
  {from:"BC04", to:"BC05", type:"Event Publisher", note:"Al cerrar revisiones"},
  {from:"BC05", to:"BC03", type:"Event Subscriber", note:"Marca aceptado/rechazado"},
  {from:"BC06", to:"BC03", type:"OHS + Event Publisher", note:"Reglas publicadas"},
  {from:"BC06", to:"BC04", type:"OHS + Event Publisher", note:"Reglas publicadas"},
  {from:"BC06", to:"BC05", type:"OHS + Event Publisher", note:"Reglas publicadas"},
  {from:"BC08", to:"BC02", type:"ACL", note:"Sync de perfil/m√©tricas"},
  {from:"BC08", to:"BC03", type:"ACL", note:"Validaci√≥n DOI/Metadatos"}
];

const endpoints = [
  {g:"G01", ctx:"Identity & Access", method:"POST", path:"/auth/register", req:"email, password, orcidId?", res:"userId, estadoCuenta", codes:"201; 400; 409", escenario:"registro-exitoso"},
  {g:"G01", ctx:"Identity & Access", method:"POST", path:"/auth/login", req:"email, password", res:"token, exp, userId", codes:"200; 401", escenario:"autenticacion-ok | autenticacion-falla"},
  {g:"G01", ctx:"Identity & Access", method:"POST", path:"/auth/lockouts/evaluate", req:"userId", res:"locked(bool), reason?", codes:"200; 423", escenario:"bloqueo"},

  {g:"G02", ctx:"Profiles", method:"PUT", path:"/profiles/{researcherId}", req:"nombre, afiliacion, areas[], orcidId?", res:"researcherId, actualizadoAt", codes:"200; 400; 404", escenario:"perfil-basico"},
  {g:"G02", ctx:"Profiles", method:"POST", path:"/profiles/{researcherId}/metrics/sync", req:"fuentes[]", res:"hIndex, citas, fuente, fecha", codes:"200; 424", escenario:"sincronizacion-metricas"},

  {g:"G03", ctx:"Submissions", method:"POST", path:"/venues/{venueId}/submissions", req:"titulo, autores[], archivos[], submittedAt", res:"submissionId, version=1, status", codes:"201; 422", escenario:"envio-evento | deadline"},
  {g:"G03", ctx:"Submissions", method:"POST", path:"/journals/{journalId}/submissions", req:"titulo, autores[], archivos[]", res:"submissionId, version=1, status", codes:"201", escenario:"envio-revista"},
  {g:"G03", ctx:"Submissions", method:"POST", path:"/submissions/{submissionId}/versions", req:"archivos[], notes?", res:"version++, estado", codes:"201; 409", escenario:"versionado"},

  {g:"G04", ctx:"Reviewing", method:"POST", path:"/reviewers", req:"nombre, especialidades[], afiliacion", res:"reviewerId", codes:"201; 400", escenario:"alta-revisor"},
  {g:"G04", ctx:"Reviewing", method:"POST", path:"/reviewers/{reviewerId}/conflicts", req:"submissionId, tipo, descripcion", res:"conflictId, registradoAt", codes:"201; 409", escenario:"conflictos"},
  {g:"G04", ctx:"Reviewing", method:"POST", path:"/submissions/{submissionId}/assignments:auto", req:"nMin, ceguera", res:"assignments[], blindPolicy", codes:"201; 409", escenario:"auto-assign / ceguera-simple"},
  {g:"G04", ctx:"Reviewing", method:"POST", path:"/submissions/{submissionId}/assignments", req:"reviewerId, ceguera?", res:"assignmentId, estado", codes:"201; 409", escenario:"manual-assign"},
  {g:"G04", ctx:"Reviewing", method:"POST", path:"/assignments/{assignmentId}/accept", req:"‚Äî", res:"assignmentId, estado=ACEPTADO", codes:"200; 409", escenario:"aceptacion"},
  {g:"G04", ctx:"Reviewing", method:"POST", path:"/assignments/{assignmentId}/decline", req:"motivo?", res:"assignmentId, estado=DECLINADO", codes:"200", escenario:"declinacion"},
  {g:"G04", ctx:"Reviewing", method:"POST", path:"/submissions/{submissionId}/reviews", req:"assignmentId, recomendacion, comentarios", res:"reviewId, registradaAt", codes:"201; 403", escenario:"entrega"},
  {g:"G04", ctx:"Reviewing", method:"GET",  path:"/submissions/{submissionId}/reviews", req:"estado?, reviewerId?", res:"listaReviews[]", codes:"200", escenario:"historial"},

  {g:"G05", ctx:"Editorial Decisioning", method:"POST", path:"/submissions/{submissionId}/decision", req:"decision, notas?", res:"decisionId, quorumOk", codes:"201; 409", escenario:"decision"},
  {g:"G05", ctx:"Editorial Decisioning", method:"POST", path:"/submissions/{submissionId}/acceptance-letter", req:"templateId?, locale?", res:"urlCarta, emitidaAt", codes:"200; 409", escenario:"aceptacion-final"},

  {g:"G06", ctx:"Venue Management", method:"POST", path:"/venues/journals", req:"nombre, scope, politicasIniciales", res:"journalId", codes:"201; 409", escenario:"alta-revista"},
  {g:"G06", ctx:"Venue Management", method:"POST", path:"/venues/conferences", req:"nombre, fechas{...}, politicasIniciales", res:"conferenceId", codes:"201; 409", escenario:"alta-evento"},
  {g:"G06", ctx:"Venue Management", method:"POST", path:"/venues/{venueId}/rulesets", req:"version, reglas{...}, vigencia", res:"rulesetId, version", codes:"201; 409", escenario:"versionado-reglas"},
  {g:"G06", ctx:"Venue Management", method:"POST", path:"/venues/{venueId}/roles", req:"usuarioId, rol", res:"roleId", codes:"201; 404", escenario:"roles-editoriales"},

  {g:"G08", ctx:"External Integrations", method:"POST", path:"/integrations/orcid/sync", req:"researcherId, accessToken", res:"perfil{orcidId,...}, sincronizadoAt", codes:"200; 424", escenario:"orcid"},
  {g:"G08", ctx:"External Integrations", method:"POST", path:"/integrations/scholar-scopus/sync", req:"researcherId", res:"metrics{hIndex,citas}, fuente", codes:"200; 424", escenario:"scopus-scholar"},
  {g:"G08", ctx:"External Integrations", method:"POST", path:"/integrations/doi/validate", req:"doi, metadatos", res:"valido(bool), issues[]", codes:"200; 422", escenario:"doi"}
];

const adrLog = [
  { id:"ADR-000", fecha:"2025-08-11", estado:"Aceptado", texto:"Adoptar la arquitectura resultante de BDMA Fases 1‚Äì4 como versi√≥n inicial (v1.0)." }
];

const trazabilidad = [
  ["registro-exitoso","BC01","RegistrarCuenta","CuentaActivada","POST /auth/register","ADR-000"],
  ["autenticacion-ok","BC01","Autenticar","SesionIniciada","POST /auth/login","ADR-000"],
  ["autenticacion-falla","BC01","Autenticar","AccesoDenegado","POST /auth/login","ADR-000"],
  ["bloqueo","BC01","BloquearCuenta","CuentaBloqueada","POST /auth/lockouts/evaluate","ADR-000"],
  ["perfil-basico","BC02","ActualizarPerfil","PerfilActualizado","PUT /profiles/{researcherId}","ADR-000"],
  ["sincronizacion-metricas","BC02","SincronizarMetricas","MetricasSincronizadas","POST /profiles/{id}/metrics/sync","ADR-000"],
  ["envio-evento","BC03","RegistrarEnvioEvento","EnvioRegistrado","POST /venues/{venueId}/submissions","ADR-000"],
  ["envio-revista","BC03","RegistrarEnvioRevista","EnvioRegistrado","POST /journals/{journalId}/submissions","ADR-000"],
  ["deadline","BC03","IntentarRegistrarEnvio","EnvioRechazadoPorDeadline","POST /venues/{venueId}/submissions","ADR-000"],
  ["versionado","BC03","AdjuntarVersion","VersionAdjuntada","POST /submissions/{id}/versions","ADR-000"],
  ["alta-revisor","BC04","RegistrarRevisor","RevisorRegistrado","POST /reviewers","ADR-000"],
  ["conflictos","BC04","DeclararConflicto","ConflictoRegistrado","POST /reviewers/{id}/conflicts","ADR-000"],
  ["auto-assign","BC04","AsignarRevisoresAutomaticamente","RevisoresAsignados","POST /submissions/{id}/assignments:auto","ADR-000"],
  ["manual-assign","BC04","AsignarRevisorManual","RevisorAsignadoManual","POST /submissions/{id}/assignments","ADR-000"],
  ["ceguera-simple","BC04","ConfigurarCeguera","(flag aplicado)","POST /submissions/{id}/assignments","ADR-000"],
  ["aceptacion","BC04","AceptarInvitacion","InvitacionAceptada","POST /assignments/{id}/accept","ADR-000"],
  ["declinacion","BC04","DeclinarInvitacion","InvitacionDeclinada","POST /assignments/{id}/decline","ADR-000"],
  ["entrega","BC04","RegistrarRevision","RevisionRegistrada","POST /submissions/{id}/reviews","ADR-000"],
  ["historial","BC04","ConsultarHistorial","‚Äî","GET /submissions/{id}/reviews","ADR-000"],
  ["decision","BC05","CalcularDecisionEditorial","DecisionEmitida","POST /submissions/{id}/decision","ADR-000"],
  ["aceptacion-final","BC05","EmitirCertificado","CertificadoEmitido","POST /submissions/{id}/acceptance-letter","ADR-000"],
  ["alta-revista","BC06","CrearRevista","VenueCreado","POST /venues/journals","ADR-000"],
  ["alta-evento","BC06","CrearEvento","EventoCreado","POST /venues/conferences","ADR-000"],
  ["versionado-reglas","BC06","PublicarVersionReglas","ReglasPublicadas","POST /venues/{id}/rulesets","ADR-000"],
  ["roles-editoriales","BC06","AsignarRolEditorial","RolesAsignados","POST /venues/{id}/roles","ADR-000"],
  ["metricas-autor","BC07","GenerarMetricasAutor","ReporteGenerado","GET /reports/authors","ADR-000"],
  ["metricas-revista","BC07","GenerarMetricasRevista","ReporteGenerado","GET /reports/venues","ADR-000"],
  ["export","BC07","GenerarExportacion","ExportacionLista","POST /exports","ADR-000"],
  ["boletin","BC07","EnviarBoletin","BoletinEnviado","POST /digests/monthly","ADR-000"],
  ["orcid","BC08","SincronizarORCID","PerfilSincronizado","POST /integrations/orcid/sync","ADR-000"],
  ["scopus-scholar","BC08","ImportarPublicaciones","PublicacionesImportadas","POST /integrations/scholar-scopus/sync","ADR-000"],
  ["doi","BC08","ValidarDOI","DOIVerificado","POST /integrations/doi/validate","ADR-000"],
];

/* --- BDD snippets (subset curado) --- */
const bddBlocks = [
{ tag:"@registro-exitoso", feature:"Registro y autenticaci√≥n de investigadores", text:`Feature: Registro y autenticaci√≥n de investigadores
  Como Investigador
  Quiero registrarme y autenticarme
  Para gestionar mis env√≠os y revisiones

  @registro-exitoso
  Scenario: Registro exitoso con ORCID y verificaci√≥n de email
    Given existe el proveedor de identidad "ORCID"
    And no existe una cuenta previa con email "ana@uni.edu"
    When el Investigador se registra con ORCID v√°lido y email "ana@uni.edu"
    And confirma el email recibido
    Then la cuenta "ana@uni.edu" queda en estado "Activa"
    And el perfil se crea con ORCID vinculado`},

{ tag:"@autenticacion-ok", feature:"Registro y autenticaci√≥n de investigadores", text:`@autenticacion-ok
Scenario: Autenticaci√≥n exitosa con credenciales v√°lidas
  Given existe la cuenta "ana@uni.edu" en estado "Activa" con password "s3cret!"
  When intenta autenticarse con email "ana@uni.edu" y password "s3cret!"
  Then el acceso es concedido
  And se registra auditor√≠a de inicio de sesi√≥n`},

{ tag:"@autenticacion-falla", feature:"Registro y autenticaci√≥n de investigadores", text:`@autenticacion-falla
Scenario: Autenticaci√≥n rechazada por contrase√±a incorrecta
  Given existe la cuenta "ana@uni.edu" en estado "Activa" con password "s3cret!"
  When intenta autenticarse con email "ana@uni.edu" y password "wrong"
  Then el acceso es denegado por credenciales inv√°lidas`},

{ tag:"@bloqueo", feature:"Registro y autenticaci√≥n de investigadores", text:`@bloqueo
Scenario: Bloqueo por m√∫ltiples intentos fallidos
  Given existe la cuenta "mike@uni.edu" en estado "Activa" con password "pass"
  When intenta autenticarse 5 veces con password incorrecto
  Then la cuenta "mike@uni.edu" queda en estado "Bloqueada"
  And se notifica al usuario por email`},

{ tag:"@perfil-basico", feature:"Gesti√≥n de perfil de investigador", text:`Feature: Gesti√≥n de perfil de investigador
  Como Investigador
  Quiero mantener mi perfil con afiliaci√≥n, √°reas y m√©tricas
  Para facilitar asignaciones y reportes

  @perfil-basico
  Scenario: Completar afiliaci√≥n y √°reas de inter√©s
    Given el Investigador "Ana" tiene un perfil inicial sin afiliaci√≥n ni √°reas
    When actualiza afiliaci√≥n a "Universidad X" y √°reas ["IA", "NLP"]
    Then el perfil de "Ana" muestra afiliaci√≥n "Universidad X" y √°reas ["IA", "NLP"]`},

{ tag:"@sincronizacion-metricas", feature:"Gesti√≥n de perfil de investigador", text:`@sincronizacion-metricas
Scenario: Importar m√©tricas desde ORCID/Google Scholar
  Given el perfil "Ana" tiene ORCID vinculado
  When sincroniza m√©tricas de citaciones e √≠ndice-h desde "Google Scholar"
  Then el perfil exhibe m√©tricas actualizadas con fuente "Google Scholar" y fecha de actualizaci√≥n`},

{ tag:"@envio-evento", feature:"Env√≠o y versionado de art√≠culos", text:`Feature: Env√≠o y versionado de art√≠culos
  Como Autor
  Quiero enviar y versionar art√≠culos
  Para postular a revistas y conferencias respetando deadlines

  @envio-evento
  Scenario: Env√≠o v√°lido a evento antes del deadline
    Given existe el Evento "IC-2026" con fecha l√≠mite de env√≠o "2026-05-01"
    And soy Autor con perfil completo
    When env√≠o el Art√≠culo "A-101" a "IC-2026" en fecha "2026-04-20"
    Then se registra el Env√≠o "E-1" en estado "Enviado" con versi√≥n 1
    And recibo comprobante de env√≠o con sello de tiempo`},

{ tag:"@envio-revista", feature:"Env√≠o y versionado de art√≠culos", text:`@envio-revista
Scenario: Env√≠o v√°lido a revista con revisi√≥n doble ciego
  Given existe la Revista "SJ-ML" con tipo de revisi√≥n "Doble ciego"
  And soy Autor con perfil completo
  When env√≠o el Art√≠culo "A-202" a "SJ-ML" en fecha "2026-03-10"
  Then se registra el Env√≠o "E-2" en estado "Enviado" con versi√≥n 1
  And se verifica que el archivo no contenga datos identificatorios`},

{ tag:"@deadline", feature:"Env√≠o y versionado de art√≠culos", text:`@deadline
Scenario: Rechazo por env√≠o fuera de fecha
  Given existe el Evento "IC-2026" con fecha l√≠mite de env√≠o "2026-05-01"
  And soy Autor con perfil completo
  When env√≠o el Art√≠culo "A-102" a "IC-2026" en fecha "2026-05-10"
  Then el sistema rechaza el env√≠o por deadline excedido con motivo "Fecha l√≠mite superada"`},

{ tag:"@versionado", feature:"Env√≠o y versionado de art√≠culos", text:`@versionado
Scenario: Nuevo versionado de un env√≠o en curso
  Given existe el Env√≠o "E-1" del Art√≠culo "A-101" en estado "Enviado" y versi√≥n 1
  When adjunto una nueva versi√≥n con cambios menores
  Then el Env√≠o "E-1" queda en versi√≥n 2
  And el historial conserva versiones [1, 2]`},

{ tag:"@alta-revisor", feature:"Registro de revisores y especialidades", text:`Feature: Registro de revisores y especialidades
  Como Revisor
  Quiero registrar mis especialidades y conflictos
  Para recibir asignaciones apropiadas

  @alta-revisor
  Scenario: Registro de revisor con especialidades
    Given no existe el Revisor "r1"
    When registro al Revisor "r1" con especialidades ["IA", "NLP"]
    Then el Revisor "r1" queda "Activo" con especialidades ["IA", "NLP"]`},

{ tag:"@conflictos", feature:"Registro de revisores y especialidades", text:`@conflictos
Scenario: Declaraci√≥n de conflicto de inter√©s
  Given el Revisor "r1" est√° "Activo"
  When declara conflicto con el Autor "Ana" por coautor√≠a reciente
  Then el conflicto queda registrado y bloquea asignaciones con "Ana" por 2 a√±os`},

{ tag:"@auto-assign", feature:"Asignaci√≥n de revisores y manejo de ceguera", text:`Feature: Asignaci√≥n de revisores y manejo de ceguera
  Como Editor
  Quiero asignar revisores autom√°ticamente o manualmente
  Para iniciar la evaluaci√≥n cumpliendo reglas y anonimato

  @auto-assign
  Scenario: Asignaci√≥n autom√°tica seg√∫n especialidad y conflictos
    Given existe el Env√≠o "E-1" con tema "NLP"
    And candidatos Revisores ["r1:IA", "r2:SE", "r3:NLP", "r4:IA"]
    And el Revisor "r2" tiene conflicto con el Autor de "E-1"
    And las reglas editoriales exigen "3" revisores
    When ejecuto la asignaci√≥n autom√°tica para "E-1"
    Then quedan asignados 3 revisores especialistas sin conflictos
    And el Autor no ve las identidades de los revisores
    And los Revisores no ven la identidad ni afiliaci√≥n del Autor`},

{ tag:"@manual-assign", feature:"Asignaci√≥n de revisores y manejo de ceguera", text:`@manual-assign
Scenario: Asignaci√≥n manual con validaci√≥n de conflictos
  Given existe el Env√≠o "E-1" pendiente de asignaci√≥n
  And el Editor selecciona "r2", "r3" y "r4"
  When confirma la asignaci√≥n manual
  Then el sistema impide asignar "r2" por conflicto registrado
  And propone candidatos alternativos compatibles`},

{ tag:"@ceguera-simple", feature:"Asignaci√≥n de revisores y manejo de ceguera", text:`@ceguera-simple
Scenario: Aplicaci√≥n de ceguera simple en revista configurada
  Given la Revista "SJ-DS" tiene tipo de revisi√≥n "Ciego simple"
  And existe el Env√≠o "E-3" a "SJ-DS"
  When asigno revisores para "E-3"
  Then los Revisores no ven la identidad del Autor
  And el Autor puede ver las identidades de los Revisores solo despu√©s de la decisi√≥n final`},

{ tag:"@aceptacion", feature:"Ciclo de revisi√≥n por pares", text:`Feature: Ciclo de revisi√≥n por pares
  Como Revisor
  Quiero aceptar/declinar invitaciones y cargar evaluaciones
  Para contribuir a la decisi√≥n editorial

  @aceptacion
  Scenario: Revisor acepta invitaci√≥n
    Given el Revisor "r3" fue invitado a revisar el Env√≠o "E-1"
    When "r3" acepta la invitaci√≥n dentro de 3 d√≠as
    Then la asignaci√≥n de "r3" pasa a estado "Aceptada"
    And se habilita el formulario de revisi√≥n`},

{ tag:"@declinacion", feature:"Ciclo de revisi√≥n por pares", text:`@declinacion
Scenario: Revisor declina por conflicto sobrevenido
  Given el Revisor "r3" fue invitado a revisar el Env√≠o "E-1"
  When "r3" declara conflicto y declina la invitaci√≥n
  Then su asignaci√≥n pasa a "Declinada"
  And se notifica al Editor para reasignaci√≥n`},

{ tag:"@entrega", feature:"Ciclo de revisi√≥n por pares", text:`@entrega
Scenario: Entrega de revisi√≥n con recomendaci√≥n
  Given el Revisor "r3" tiene asignaci√≥n "Aceptada" sobre "E-1"
  When env√≠a su revisi√≥n con recomendaci√≥n "Mayor revisi√≥n"
  Then la revisi√≥n queda registrada con sello de tiempo y versi√≥n
  And el historial del Env√≠o "E-1" muestra la revisi√≥n de "r3"`},

{ tag:"@historial", feature:"Ciclo de revisi√≥n por pares", text:`@historial
Scenario: Consulta del historial completo de revisiones por art√≠culo
  Given existen revisiones de "r1", "r3" y "r4" para el Env√≠o "E-1"
  When consulto el historial de revisiones de "E-1"
  Then veo todas las revisiones con autores an√≥nimos, fechas y recomendaciones`},

{ tag:"@decision", feature:"Decisi√≥n editorial y comunicaciones", text:`Feature: Decisi√≥n editorial y comunicaciones
  Como Editor
  Quiero emitir decisiones y cartas
  Para cerrar el proceso conforme a reglas

  @decision
  Scenario: Emisi√≥n de decisi√≥n basada en reglas y quorum
    Given el Env√≠o "E-1" tiene 3 revisiones con recomendaciones ["Aceptaci√≥n", "Mayor revisi√≥n", "Aceptaci√≥n"]
    And las reglas exigen minRevisiones=3, quorum="2 de 3", umbral=">=Aceptaci√≥n"
    When calculo la decisi√≥n editorial para "E-1"
    Then la decisi√≥n es "Aceptado condicional"
    And se genera carta de decisi√≥n con condiciones y plantilla aprobada`},

{ tag:"@aceptacion-final", feature:"Decisi√≥n editorial y comunicaciones", text:`@aceptacion-final
Scenario: Emisi√≥n de certificado tras aceptaci√≥n final
  Given el Env√≠o "E-1" est√° en estado "Aceptado"
  And el Autor subi√≥ la versi√≥n final y transfiri√≥ copyright
  When cierro el expediente editorial
  Then se emite certificado de aceptaci√≥n para el Autor
  And se programa la publicaci√≥n con fecha estimada`},

{ tag:"@metricas-autor", feature:"Gesti√≥n de m√©tricas e informes", text:`Feature: Gesti√≥n de m√©tricas e informes
  Como Analista
  Quiero generar m√©tricas y exportarlas
  Para seguimiento por autor, art√≠culo, evento y revista

  @metricas-autor
  Scenario: M√©tricas por autor y evento
    Given existen env√≠os y decisiones hist√≥ricas
    When genero m√©tricas para el Autor "Ana" en el Evento "IC-2026"
    Then obtengo m√©tricas {envios:2, aceptados:1, tasaAceptacion:"50%"} con periodo consultado`},

{ tag:"@metricas-revista", feature:"Gesti√≥n de m√©tricas e informes", text:`@metricas-revista
Scenario: M√©tricas por revista
  Given existen decisiones en la Revista "SJ-ML" durante 2026
  When genero el informe de tasa de aceptaci√≥n mensual para "SJ-ML"
  Then obtengo una serie temporal con aceptaci√≥n, tiempos de revisi√≥n y desviaci√≥n est√°ndar`},

{ tag:"@export", feature:"Gesti√≥n de m√©tricas e informes", text:`@export
Scenario Outline: Exportaci√≥n de reportes a formatos est√°ndar
  Given existe un reporte consolidado "R-1"
  When exporto el reporte "R-1" en formato "<formato>"
  Then descargo un archivo con extensi√≥n "<extension>" y esquema v√°lido

  Examples:
    | formato | extension |
    | CSV     | .csv      |
    | JSON-LD | .jsonld   |
    | XML     | .xml      |`},

{ tag:"@boletin", feature:"Gesti√≥n de m√©tricas e informes", text:`@boletin
Scenario: Env√≠o de notificaci√≥n mensual personalizada
  Given el Autor "Ana" est√° suscripto al resumen mensual
  And existen m√©tricas del √∫ltimo mes para "Ana"
  When corre el job mensual
  Then se env√≠a un email a "Ana" con su resumen y enlaces a detalles`},

{ tag:"@orcid", feature:"Integraciones externas y validaci√≥n de metadatos", text:`Feature: Integraciones externas y validaci√≥n de metadatos
  Como Sistema
  Quiero sincronizar perfiles y validar metadatos
  Para mantener calidad e interoperabilidad

  @orcid
  Scenario: Sincronizaci√≥n de datos de perfil desde ORCID
    Given el perfil "Ana" tiene ORCID vinculado
    And existen cambios en ORCID para nombre y afiliaci√≥n
    When sincronizo datos desde ORCID
    Then el perfil se actualiza preservando cambios locales confirmados
    And se registra la fuente y fecha de sincronizaci√≥n`},

{ tag:"@scopus-scholar", feature:"Integraciones externas y validaci√≥n de metadatos", text:`@scopus-scholar
Scenario: Importaci√≥n de publicaciones desde Scopus y Google Scholar
  Given el perfil "Ana" tiene identificadores v√°lidos en Scopus y Google Scholar
  When importo sus publicaciones recientes
  Then las nuevas publicaciones se agregan como referencias con deduplicaci√≥n por DOI`},

{ tag:"@doi", feature:"Integraciones externas y validaci√≥n de metadatos", text:`@doi
Scenario: Validaci√≥n de DOI y metadatos al registrar versi√≥n final
  Given el Env√≠o "E-1" est√° en versi√≥n final con DOI "10.1000/xyz123"
  And los metadatos requeridos son {titulo, autores, afiliaciones, resumen, palabrasClave}
  When valido el DOI y los metadatos
  Then el DOI queda marcado "V√°lido" y los metadatos "Completos"
  And el registro queda listo para indexaci√≥n`}
];

/* ---------- UI helpers ---------- */
const tabs = [
  {id:"intro", label:"Resumen"},
  {id:"marco", label:"Marco BDMA"},
  {id:"requisitos", label:"Requisitos"},
  {id:"bdd", label:"Escenarios BDD"},
  {id:"fase1", label:"Fase 1"},
  {id:"fase2", label:"Fase 2"},
  {id:"fase3", label:"Fase 3"},
  {id:"fase4", label:"Fase 4"},
  {id:"fase5", label:"Fase 5"}
];

function mountTabs(){
  const nav = document.getElementById('tabs');
  tabs.forEach(t => {
    const b=document.createElement('button'); b.textContent=t.label;
    b.onclick=()=>activate(t.id);
    if(t.id==='intro') b.classList.add('active');
    nav.appendChild(b);
  });
}

function activate(id){
  document.querySelectorAll('nav button').forEach(b => b.classList.toggle('active', b.textContent===tabs.find(t=>t.id===id).label));
  document.querySelectorAll('main section').forEach(s => s.classList.toggle('active', s.id===id));
  if(id==='fase3') setTimeout(drawEdges, 0);
}

function makeControls(onSearch){
  const div = document.createElement('div'); div.className='controls';
  const left = document.createElement('div'); left.className='search';
  const input=document.createElement('input'); input.placeholder='Buscar‚Ä¶'; input.oninput=(e)=>onSearch(e.target.value.trim().toLowerCase());
  left.append('üîé', input);
  const right = document.createElement('div');
  const btn=document.createElement('button'); btn.className='btn'; btn.textContent='Imprimir / PDF'; btn.onclick=()=>print();
  right.append(btn);
  div.append(left,right);
  return div;
}

function renderMarco(){
  const sec=document.getElementById('marco'); sec.innerHTML='';
  
  // Prop√≥sito y principios
  const grid1=document.createElement('div'); grid1.className='grid';
  
  const proposito=document.createElement('div'); proposito.className='card';
  proposito.innerHTML=`
    <h3>Prop√≥sito del Marco BDMA</h3>
    <p class="muted">Proveer un marco metodol√≥gico sistem√°tico y reproducible que gu√≠e la identificaci√≥n, dise√±o y evoluci√≥n de arquitecturas de microservicios en contextos √°giles greenfield, a partir de la transformaci√≥n iterativa y trazable de escenarios funcionales BDD en bounded contexts, contratos de servicio e interfaces verificables.</p>
    <p class="muted">BDMA integra principios de Domain-Driven Design (DDD), t√©cnicas de Behavior-Driven Development (BDD) y pr√°cticas de arquitectura evolutiva, con el objetivo de alinear continuamente la especificaci√≥n funcional del sistema con su arquitectura t√©cnica.</p>
  `;
  
  const principios=document.createElement('div'); principios.className='card';
  principios.innerHTML=`
    <h3>Principios Fundamentales</h3>
    <ul class="muted">
      <li><strong>Trazabilidad total:</strong> Cada servicio implementado debe poder rastrearse hasta uno o m√°s escenarios BDD.</li>
      <li><strong>Arquitectura emergente y evolutiva:</strong> El dise√±o se adapta iterativamente a la evoluci√≥n de los escenarios.</li>
      <li><strong>Dise√±o colaborativo:</strong> Las decisiones arquitect√≥nicas se validan con expertos de dominio y t√©cnicos.</li>
      <li><strong>Lenguaje ubicuo:</strong> El vocabulario de los escenarios permea contratos y artefactos de dise√±o.</li>
      <li><strong>Evidencia funcional continua:</strong> Las pruebas BDD son la validaci√≥n activa de la arquitectura.</li>
    </ul>
  `;
  
  grid1.append(proposito, principios);
  sec.appendChild(grid1);
  
  // Diferencial metodol√≥gico
  const diferencial=document.createElement('div'); diferencial.className='card';
  diferencial.innerHTML=`
    <h3>Aporte: Diferencial Metodol√≥gico</h3>
    <p class="muted">BDMA es un m√©todo iterativo que transforma requisitos funcionales en decisiones arquitect√≥nicas verificables. A diferencia de enfoques previos, que suelen ser te√≥ricos o centrados en contextos brownfield, BDMA:</p>
    <div class="kpi">
      <span class="pill">Define artefactos intermedios claros</span>
      <span class="pill">Establece un flujo de fases aplicable en entornos √°giles reales</span>
      <span class="pill">Garantiza trazabilidad y validaci√≥n continua</span>
      <span class="pill">Enfoque greenfield orientado a la pr√°ctica</span>
    </div>
    <div class="info">El marco no genera los escenarios BDD, sino que parte de un backlog funcional ya redactado y validado.</div>
  `;
  sec.appendChild(diferencial);
  
  // Proceso por fases
  const proceso=document.createElement('div'); proceso.className='card';
  proceso.innerHTML=`
    <h3>Proceso Estructurado en 5 Fases</h3>
    <table style="margin-top: 12px;">
      <thead>
        <tr><th>Fase</th><th>Concepto</th><th>Objetivo</th></tr>
      </thead>
      <tbody>
        <tr>
          <td><strong>Fase 1</strong><br>Clasificaci√≥n funcional</td>
          <td>Arquitectura evolutiva alineada a features/epics</td>
          <td>Organizar escenarios BDD en agrupaciones coherentes</td>
        </tr>
        <tr>
          <td><strong>Fase 2</strong><br>Extracci√≥n de dominio</td>
          <td>BDD para describir comportamiento y extraer elementos</td>
          <td>Identificar actores, comandos, eventos y entidades</td>
        </tr>
        <tr>
          <td><strong>Fase 3</strong><br>Bounded contexts</td>
          <td>Context Map, delimitaci√≥n DDD</td>
          <td>Agrupar elementos en contextos coherentes y delimitados</td>
        </tr>
        <tr>
          <td><strong>Fase 4</strong><br>Contratos API</td>
          <td>Dise√±o contract-first y patrones de testabilidad</td>
          <td>Traducir comandos/eventos en contratos verificables</td>
        </tr>
        <tr>
          <td><strong>Fase 5</strong><br>Validaci√≥n continua</td>
          <td>ADR y evoluci√≥n estructural</td>
          <td>Garantizar evoluci√≥n sincronizada y trazabilidad</td>
        </tr>
      </tbody>
    </table>
  `;
  sec.appendChild(proceso);
  
  // Integraci√≥n √°gil
  const agil=document.createElement('div'); agil.className='card';
  agil.innerHTML=`
    <h3>Integraci√≥n con Ciclo √Ågil</h3>
    <p class="muted">BDMA no propone un enfoque secuencial cerrado, sino un marco que se integra incrementalmente al ciclo de vida √°gil. En cada iteraci√≥n (Sprint), se aplican las fases √∫nicamente sobre los escenarios funcionales priorizados.</p>
    <table style="margin-top: 12px;">
      <thead>
        <tr><th>Etapa del Sprint</th><th>Fase BDMA</th><th>Actividad</th></tr>
      </thead>
      <tbody>
        <tr><td>Refinamiento del backlog</td><td>Fase 1</td><td>Agrupar nuevos escenarios BDD por feature/epic</td></tr>
        <tr><td>Inicio del Sprint</td><td>Fase 2</td><td>Analizar escenarios priorizados, identificar comandos/eventos</td></tr>
        <tr><td>Dise√±o t√©cnico inicial</td><td>Fase 3</td><td>Ajustar l√≠mites de contextos si hay cambios relevantes</td></tr>
        <tr><td>Implementaci√≥n</td><td>Fase 4</td><td>Derivar contratos desde nuevos escenarios</td></tr>
        <tr><td>Durante el Sprint</td><td>Fase 5</td><td>Ejecutar pruebas BDD, detectar impactos, registrar ADRs</td></tr>
        <tr><td>Cierre/Revisi√≥n</td><td>Consolidaci√≥n</td><td>Validar arquitectura, versionar Context Map</td></tr>
      </tbody>
    </table>
  `;
  sec.appendChild(agil);
}

function renderRequisitos(){
  const sec=document.getElementById('requisitos'); sec.innerHTML='';
  const grid=document.createElement('div'); grid.className='grid';

  const c1=document.createElement('div'); c1.className='card span6';
  c1.innerHTML=`<h3>Requisitos funcionales</h3>
    <p class="muted">${requisitos.contexto}</p>
    <ul class="muted">${requisitos.funcionales.map(x=>`<li>${x}</li>`).join('')}</ul>`;

  const c2=document.createElement('div'); c2.className='card span6';
  c2.innerHTML=`<h3>Requisitos no funcionales</h3>
    <ul class="muted">${requisitos.noFunc.map(x=>`<li>${x}</li>`).join('')}</ul>`;

  grid.append(c1,c2);
  sec.appendChild(grid);
}

function renderBDD(){
  const sec=document.getElementById('bdd'); sec.innerHTML='';
  const title=document.createElement('div'); title.className='card';
  title.innerHTML='<h3>Escenarios clave (Gherkin)</h3><p class="muted">Fragmentos listos para copiar y pegar en suites de pruebas BDD.</p>';
  sec.appendChild(title);

  bddBlocks.forEach(b=>{
    const c=document.createElement('div'); c.className='card';
    const bar=document.createElement('div'); bar.className='codebar';
    bar.innerHTML=`<div><span class="tag">${b.feature}</span> <span class="tag">${b.tag}</span></div>`;
    const copy=document.createElement('button'); copy.className='btn'; copy.textContent='Copiar';
    copy.onclick=()=>navigator.clipboard.writeText(b.text);
    bar.appendChild(copy);
    c.appendChild(bar);
    const pre=document.createElement('pre'); pre.innerHTML=`<code>${escapeHtml(b.text)}</code>`;
    c.appendChild(pre);
    sec.appendChild(c);
  });
}

function renderFase1(){
  const sec=document.getElementById('fase1'); sec.innerHTML='';
  const card=document.createElement('div'); card.className='card';
  card.innerHTML='<h3>Fase 1 ¬∑ Grupos funcionales ‚Üí candidatos a bounded contexts</h3>';
  const controls = makeControls(filter);
  const table=document.createElement('table');
  table.innerHTML=`<thead><tr><th>ID</th><th>Nombre</th><th>Prop√≥sito</th><th>Escenarios</th></tr></thead><tbody></tbody>`;
  const tbody=table.querySelector('tbody');
  gruposF1.forEach(g=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${g.id}</td><td>${g.nombre}</td><td>${g.proposito}</td><td>${g.escenarios.join(', ')}</td>`;
    tbody.appendChild(tr);
  });
  function filter(q){ [...tbody.children].forEach(tr=>{
    tr.style.display = tr.textContent.toLowerCase().includes(q) ? '' : 'none';
  });}
  card.append(controls, table);
  sec.appendChild(card);
}

function renderFase2(){
  const sec=document.getElementById('fase2'); sec.innerHTML='';
  const card=document.createElement('div'); card.className='card';
  card.innerHTML='<h3>Fase 2 ¬∑ Comandos y eventos por contexto</h3>';
  const controls = makeControls(filter);
  const table=document.createElement('table');
  table.innerHTML=`<thead><tr><th>Contexto funcional</th><th>Comandos (When)</th><th>Eventos (Then)</th></tr></thead><tbody></tbody>`;
  const tbody=table.querySelector('tbody');
  fase2ComEv.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.ctx}</td><td>${r.comandos.join(', ')}</td><td>${r.eventos.join(', ')}</td>`;
    tbody.appendChild(tr);
  });
  function filter(q){ [...tbody.children].forEach(tr=>tr.style.display = tr.textContent.toLowerCase().includes(q) ? '' : 'none'); }
  card.append(controls, table);
  sec.appendChild(card);
}

function renderFase3(){
  const sec=document.getElementById('fase3'); sec.innerHTML='';
  const grid=document.createElement('div'); grid.className='grid';

  const left=document.createElement('div'); left.className='card span6';
  left.innerHTML='<h3>Fase 3 ¬∑ Bounded contexts</h3>';
  const table=document.createElement('table'); table.innerHTML='<thead><tr><th>ID</th><th>Responsabilidad</th></tr></thead><tbody></tbody>';
  const tbody=table.querySelector('tbody');
  bc.forEach(x=>{
    const tr=document.createElement('tr'); tr.innerHTML=`<td><strong>${x.id}</strong> ¬∑ ${x.name}</td><td>${x.resp}</td>`; tbody.appendChild(tr);
  });
  left.appendChild(table);

  const right=document.createElement('div'); right.className='card span6';
  right.innerHTML='<h3>Context map (interacciones)</h3><div id="mapWrap"><svg id="mapSvg"></svg></div>';
  const legend=document.createElement('p'); legend.className='muted';
  legend.innerHTML='L√≠neas curvas indican dependencias/eventos. Se listan interacciones clave debajo.';
  right.appendChild(legend);
  const list=document.createElement('div'); list.className='muted'; list.style.marginTop='8px';
  list.innerHTML = interactions.map(e=>`‚Ä¢ <strong>${e.from}</strong> ‚Üí <strong>${e.to}</strong> <em>(${e.type})</em> ‚Äî ${e.note}`).join('<br/>');
  right.appendChild(list);

  grid.append(left,right);
  sec.appendChild(grid);

  // mount boxes after render
  setTimeout(()=>{
    const wrap=document.getElementById('mapWrap');
    const cols=3, rowH=170, colW=280, ox=10, oy=10;
    bc.forEach((x,i)=>{
      const box=document.createElement('div'); box.className='ctx'; box.id=x.id;
      const r=Math.floor(i/cols), c=i%cols;
      box.style.left = (ox + c*colW) + 'px';
      box.style.top  = (oy + r*rowH) + 'px';
      box.innerHTML = `<h4>${x.id} ¬∑ ${x.name}</h4><p>${x.resp}</p>`;
      wrap.appendChild(box);
    });
    drawEdges();
  }, 0);
}

function drawEdges(){
  const svg=document.getElementById('mapSvg'); const wrap=svg.parentElement;
  const boxes=[...wrap.querySelectorAll('.ctx')];
  const bb=wrap.getBoundingClientRect();
  svg.setAttribute('width', wrap.clientWidth); svg.setAttribute('height', wrap.clientHeight);
  svg.innerHTML = `
    <defs>
      <marker id="arrow" markerWidth="10" markerHeight="8" refX="8" refY="4" orient="auto">
        <polygon points="0 0, 10 4, 0 8" fill="#64b5f6"></polygon>
      </marker>
    </defs>
  `;
  function center(el){
    const r=el.getBoundingClientRect();
    return { x: (r.left - bb.left) + r.width/2, y: (r.top - bb.top) + r.height/2 };
  }
  function edge(fromId,toId){
    const f=document.getElementById(fromId), t=document.getElementById(toId);
    if(!f||!t) return;
    const a=center(f), b=center(t);
    const path=document.createElementNS('http://www.w3.org/2000/svg','path');
    const dx=b.x-a.x, dy=b.y-a.y, cx1=a.x+dx*0.35, cy1=a.y, cx2=b.x-dx*0.35, cy2=b.y;
    path.setAttribute('d', `M${a.x},${a.y} C ${cx1},${cy1} ${cx2},${cy2} ${b.x},${b.y}`);
    path.setAttribute('class','edge'); svg.appendChild(path);
  }
  interactions.forEach(e=>edge(e.from, e.to));
}

function renderFase4(){
  const sec=document.getElementById('fase4'); sec.innerHTML='';
  const card=document.createElement('div'); card.className='card';
  card.innerHTML='<h3>Fase 4 ¬∑ Contratos API (contract-first)</h3>';
  const controls = makeControls(filter);
  const table=document.createElement('table');
  table.innerHTML=`<thead><tr><th>G</th><th>Contexto</th><th>M√©todo</th><th>Endpoint</th><th>Request (claves)</th><th>Response (claves)</th><th>C√≥digos</th><th>Escenario</th></tr></thead><tbody></tbody>`;
  const tbody=table.querySelector('tbody');
  endpoints.forEach(e=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${e.g}</td><td>${e.ctx}</td><td><strong>${e.method}</strong></td><td><code>${e.path}</code></td><td>${e.req}</td><td>${e.res}</td><td>${e.codes}</td><td>${e.escenario}</td>`;
    tbody.appendChild(tr);
  });
  function filter(q){ [...tbody.children].forEach(tr=>tr.style.display = tr.textContent.toLowerCase().includes(q) ? '' : 'none'); }
  card.append(controls, table);
  sec.appendChild(card);
}

function renderFase5(){
  const sec=document.getElementById('fase5'); sec.innerHTML='';
  const grid=document.createElement('div'); grid.className='grid';

  const c1=document.createElement('div'); c1.className='card span6';
  c1.innerHTML='<h3>Fase 5 ¬∑ ADR</h3>';
  const ul=document.createElement('ul'); ul.className='muted';
  adrLog.forEach(a=>{
    const li=document.createElement('li'); li.innerHTML = `<strong>${a.id}</strong> (${a.estado} ¬∑ ${a.fecha}) ‚Äî ${a.texto}`; ul.appendChild(li);
  });
  c1.appendChild(ul);

  const c2=document.createElement('div'); c2.className='card span6';
  c2.innerHTML='<h3>Trazabilidad evolutiva (Escenario ‚Üí Comando ‚Üí Evento ‚Üí Endpoint ‚Üí ADR)</h3>';
  const controls = makeControls(filter);
  const table=document.createElement('table');
  table.innerHTML='<thead><tr><th>Escenario</th><th>BC</th><th>Comando</th><th>Evento</th><th>Contrato</th><th>ADR</th></tr></thead><tbody></tbody>';
  const tbody=table.querySelector('tbody');
  trazabilidad.forEach(r=>{
    const tr=document.createElement('tr'); tr.innerHTML = r.map(x=>`<td>${x}</td>`).join(''); tbody.appendChild(tr);
  });
  function filter(q){ [...tbody.children].forEach(tr=>tr.style.display = tr.textContent.toLowerCase().includes(q) ? '' : 'none'); }
  c2.append(controls, table);

  grid.append(c1,c2);
  sec.appendChild(grid);
}

/* ---------- Render all ---------- */
function escapeHtml(s){ return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'\"'":'&#39;'}[m])); }
function init(){
  mountTabs();
  renderMarco();
  renderRequisitos();
  renderBDD();
  renderFase1();
  renderFase2();
  renderFase3();
  renderFase4();
  renderFase5();
  window.addEventListener('resize', ()=>{ if(document.getElementById('fase3').classList.contains('active')) drawEdges(); });
}
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
