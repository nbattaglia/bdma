<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BDMA – Iteración 1 · Sitio de soporte a la evaluación</title>
<style>
  :root{
    --bg:#0b0c10;
    --panel:#0e1117;
    --muted:#a3a3a3;
    --text:#f1f5f9;
    --brand:#60a5fa;
    --accent:#34d399;
    --warn:#fbbf24;
    --danger:#f87171;
    --card:#0f172a;
    --code:#0b1220;
    --link:#93c5fd;
    --border:#1f2937;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font: 15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
    color:var(--text);
    background:linear-gradient(180deg, #0b1020, #0b0c10 30% 100%);
  }
  header{
    position:sticky; top:0; z-index:5;
    background:rgba(10,14,24,.85); backdrop-filter: blur(8px);
    border-bottom:1px solid var(--border);
  }
  .wrap{max-width:1160px; margin:0 auto; padding:16px}
  .title{display:flex; align-items:flex-start; justify-content:space-between; gap:16px; flex-wrap:wrap}
  .title h1{font-size:22px; margin:0}
  .lead{margin:6px 0 0 0; color:#cbd5e1}
  nav{display:flex; gap:10px; margin-top:12px; flex-wrap:wrap}
  nav button{
    background:#0c1220; color:#dbe6ff; border:1px solid var(--border); border-radius:10px;
    padding:8px 12px; cursor:pointer; transition:.2s;
  }
  nav button.active{border-color:#2b66ff; box-shadow: 0 0 0 2px rgba(43,102,255,.25) inset}
  main{padding:24px 0}
  section{display:none}
  section.active{display:block; animation:fade .2s ease}
  @keyframes fade{from{opacity:.6; transform:translateY(4px)} to{opacity:1; transform:none}}

  /* layout */
  .grid{display:grid; grid-template-columns:repeat(12,1fr); gap:14px}
  .card{grid-column: span 12; background:linear-gradient(180deg,#0f172a,#0b1220 40% 100%);
        border:1px solid var(--border); border-radius:16px; padding:16px}
  .card h3{margin:0 0 8px 0; font-size:18px}
  .muted{color:var(--muted)}
  .kpi{display:flex; gap:12px; flex-wrap:wrap}
  .kpi .pill{background:#0b1220; border:1px solid var(--border); border-radius:999px; padding:4px 10px; color:#cbd5e1}
  .info{border-left:3px solid var(--brand); padding:8px 12px; background:#0b1220; color:#c7d2fe; border-radius:8px}

  table{width:100%; border-collapse:collapse; background:#0b1220; border:1px solid var(--border); border-radius:12px; overflow:hidden}
  th,td{padding:10px 12px; border-bottom:1px solid var(--border); vertical-align:top}
  th{background:#0f172a; text-align:left; color:#cbd5e1; position:sticky; top:0; z-index:1}
  tr:hover td{background:#0e1528}
  .controls{display:flex; gap:10px; justify-content:space-between; align-items:center; margin:8px 0 14px}
  .search{display:flex; gap:8px; align-items:center}
  .search input{background:#0b1220; color:#e2e8f0; border:1px solid var(--border); border-radius:10px; padding:8px 10px; width:280px}
  .btn{appearance:none; background:#0c1220; color:#e5edff; border:1px solid var(--border); border-radius:10px; padding:8px 12px; cursor:pointer}
  .btn:hover{border-color:#2b66ff}
  a{color:var(--link); text-decoration:none}
  a:hover{text-decoration:underline}

  pre{background:var(--code); border:1px solid var(--border); color:#e2e8f0; border-radius:12px; padding:12px; overflow:auto}
  code{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,monospace; font-size:13px}
  .codebar{display:flex; justify-content:space-between; align-items:center; gap:8px; margin:6px 0}
  .tag{font-size:12px; color:#a3bffa; background:#0b1220; border:1px solid var(--border); border-radius:999px; padding:2px 8px}

  /* Context map */
  #mapWrap{position:relative; background:#0b1220; border:1px solid var(--border); border-radius:16px; padding:12px; min-height:500px}
  #mapSvg{position:absolute; inset:0; pointer-events:none}
  .ctx{position:absolute; width:240px; min-height:72px; background:#0f172a; border:1px solid var(--border); border-radius:12px; padding:10px}
  .ctx h4{margin:0 0 6px 0; font-size:15px; color:#e5e7eb}
  .ctx p{margin:0; color:#a1a1aa; font-size:13px}
  .edge{stroke:#64b5f6; stroke-width:2; marker-end:url(#arrow)}

  /* Responsive */
  @media (min-width:860px){
    .card.span6{grid-column: span 6}
  }
  @media print{
    header, nav, .controls{display:none !important}
    body{background:white; color:black}
    .card, table, pre{border-color:#ddd}
    a{color:black; text-decoration:none}
  }

  footer{padding:28px 16px; border-top:1px solid var(--border); color:#98a2b3}
</style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="title">
        <div>
          <h1>BDMA – Iteración 1 · Sitio de soporte a la evaluación</h1>
          <p class="lead">Recolección curada de artefactos: requisitos, escenarios BDD, derivaciones de Fase 1 a 5, contratos API y trazabilidad integral.</p>
        </div>
        <div class="kpi">
          <span class="pill">8 bounded contexts</span>
          <span class="pill">25+ endpoints</span>
          <span class="pill">Gherkin listo para copiar</span>
          <span class="pill">Context map interactivo</span>
        </div>
      </div>
      <nav id="tabs"></nav>
    </div>
  </header>

  <main class="wrap">
    <!-- RESUMEN -->
    <section id="intro" class="active">
      <div class="grid">
        <div class="card">
          <h3>Propósito</h3>
          <p class="muted">Este sitio acompaña la evaluación del artículo sobre <strong>BDMA (Behavior-Driven Microservice Architecture)</strong>, un marco metodológico sistemático y reproducible que guía la identificación, diseño y evolución de arquitecturas de microservicios en contextos ágiles greenfield.</p>
          <p class="muted">BDMA transforma escenarios funcionales BDD en bounded contexts, contratos de servicio e interfaces verificables, integrando principios de Domain-Driven Design (DDD), técnicas de Behavior-Driven Development (BDD) y prácticas de arquitectura evolutiva.</p>
          <div class="info">Se exponen artefactos trazables que evidencian cómo los escenarios BDD conducen, paso a paso, a decisiones arquitectónicas verificables aplicadas a una plataforma de publicaciones científicas.</div>
        </div>

        <div class="card span6">
          <h3>Cómo navegar</h3>
          <ol class="muted">
            <li>Usar las pestañas superiores para acceder a cada fase y artefacto.</li>
            <li>Filtrar tablas con el cuadro de <em>Buscar…</em>.</li>
            <li>Copiar fragmentos Gherkin mediante el botón <em>Copiar</em>.</li>
            <li>Utilizar <em>Imprimir</em> para exportar secciones a PDF.</li>
          </ol>
        </div>

        <div class="card span6">
          <h3>Alcance</h3>
          <p class="muted">Primera iteración: desde requisitos y escenarios clave hasta contratos contract‑first y bitácora ADR inicial. Las decisiones se establecen con una granularidad adecuada para su verificación empírica.</p>
        </div>
      </div>
    </section>

    <!-- MARCO BDMA -->
    <section id="marco"></section>

    <!-- REQUISITOS -->
    <section id="requisitos"></section>

    <!-- BDD -->
    <section id="bdd"></section>

    <!-- FASE 1 -->
    <section id="fase1"></section>

    <!-- FASE 2 -->
    <section id="fase2"></section>

    <!-- FASE 3 -->
    <section id="fase3"></section>

    <!-- FASE 4 -->
    <section id="fase4"></section>

    <!-- FASE 5 -->
    <section id="fase5"></section>
  </main>

  <footer class="wrap">
    <small>BDMA – Sitio de soporte para evaluación. Versión de demostración estática.</small>
  </footer>

<script>
/* ---------- Data (curada a partir de la Iteración 1) ---------- */
const requisitos = {
  contexto: "Una organización académica internacional quiere desarrollar una plataforma distribuida para la gestión integral de publicaciones científicas en revistas y congresos, abierta a investigadores de todo el mundo. La plataforma debe permitir a autores, revisores, editores y organizadores de eventos interactuar de manera asincrónica y conforme a reglas definidas por políticas editoriales dinámicas, garantizando escalabilidad y evolución controlada.",
  noFunc: [
    "Trazabilidad: escenarios ↔ comandos ↔ eventos ↔ contratos ↔ ADR",
    "Auditabilidad de acciones críticas (login, decisiones, emisiones)",
    "Evolución controlada de políticas y reglas editoriales",
    "Integración segura con proveedores externos (ORCID, Scholar/Scopus, DOI)",
    "Escalabilidad del sistema para equipos distribuidos",
    "Estabilidad general ante cambios en reglas editoriales"
  ],
  funcionales: [
    "Registro y autenticación de investigadores",
    "Perfiles con afiliación institucional, ORCID, áreas de interés y métricas de impacto",
    "Envío de artículos a congresos o revistas científicas",
    "Versionado de envíos y control de fechas límite",
    "Registro de revisores con especialidades",
    "Asignación automática y manual de revisores; revisión ciega simple o doble",
    "Historial de revisiones por artículo",
    "Alta de revistas y eventos; configuración de reglas editoriales versionadas",
    "Administración de editores y comités científicos",
    "Emisión de cartas de aceptación y certificados automáticos",
    "Generación de métricas por autor, artículo, evento y revista",
    "Exportación a formatos estándar (CSV, JSON-LD, XML)",
    "Notificaciones automáticas con resumen mensual personalizado",
    "Sincronización con ORCID, Scopus y Google Scholar",
    "Validación de DOI y metadatos para cada publicación"
  ]
};

const gruposF1 = [
  {id:"G01", nombre:"Identity & Access", proposito:"Alta y autenticación; control de acceso/bloqueo", escenarios:["registro-exitoso","autenticacion-ok","autenticacion-falla","bloqueo"]},
  {id:"G02", nombre:"Profiles", proposito:"Perfil, afiliación, áreas y métricas de impacto", escenarios:["perfil-basico","sincronizacion-metricas"]},
  {id:"G03", nombre:"Submissions", proposito:"Ciclo de vida de envíos y versionado; deadlines", escenarios:["envio-evento","envio-revista","deadline","versionado"]},
  {id:"G04", nombre:"Reviewing", proposito:"Revisores, conflictos, asignación e informes", escenarios:["alta-revisor","conflictos","auto-assign","manual-assign","ceguera-simple","aceptacion","declinacion","entrega","historial"]},
  {id:"G05", nombre:"Editorial Decisioning", proposito:"Cálculo de decisión, cierre y certificados", escenarios:["decision","aceptacion-final"]},
  {id:"G06", nombre:"Venue Management", proposito:"Revistas/eventos, reglas versionadas y roles", escenarios:["alta-revista","alta-evento","versionado-reglas","roles-editoriales"]},
  {id:"G07", nombre:"Metrics & Reporting", proposito:"KPIs, exportaciones y boletines", escenarios:["metricas-autor","metricas-revista","export","boletin"]},
  {id:"G08", nombre:"External Integrations", proposito:"ORCID/Scopus/Scholar y validación de DOI", escenarios:["orcid","scopus-scholar","doi"]}
];

const fase2ComEv = [
  {ctx:"G01 Identity & Access", comandos:["RegistrarCuenta","Autenticar","RegistrarIntentoFallido","BloquearCuenta"], eventos:["CuentaActivada","SesionIniciada","AccesoDenegado","CuentaBloqueada"]},
  {ctx:"G02 Profiles", comandos:["ActualizarPerfil","SincronizarMetricas"], eventos:["PerfilActualizado","MetricasSincronizadas"]},
  {ctx:"G03 Submissions", comandos:["RegistrarEnvioEvento","RegistrarEnvioRevista","ValidarDeadline/IntentarRegistrarEnvio","AdjuntarVersion"], eventos:["EnvioRegistrado","EnvioRechazadoPorDeadline","VersionAdjuntada"]},
  {ctx:"G04 Reviewing", comandos:["RegistrarRevisor","DeclararConflicto","AsignarRevisoresAutomaticamente","AsignarRevisorManual","ConfigurarCeguera","AceptarInvitacion","DeclinarInvitacion","RegistrarRevision","ConsultarHistorial"], eventos:["RevisorRegistrado","ConflictoRegistrado","RevisoresAsignados","RevisorAsignadoManual","InvitacionAceptada","InvitacionDeclinada","RevisionRegistrada"]},
  {ctx:"G05 Editorial Decisioning", comandos:["CalcularDecisionEditorial","EmitirCertificado"], eventos:["DecisionEmitida","CertificadoEmitido","ExpedienteCerrado"]},
  {ctx:"G06 Venue Management", comandos:["CrearRevista","CrearEvento","PublicarReglas","AsignarRolesEditoriales"], eventos:["RevistaCreada","EventoCreado","ReglasPublicadas","RolesAsignados"]},
  {ctx:"G07 Metrics & Reporting", comandos:["GenerarMetricasAutor","GenerarMetricasRevista","ExportarDatos","EnviarBoletin"], eventos:["ReporteGenerado","ExportacionLista","BoletinEnviado"]},
  {ctx:"G08 External Integrations", comandos:["SincronizarORCID","ImportarDesdeScopusScholar","ValidarDOI","ValidarMetadatos"], eventos:["PerfilSincronizado","PublicacionesImportadas","DOIVerificado","MetadatosValidados"]},
];

const bc = [
  {id:"BC01", name:"Identity & Access", resp:"Gestión de identidad, autenticación y autorización"},
  {id:"BC02", name:"Profiles", resp:"Gestión de perfil, afiliación y métricas del investigador"},
  {id:"BC03", name:"Submissions", resp:"Registro y gestión de envíos a revistas o eventos"},
  {id:"BC04", name:"Reviewing", resp:"Gestión de revisores, conflictos, asignaciones y revisiones"},
  {id:"BC05", name:"Editorial Decisioning", resp:"Cálculo/registro de decisiones; cierre/ certificados"},
  {id:"BC06", name:"Venue Management", resp:"Alta de venues; publicación de reglas y roles"},
  {id:"BC07", name:"Metrics & Reporting", resp:"Generación de métricas, reportes y boletines"},
  {id:"BC08", name:"External Integrations", resp:"ORCID/Scholar/Scopus; validación DOI"}
];

const interactions = [
  {from:"BC03", to:"BC04", type:"Event Publisher / Partnership", note:"Al registrar envío"},
  {from:"BC03", to:"BC05", type:"Event Publisher / Partnership", note:"Dispara decisión"},
  {from:"BC04", to:"BC05", type:"Event Publisher", note:"Al cerrar revisiones"},
  {from:"BC05", to:"BC03", type:"Event Subscriber", note:"Marca aceptado/rechazado"},
  {from:"BC06", to:"BC03", type:"OHS + Event Publisher", note:"Reglas publicadas"},
  {from:"BC06", to:"BC04", type:"OHS + Event Publisher", note:"Reglas publicadas"},
  {from:"BC06", to:"BC05", type:"OHS + Event Publisher", note:"Reglas publicadas"},
  {from:"BC08", to:"BC02", type:"ACL", note:"Sync de perfil/métricas"},
  {from:"BC08", to:"BC03", type:"ACL", note:"Validación DOI/Metadatos"}
];

const endpoints = [
  {g:"G01", ctx:"Identity & Access", method:"POST", path:"/auth/register", req:"email, password, orcidId?", res:"userId, estadoCuenta", codes:"201; 400; 409", escenario:"registro-exitoso"},
  {g:"G01", ctx:"Identity & Access", method:"POST", path:"/auth/login", req:"email, password", res:"token, exp, userId", codes:"200; 401", escenario:"autenticacion-ok | autenticacion-falla"},
  {g:"G01", ctx:"Identity & Access", method:"POST", path:"/auth/lockouts/evaluate", req:"userId", res:"locked(bool), reason?", codes:"200; 423", escenario:"bloqueo"},

  {g:"G02", ctx:"Profiles", method:"PUT", path:"/profiles/{researcherId}", req:"nombre, afiliacion, areas[], orcidId?", res:"researcherId, actualizadoAt", codes:"200; 400; 404", escenario:"perfil-basico"},
  {g:"G02", ctx:"Profiles", method:"POST", path:"/profiles/{researcherId}/metrics/sync", req:"fuentes[]", res:"hIndex, citas, fuente, fecha", codes:"200; 424", escenario:"sincronizacion-metricas"},

  {g:"G03", ctx:"Submissions", method:"POST", path:"/venues/{venueId}/submissions", req:"titulo, autores[], archivos[], submittedAt", res:"submissionId, version=1, status", codes:"201; 422", escenario:"envio-evento | deadline"},
  {g:"G03", ctx:"Submissions", method:"POST", path:"/journals/{journalId}/submissions", req:"titulo, autores[], archivos[]", res:"submissionId, version=1, status", codes:"201", escenario:"envio-revista"},
  {g:"G03", ctx:"Submissions", method:"POST", path:"/submissions/{submissionId}/versions", req:"archivos[], notes?", res:"version++, estado", codes:"201; 409", escenario:"versionado"},

  {g:"G04", ctx:"Reviewing", method:"POST", path:"/reviewers", req:"nombre, especialidades[], afiliacion", res:"reviewerId", codes:"201; 400", escenario:"alta-revisor"},
  {g:"G04", ctx:"Reviewing", method:"POST", path:"/reviewers/{reviewerId}/conflicts", req:"submissionId, tipo, descripcion", res:"conflictId, registradoAt", codes:"201; 409", escenario:"conflictos"},
  {g:"G04", ctx:"Reviewing", method:"POST", path:"/submissions/{submissionId}/assignments:auto", req:"nMin, ceguera", res:"assignments[], blindPolicy", codes:"201; 409", escenario:"auto-assign / ceguera-simple"},
  {g:"G04", ctx:"Reviewing", method:"POST", path:"/submissions/{submissionId}/assignments", req:"reviewerId, ceguera?", res:"assignmentId, estado", codes:"201; 409", escenario:"manual-assign"},
  {g:"G04", ctx:"Reviewing", method:"POST", path:"/assignments/{assignmentId}/accept", req:"—", res:"assignmentId, estado=ACEPTADO", codes:"200; 409", escenario:"aceptacion"},
  {g:"G04", ctx:"Reviewing", method:"POST", path:"/assignments/{assignmentId}/decline", req:"motivo?", res:"assignmentId, estado=DECLINADO", codes:"200", escenario:"declinacion"},
  {g:"G04", ctx:"Reviewing", method:"POST", path:"/submissions/{submissionId}/reviews", req:"assignmentId, recomendacion, comentarios", res:"reviewId, registradaAt", codes:"201; 403", escenario:"entrega"},
  {g:"G04", ctx:"Reviewing", method:"GET",  path:"/submissions/{submissionId}/reviews", req:"estado?, reviewerId?", res:"listaReviews[]", codes:"200", escenario:"historial"},

  {g:"G05", ctx:"Editorial Decisioning", method:"POST", path:"/submissions/{submissionId}/decision", req:"decision, notas?", res:"decisionId, quorumOk", codes:"201; 409", escenario:"decision"},
  {g:"G05", ctx:"Editorial Decisioning", method:"POST", path:"/submissions/{submissionId}/acceptance-letter", req:"templateId?, locale?", res:"urlCarta, emitidaAt", codes:"200; 409", escenario:"aceptacion-final"},

  {g:"G06", ctx:"Venue Management", method:"POST", path:"/venues/journals", req:"nombre, scope, politicasIniciales", res:"journalId", codes:"201; 409", escenario:"alta-revista"},
  {g:"G06", ctx:"Venue Management", method:"POST", path:"/venues/conferences", req:"nombre, fechas{...}, politicasIniciales", res:"conferenceId", codes:"201; 409", escenario:"alta-evento"},
  {g:"G06", ctx:"Venue Management", method:"POST", path:"/venues/{venueId}/rulesets", req:"version, reglas{...}, vigencia", res:"rulesetId, version", codes:"201; 409", escenario:"versionado-reglas"},
  {g:"G06", ctx:"Venue Management", method:"POST", path:"/venues/{venueId}/roles", req:"usuarioId, rol", res:"roleId", codes:"201; 404", escenario:"roles-editoriales"},

  {g:"G08", ctx:"External Integrations", method:"POST", path:"/integrations/orcid/sync", req:"researcherId, accessToken", res:"perfil{orcidId,...}, sincronizadoAt", codes:"200; 424", escenario:"orcid"},
  {g:"G08", ctx:"External Integrations", method:"POST", path:"/integrations/scholar-scopus/sync", req:"researcherId", res:"metrics{hIndex,citas}, fuente", codes:"200; 424", escenario:"scopus-scholar"},
  {g:"G08", ctx:"External Integrations", method:"POST", path:"/integrations/doi/validate", req:"doi, metadatos", res:"valido(bool), issues[]", codes:"200; 422", escenario:"doi"}
];

const adrLog = [
  { id:"ADR-000", fecha:"2025-08-11", estado:"Aceptado", texto:"Adoptar la arquitectura resultante de BDMA Fases 1–4 como versión inicial (v1.0)." }
];

const trazabilidad = [
  ["registro-exitoso","BC01","RegistrarCuenta","CuentaActivada","POST /auth/register","ADR-000"],
  ["autenticacion-ok","BC01","Autenticar","SesionIniciada","POST /auth/login","ADR-000"],
  ["autenticacion-falla","BC01","Autenticar","AccesoDenegado","POST /auth/login","ADR-000"],
  ["bloqueo","BC01","BloquearCuenta","CuentaBloqueada","POST /auth/lockouts/evaluate","ADR-000"],
  ["perfil-basico","BC02","ActualizarPerfil","PerfilActualizado","PUT /profiles/{researcherId}","ADR-000"],
  ["sincronizacion-metricas","BC02","SincronizarMetricas","MetricasSincronizadas","POST /profiles/{id}/metrics/sync","ADR-000"],
  ["envio-evento","BC03","RegistrarEnvioEvento","EnvioRegistrado","POST /venues/{venueId}/submissions","ADR-000"],
  ["envio-revista","BC03","RegistrarEnvioRevista","EnvioRegistrado","POST /journals/{journalId}/submissions","ADR-000"],
  ["deadline","BC03","IntentarRegistrarEnvio","EnvioRechazadoPorDeadline","POST /venues/{venueId}/submissions","ADR-000"],
  ["versionado","BC03","AdjuntarVersion","VersionAdjuntada","POST /submissions/{id}/versions","ADR-000"],
  ["alta-revisor","BC04","RegistrarRevisor","RevisorRegistrado","POST /reviewers","ADR-000"],
  ["conflictos","BC04","DeclararConflicto","ConflictoRegistrado","POST /reviewers/{id}/conflicts","ADR-000"],
  ["auto-assign","BC04","AsignarRevisoresAutomaticamente","RevisoresAsignados","POST /submissions/{id}/assignments:auto","ADR-000"],
  ["manual-assign","BC04","AsignarRevisorManual","RevisorAsignadoManual","POST /submissions/{id}/assignments","ADR-000"],
  ["ceguera-simple","BC04","ConfigurarCeguera","(flag aplicado)","POST /submissions/{id}/assignments","ADR-000"],
  ["aceptacion","BC04","AceptarInvitacion","InvitacionAceptada","POST /assignments/{id}/accept","ADR-000"],
  ["declinacion","BC04","DeclinarInvitacion","InvitacionDeclinada","POST /assignments/{id}/decline","ADR-000"],
  ["entrega","BC04","RegistrarRevision","RevisionRegistrada","POST /submissions/{id}/reviews","ADR-000"],
  ["historial","BC04","ConsultarHistorial","—","GET /submissions/{id}/reviews","ADR-000"],
  ["decision","BC05","CalcularDecisionEditorial","DecisionEmitida","POST /submissions/{id}/decision","ADR-000"],
  ["aceptacion-final","BC05","EmitirCertificado","CertificadoEmitido","POST /submissions/{id}/acceptance-letter","ADR-000"],
  ["alta-revista","BC06","CrearRevista","VenueCreado","POST /venues/journals","ADR-000"],
  ["alta-evento","BC06","CrearEvento","EventoCreado","POST /venues/conferences","ADR-000"],
  ["versionado-reglas","BC06","PublicarVersionReglas","ReglasPublicadas","POST /venues/{id}/rulesets","ADR-000"],
  ["roles-editoriales","BC06","AsignarRolEditorial","RolesAsignados","POST /venues/{id}/roles","ADR-000"],
  ["metricas-autor","BC07","GenerarMetricasAutor","ReporteGenerado","GET /reports/authors","ADR-000"],
  ["metricas-revista","BC07","GenerarMetricasRevista","ReporteGenerado","GET /reports/venues","ADR-000"],
  ["export","BC07","GenerarExportacion","ExportacionLista","POST /exports","ADR-000"],
  ["boletin","BC07","EnviarBoletin","BoletinEnviado","POST /digests/monthly","ADR-000"],
  ["orcid","BC08","SincronizarORCID","PerfilSincronizado","POST /integrations/orcid/sync","ADR-000"],
  ["scopus-scholar","BC08","ImportarPublicaciones","PublicacionesImportadas","POST /integrations/scholar-scopus/sync","ADR-000"],
  ["doi","BC08","ValidarDOI","DOIVerificado","POST /integrations/doi/validate","ADR-000"],
];

/* --- BDD snippets (subset curado) --- */
const bddBlocks = [
{ tag:"@registro-exitoso", feature:"Registro y autenticación de investigadores", text:`Feature: Registro y autenticación de investigadores
  Como Investigador
  Quiero registrarme y autenticarme
  Para gestionar mis envíos y revisiones

  @registro-exitoso
  Scenario: Registro exitoso con ORCID y verificación de email
    Given existe el proveedor de identidad "ORCID"
    And no existe una cuenta previa con email "ana@uni.edu"
    When el Investigador se registra con ORCID válido y email "ana@uni.edu"
    And confirma el email recibido
    Then la cuenta "ana@uni.edu" queda en estado "Activa"
    And el perfil se crea con ORCID vinculado`},

{ tag:"@autenticacion-ok", feature:"Registro y autenticación de investigadores", text:`@autenticacion-ok
Scenario: Autenticación exitosa con credenciales válidas
  Given existe la cuenta "ana@uni.edu" en estado "Activa" con password "s3cret!"
  When intenta autenticarse con email "ana@uni.edu" y password "s3cret!"
  Then el acceso es concedido
  And se registra auditoría de inicio de sesión`},

{ tag:"@autenticacion-falla", feature:"Registro y autenticación de investigadores", text:`@autenticacion-falla
Scenario: Autenticación rechazada por contraseña incorrecta
  Given existe la cuenta "ana@uni.edu" en estado "Activa" con password "s3cret!"
  When intenta autenticarse con email "ana@uni.edu" y password "wrong"
  Then el acceso es denegado por credenciales inválidas`},

{ tag:"@bloqueo", feature:"Registro y autenticación de investigadores", text:`@bloqueo
Scenario: Bloqueo por múltiples intentos fallidos
  Given existe la cuenta "mike@uni.edu" en estado "Activa" con password "pass"
  When intenta autenticarse 5 veces con password incorrecto
  Then la cuenta "mike@uni.edu" queda en estado "Bloqueada"
  And se notifica al usuario por email`},

{ tag:"@perfil-basico", feature:"Gestión de perfil de investigador", text:`Feature: Gestión de perfil de investigador
  Como Investigador
  Quiero mantener mi perfil con afiliación, áreas y métricas
  Para facilitar asignaciones y reportes

  @perfil-basico
  Scenario: Completar afiliación y áreas de interés
    Given el Investigador "Ana" tiene un perfil inicial sin afiliación ni áreas
    When actualiza afiliación a "Universidad X" y áreas ["IA", "NLP"]
    Then el perfil de "Ana" muestra afiliación "Universidad X" y áreas ["IA", "NLP"]`},

{ tag:"@sincronizacion-metricas", feature:"Gestión de perfil de investigador", text:`@sincronizacion-metricas
Scenario: Importar métricas desde ORCID/Google Scholar
  Given el perfil "Ana" tiene ORCID vinculado
  When sincroniza métricas de citaciones e índice-h desde "Google Scholar"
  Then el perfil exhibe métricas actualizadas con fuente "Google Scholar" y fecha de actualización`},

{ tag:"@envio-evento", feature:"Envío y versionado de artículos", text:`Feature: Envío y versionado de artículos
  Como Autor
  Quiero enviar y versionar artículos
  Para postular a revistas y conferencias respetando deadlines

  @envio-evento
  Scenario: Envío válido a evento antes del deadline
    Given existe el Evento "IC-2026" con fecha límite de envío "2026-05-01"
    And soy Autor con perfil completo
    When envío el Artículo "A-101" a "IC-2026" en fecha "2026-04-20"
    Then se registra el Envío "E-1" en estado "Enviado" con versión 1
    And recibo comprobante de envío con sello de tiempo`},

{ tag:"@envio-revista", feature:"Envío y versionado de artículos", text:`@envio-revista
Scenario: Envío válido a revista con revisión doble ciego
  Given existe la Revista "SJ-ML" con tipo de revisión "Doble ciego"
  And soy Autor con perfil completo
  When envío el Artículo "A-202" a "SJ-ML" en fecha "2026-03-10"
  Then se registra el Envío "E-2" en estado "Enviado" con versión 1
  And se verifica que el archivo no contenga datos identificatorios`},

{ tag:"@deadline", feature:"Envío y versionado de artículos", text:`@deadline
Scenario: Rechazo por envío fuera de fecha
  Given existe el Evento "IC-2026" con fecha límite de envío "2026-05-01"
  And soy Autor con perfil completo
  When envío el Artículo "A-102" a "IC-2026" en fecha "2026-05-10"
  Then el sistema rechaza el envío por deadline excedido con motivo "Fecha límite superada"`},

{ tag:"@versionado", feature:"Envío y versionado de artículos", text:`@versionado
Scenario: Nuevo versionado de un envío en curso
  Given existe el Envío "E-1" del Artículo "A-101" en estado "Enviado" y versión 1
  When adjunto una nueva versión con cambios menores
  Then el Envío "E-1" queda en versión 2
  And el historial conserva versiones [1, 2]`},

{ tag:"@alta-revisor", feature:"Registro de revisores y especialidades", text:`Feature: Registro de revisores y especialidades
  Como Revisor
  Quiero registrar mis especialidades y conflictos
  Para recibir asignaciones apropiadas

  @alta-revisor
  Scenario: Registro de revisor con especialidades
    Given no existe el Revisor "r1"
    When registro al Revisor "r1" con especialidades ["IA", "NLP"]
    Then el Revisor "r1" queda "Activo" con especialidades ["IA", "NLP"]`},

{ tag:"@conflictos", feature:"Registro de revisores y especialidades", text:`@conflictos
Scenario: Declaración de conflicto de interés
  Given el Revisor "r1" está "Activo"
  When declara conflicto con el Autor "Ana" por coautoría reciente
  Then el conflicto queda registrado y bloquea asignaciones con "Ana" por 2 años`},

{ tag:"@auto-assign", feature:"Asignación de revisores y manejo de ceguera", text:`Feature: Asignación de revisores y manejo de ceguera
  Como Editor
  Quiero asignar revisores automáticamente o manualmente
  Para iniciar la evaluación cumpliendo reglas y anonimato

  @auto-assign
  Scenario: Asignación automática según especialidad y conflictos
    Given existe el Envío "E-1" con tema "NLP"
    And candidatos Revisores ["r1:IA", "r2:SE", "r3:NLP", "r4:IA"]
    And el Revisor "r2" tiene conflicto con el Autor de "E-1"
    And las reglas editoriales exigen "3" revisores
    When ejecuto la asignación automática para "E-1"
    Then quedan asignados 3 revisores especialistas sin conflictos
    And el Autor no ve las identidades de los revisores
    And los Revisores no ven la identidad ni afiliación del Autor`},

{ tag:"@manual-assign", feature:"Asignación de revisores y manejo de ceguera", text:`@manual-assign
Scenario: Asignación manual con validación de conflictos
  Given existe el Envío "E-1" pendiente de asignación
  And el Editor selecciona "r2", "r3" y "r4"
  When confirma la asignación manual
  Then el sistema impide asignar "r2" por conflicto registrado
  And propone candidatos alternativos compatibles`},

{ tag:"@ceguera-simple", feature:"Asignación de revisores y manejo de ceguera", text:`@ceguera-simple
Scenario: Aplicación de ceguera simple en revista configurada
  Given la Revista "SJ-DS" tiene tipo de revisión "Ciego simple"
  And existe el Envío "E-3" a "SJ-DS"
  When asigno revisores para "E-3"
  Then los Revisores no ven la identidad del Autor
  And el Autor puede ver las identidades de los Revisores solo después de la decisión final`},

{ tag:"@aceptacion", feature:"Ciclo de revisión por pares", text:`Feature: Ciclo de revisión por pares
  Como Revisor
  Quiero aceptar/declinar invitaciones y cargar evaluaciones
  Para contribuir a la decisión editorial

  @aceptacion
  Scenario: Revisor acepta invitación
    Given el Revisor "r3" fue invitado a revisar el Envío "E-1"
    When "r3" acepta la invitación dentro de 3 días
    Then la asignación de "r3" pasa a estado "Aceptada"
    And se habilita el formulario de revisión`},

{ tag:"@declinacion", feature:"Ciclo de revisión por pares", text:`@declinacion
Scenario: Revisor declina por conflicto sobrevenido
  Given el Revisor "r3" fue invitado a revisar el Envío "E-1"
  When "r3" declara conflicto y declina la invitación
  Then su asignación pasa a "Declinada"
  And se notifica al Editor para reasignación`},

{ tag:"@entrega", feature:"Ciclo de revisión por pares", text:`@entrega
Scenario: Entrega de revisión con recomendación
  Given el Revisor "r3" tiene asignación "Aceptada" sobre "E-1"
  When envía su revisión con recomendación "Mayor revisión"
  Then la revisión queda registrada con sello de tiempo y versión
  And el historial del Envío "E-1" muestra la revisión de "r3"`},

{ tag:"@historial", feature:"Ciclo de revisión por pares", text:`@historial
Scenario: Consulta del historial completo de revisiones por artículo
  Given existen revisiones de "r1", "r3" y "r4" para el Envío "E-1"
  When consulto el historial de revisiones de "E-1"
  Then veo todas las revisiones con autores anónimos, fechas y recomendaciones`},

{ tag:"@decision", feature:"Decisión editorial y comunicaciones", text:`Feature: Decisión editorial y comunicaciones
  Como Editor
  Quiero emitir decisiones y cartas
  Para cerrar el proceso conforme a reglas

  @decision
  Scenario: Emisión de decisión basada en reglas y quorum
    Given el Envío "E-1" tiene 3 revisiones con recomendaciones ["Aceptación", "Mayor revisión", "Aceptación"]
    And las reglas exigen minRevisiones=3, quorum="2 de 3", umbral=">=Aceptación"
    When calculo la decisión editorial para "E-1"
    Then la decisión es "Aceptado condicional"
    And se genera carta de decisión con condiciones y plantilla aprobada`},

{ tag:"@aceptacion-final", feature:"Decisión editorial y comunicaciones", text:`@aceptacion-final
Scenario: Emisión de certificado tras aceptación final
  Given el Envío "E-1" está en estado "Aceptado"
  And el Autor subió la versión final y transfirió copyright
  When cierro el expediente editorial
  Then se emite certificado de aceptación para el Autor
  And se programa la publicación con fecha estimada`},

{ tag:"@metricas-autor", feature:"Gestión de métricas e informes", text:`Feature: Gestión de métricas e informes
  Como Analista
  Quiero generar métricas y exportarlas
  Para seguimiento por autor, artículo, evento y revista

  @metricas-autor
  Scenario: Métricas por autor y evento
    Given existen envíos y decisiones históricas
    When genero métricas para el Autor "Ana" en el Evento "IC-2026"
    Then obtengo métricas {envios:2, aceptados:1, tasaAceptacion:"50%"} con periodo consultado`},

{ tag:"@metricas-revista", feature:"Gestión de métricas e informes", text:`@metricas-revista
Scenario: Métricas por revista
  Given existen decisiones en la Revista "SJ-ML" durante 2026
  When genero el informe de tasa de aceptación mensual para "SJ-ML"
  Then obtengo una serie temporal con aceptación, tiempos de revisión y desviación estándar`},

{ tag:"@export", feature:"Gestión de métricas e informes", text:`@export
Scenario Outline: Exportación de reportes a formatos estándar
  Given existe un reporte consolidado "R-1"
  When exporto el reporte "R-1" en formato "<formato>"
  Then descargo un archivo con extensión "<extension>" y esquema válido

  Examples:
    | formato | extension |
    | CSV     | .csv      |
    | JSON-LD | .jsonld   |
    | XML     | .xml      |`},

{ tag:"@boletin", feature:"Gestión de métricas e informes", text:`@boletin
Scenario: Envío de notificación mensual personalizada
  Given el Autor "Ana" está suscripto al resumen mensual
  And existen métricas del último mes para "Ana"
  When corre el job mensual
  Then se envía un email a "Ana" con su resumen y enlaces a detalles`},

{ tag:"@orcid", feature:"Integraciones externas y validación de metadatos", text:`Feature: Integraciones externas y validación de metadatos
  Como Sistema
  Quiero sincronizar perfiles y validar metadatos
  Para mantener calidad e interoperabilidad

  @orcid
  Scenario: Sincronización de datos de perfil desde ORCID
    Given el perfil "Ana" tiene ORCID vinculado
    And existen cambios en ORCID para nombre y afiliación
    When sincronizo datos desde ORCID
    Then el perfil se actualiza preservando cambios locales confirmados
    And se registra la fuente y fecha de sincronización`},

{ tag:"@scopus-scholar", feature:"Integraciones externas y validación de metadatos", text:`@scopus-scholar
Scenario: Importación de publicaciones desde Scopus y Google Scholar
  Given el perfil "Ana" tiene identificadores válidos en Scopus y Google Scholar
  When importo sus publicaciones recientes
  Then las nuevas publicaciones se agregan como referencias con deduplicación por DOI`},

{ tag:"@doi", feature:"Integraciones externas y validación de metadatos", text:`@doi
Scenario: Validación de DOI y metadatos al registrar versión final
  Given el Envío "E-1" está en versión final con DOI "10.1000/xyz123"
  And los metadatos requeridos son {titulo, autores, afiliaciones, resumen, palabrasClave}
  When valido el DOI y los metadatos
  Then el DOI queda marcado "Válido" y los metadatos "Completos"
  And el registro queda listo para indexación`}
];

/* ---------- UI helpers ---------- */
const tabs = [
  {id:"intro", label:"Resumen"},
  {id:"marco", label:"Marco BDMA"},
  {id:"requisitos", label:"Requisitos"},
  {id:"bdd", label:"Escenarios BDD"},
  {id:"fase1", label:"Fase 1"},
  {id:"fase2", label:"Fase 2"},
  {id:"fase3", label:"Fase 3"},
  {id:"fase4", label:"Fase 4"},
  {id:"fase5", label:"Fase 5"}
];

function mountTabs(){
  const nav = document.getElementById('tabs');
  tabs.forEach(t => {
    const b=document.createElement('button'); b.textContent=t.label;
    b.onclick=()=>activate(t.id);
    if(t.id==='intro') b.classList.add('active');
    nav.appendChild(b);
  });
}

function activate(id){
  document.querySelectorAll('nav button').forEach(b => b.classList.toggle('active', b.textContent===tabs.find(t=>t.id===id).label));
  document.querySelectorAll('main section').forEach(s => s.classList.toggle('active', s.id===id));
  if(id==='fase3') setTimeout(drawEdges, 0);
}

function makeControls(onSearch){
  const div = document.createElement('div'); div.className='controls';
  const left = document.createElement('div'); left.className='search';
  const input=document.createElement('input'); input.placeholder='Buscar…'; input.oninput=(e)=>onSearch(e.target.value.trim().toLowerCase());
  left.append('🔎', input);
  const right = document.createElement('div');
  const btn=document.createElement('button'); btn.className='btn'; btn.textContent='Imprimir / PDF'; btn.onclick=()=>print();
  right.append(btn);
  div.append(left,right);
  return div;
}

function renderMarco(){
  const sec=document.getElementById('marco'); sec.innerHTML='';
  
  // Propósito y principios
  const grid1=document.createElement('div'); grid1.className='grid';
  
  const proposito=document.createElement('div'); proposito.className='card';
  proposito.innerHTML=`
    <h3>Propósito del Marco BDMA</h3>
    <p class="muted">Proveer un marco metodológico sistemático y reproducible que guíe la identificación, diseño y evolución de arquitecturas de microservicios en contextos ágiles greenfield, a partir de la transformación iterativa y trazable de escenarios funcionales BDD en bounded contexts, contratos de servicio e interfaces verificables.</p>
    <p class="muted">BDMA integra principios de Domain-Driven Design (DDD), técnicas de Behavior-Driven Development (BDD) y prácticas de arquitectura evolutiva, con el objetivo de alinear continuamente la especificación funcional del sistema con su arquitectura técnica.</p>
  `;
  
  const principios=document.createElement('div'); principios.className='card';
  principios.innerHTML=`
    <h3>Principios Fundamentales</h3>
    <ul class="muted">
      <li><strong>Trazabilidad total:</strong> Cada servicio implementado debe poder rastrearse hasta uno o más escenarios BDD.</li>
      <li><strong>Arquitectura emergente y evolutiva:</strong> El diseño se adapta iterativamente a la evolución de los escenarios.</li>
      <li><strong>Diseño colaborativo:</strong> Las decisiones arquitectónicas se validan con expertos de dominio y técnicos.</li>
      <li><strong>Lenguaje ubicuo:</strong> El vocabulario de los escenarios permea contratos y artefactos de diseño.</li>
      <li><strong>Evidencia funcional continua:</strong> Las pruebas BDD son la validación activa de la arquitectura.</li>
    </ul>
  `;
  
  grid1.append(proposito, principios);
  sec.appendChild(grid1);
  
  // Diferencial metodológico
  const diferencial=document.createElement('div'); diferencial.className='card';
  diferencial.innerHTML=`
    <h3>Aporte: Diferencial Metodológico</h3>
    <p class="muted">BDMA es un método iterativo que transforma requisitos funcionales en decisiones arquitectónicas verificables. A diferencia de enfoques previos, que suelen ser teóricos o centrados en contextos brownfield, BDMA:</p>
    <div class="kpi">
      <span class="pill">Define artefactos intermedios claros</span>
      <span class="pill">Establece un flujo de fases aplicable en entornos ágiles reales</span>
      <span class="pill">Garantiza trazabilidad y validación continua</span>
      <span class="pill">Enfoque greenfield orientado a la práctica</span>
    </div>
    <div class="info">El marco no genera los escenarios BDD, sino que parte de un backlog funcional ya redactado y validado.</div>
  `;
  sec.appendChild(diferencial);
  
  // Proceso por fases
  const proceso=document.createElement('div'); proceso.className='card';
  proceso.innerHTML=`
    <h3>Proceso Estructurado en 5 Fases</h3>
    <table style="margin-top: 12px;">
      <thead>
        <tr><th>Fase</th><th>Concepto</th><th>Objetivo</th></tr>
      </thead>
      <tbody>
        <tr>
          <td><strong>Fase 1</strong><br>Clasificación funcional</td>
          <td>Arquitectura evolutiva alineada a features/epics</td>
          <td>Organizar escenarios BDD en agrupaciones coherentes</td>
        </tr>
        <tr>
          <td><strong>Fase 2</strong><br>Extracción de dominio</td>
          <td>BDD para describir comportamiento y extraer elementos</td>
          <td>Identificar actores, comandos, eventos y entidades</td>
        </tr>
        <tr>
          <td><strong>Fase 3</strong><br>Bounded contexts</td>
          <td>Context Map, delimitación DDD</td>
          <td>Agrupar elementos en contextos coherentes y delimitados</td>
        </tr>
        <tr>
          <td><strong>Fase 4</strong><br>Contratos API</td>
          <td>Diseño contract-first y patrones de testabilidad</td>
          <td>Traducir comandos/eventos en contratos verificables</td>
        </tr>
        <tr>
          <td><strong>Fase 5</strong><br>Validación continua</td>
          <td>ADR y evolución estructural</td>
          <td>Garantizar evolución sincronizada y trazabilidad</td>
        </tr>
      </tbody>
    </table>
  `;
  sec.appendChild(proceso);
  
  // Integración ágil
  const agil=document.createElement('div'); agil.className='card';
  agil.innerHTML=`
    <h3>Integración con Ciclo Ágil</h3>
    <p class="muted">BDMA no propone un enfoque secuencial cerrado, sino un marco que se integra incrementalmente al ciclo de vida ágil. En cada iteración (Sprint), se aplican las fases únicamente sobre los escenarios funcionales priorizados.</p>
    <table style="margin-top: 12px;">
      <thead>
        <tr><th>Etapa del Sprint</th><th>Fase BDMA</th><th>Actividad</th></tr>
      </thead>
      <tbody>
        <tr><td>Refinamiento del backlog</td><td>Fase 1</td><td>Agrupar nuevos escenarios BDD por feature/epic</td></tr>
        <tr><td>Inicio del Sprint</td><td>Fase 2</td><td>Analizar escenarios priorizados, identificar comandos/eventos</td></tr>
        <tr><td>Diseño técnico inicial</td><td>Fase 3</td><td>Ajustar límites de contextos si hay cambios relevantes</td></tr>
        <tr><td>Implementación</td><td>Fase 4</td><td>Derivar contratos desde nuevos escenarios</td></tr>
        <tr><td>Durante el Sprint</td><td>Fase 5</td><td>Ejecutar pruebas BDD, detectar impactos, registrar ADRs</td></tr>
        <tr><td>Cierre/Revisión</td><td>Consolidación</td><td>Validar arquitectura, versionar Context Map</td></tr>
      </tbody>
    </table>
  `;
  sec.appendChild(agil);
}

function renderRequisitos(){
  const sec=document.getElementById('requisitos'); sec.innerHTML='';
  const grid=document.createElement('div'); grid.className='grid';

  const c1=document.createElement('div'); c1.className='card span6';
  c1.innerHTML=`<h3>Requisitos funcionales</h3>
    <p class="muted">${requisitos.contexto}</p>
    <ul class="muted">${requisitos.funcionales.map(x=>`<li>${x}</li>`).join('')}</ul>`;

  const c2=document.createElement('div'); c2.className='card span6';
  c2.innerHTML=`<h3>Requisitos no funcionales</h3>
    <ul class="muted">${requisitos.noFunc.map(x=>`<li>${x}</li>`).join('')}</ul>`;

  grid.append(c1,c2);
  sec.appendChild(grid);
}

function renderBDD(){
  const sec=document.getElementById('bdd'); sec.innerHTML='';
  const title=document.createElement('div'); title.className='card';
  title.innerHTML='<h3>Escenarios clave (Gherkin)</h3><p class="muted">Fragmentos listos para copiar y pegar en suites de pruebas BDD.</p>';
  sec.appendChild(title);

  bddBlocks.forEach(b=>{
    const c=document.createElement('div'); c.className='card';
    const bar=document.createElement('div'); bar.className='codebar';
    bar.innerHTML=`<div><span class="tag">${b.feature}</span> <span class="tag">${b.tag}</span></div>`;
    const copy=document.createElement('button'); copy.className='btn'; copy.textContent='Copiar';
    copy.onclick=()=>navigator.clipboard.writeText(b.text);
    bar.appendChild(copy);
    c.appendChild(bar);
    const pre=document.createElement('pre'); pre.innerHTML=`<code>${escapeHtml(b.text)}</code>`;
    c.appendChild(pre);
    sec.appendChild(c);
  });
}

function renderFase1(){
  const sec=document.getElementById('fase1'); sec.innerHTML='';
  const card=document.createElement('div'); card.className='card';
  card.innerHTML='<h3>Fase 1 · Grupos funcionales → candidatos a bounded contexts</h3>';
  const controls = makeControls(filter);
  const table=document.createElement('table');
  table.innerHTML=`<thead><tr><th>ID</th><th>Nombre</th><th>Propósito</th><th>Escenarios</th></tr></thead><tbody></tbody>`;
  const tbody=table.querySelector('tbody');
  gruposF1.forEach(g=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${g.id}</td><td>${g.nombre}</td><td>${g.proposito}</td><td>${g.escenarios.join(', ')}</td>`;
    tbody.appendChild(tr);
  });
  function filter(q){ [...tbody.children].forEach(tr=>{
    tr.style.display = tr.textContent.toLowerCase().includes(q) ? '' : 'none';
  });}
  card.append(controls, table);
  sec.appendChild(card);
}

function renderFase2(){
  const sec=document.getElementById('fase2'); sec.innerHTML='';
  const card=document.createElement('div'); card.className='card';
  card.innerHTML='<h3>Fase 2 · Comandos y eventos por contexto</h3>';
  const controls = makeControls(filter);
  const table=document.createElement('table');
  table.innerHTML=`<thead><tr><th>Contexto funcional</th><th>Comandos (When)</th><th>Eventos (Then)</th></tr></thead><tbody></tbody>`;
  const tbody=table.querySelector('tbody');
  fase2ComEv.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.ctx}</td><td>${r.comandos.join(', ')}</td><td>${r.eventos.join(', ')}</td>`;
    tbody.appendChild(tr);
  });
  function filter(q){ [...tbody.children].forEach(tr=>tr.style.display = tr.textContent.toLowerCase().includes(q) ? '' : 'none'); }
  card.append(controls, table);
  sec.appendChild(card);
}

function renderFase3(){
  const sec=document.getElementById('fase3'); sec.innerHTML='';
  const grid=document.createElement('div'); grid.className='grid';

  const left=document.createElement('div'); left.className='card span6';
  left.innerHTML='<h3>Fase 3 · Bounded contexts</h3>';
  const table=document.createElement('table'); table.innerHTML='<thead><tr><th>ID</th><th>Responsabilidad</th></tr></thead><tbody></tbody>';
  const tbody=table.querySelector('tbody');
  bc.forEach(x=>{
    const tr=document.createElement('tr'); tr.innerHTML=`<td><strong>${x.id}</strong> · ${x.name}</td><td>${x.resp}</td>`; tbody.appendChild(tr);
  });
  left.appendChild(table);

  const right=document.createElement('div'); right.className='card span6';
  right.innerHTML='<h3>Context map (interacciones)</h3><div id="mapWrap"><svg id="mapSvg"></svg></div>';
  const legend=document.createElement('p'); legend.className='muted';
  legend.innerHTML='Líneas curvas indican dependencias/eventos. Se listan interacciones clave debajo.';
  right.appendChild(legend);
  const list=document.createElement('div'); list.className='muted'; list.style.marginTop='8px';
  list.innerHTML = interactions.map(e=>`• <strong>${e.from}</strong> → <strong>${e.to}</strong> <em>(${e.type})</em> — ${e.note}`).join('<br/>');
  right.appendChild(list);

  grid.append(left,right);
  sec.appendChild(grid);

  // mount boxes after render
  setTimeout(()=>{
    const wrap=document.getElementById('mapWrap');
    const cols=3, rowH=170, colW=280, ox=10, oy=10;
    bc.forEach((x,i)=>{
      const box=document.createElement('div'); box.className='ctx'; box.id=x.id;
      const r=Math.floor(i/cols), c=i%cols;
      box.style.left = (ox + c*colW) + 'px';
      box.style.top  = (oy + r*rowH) + 'px';
      box.innerHTML = `<h4>${x.id} · ${x.name}</h4><p>${x.resp}</p>`;
      wrap.appendChild(box);
    });
    drawEdges();
  }, 0);
}

function drawEdges(){
  const svg=document.getElementById('mapSvg'); const wrap=svg.parentElement;
  const boxes=[...wrap.querySelectorAll('.ctx')];
  const bb=wrap.getBoundingClientRect();
  svg.setAttribute('width', wrap.clientWidth); svg.setAttribute('height', wrap.clientHeight);
  svg.innerHTML = `
    <defs>
      <marker id="arrow" markerWidth="10" markerHeight="8" refX="8" refY="4" orient="auto">
        <polygon points="0 0, 10 4, 0 8" fill="#64b5f6"></polygon>
      </marker>
    </defs>
  `;
  function center(el){
    const r=el.getBoundingClientRect();
    return { x: (r.left - bb.left) + r.width/2, y: (r.top - bb.top) + r.height/2 };
  }
  function edge(fromId,toId){
    const f=document.getElementById(fromId), t=document.getElementById(toId);
    if(!f||!t) return;
    const a=center(f), b=center(t);
    const path=document.createElementNS('http://www.w3.org/2000/svg','path');
    const dx=b.x-a.x, dy=b.y-a.y, cx1=a.x+dx*0.35, cy1=a.y, cx2=b.x-dx*0.35, cy2=b.y;
    path.setAttribute('d', `M${a.x},${a.y} C ${cx1},${cy1} ${cx2},${cy2} ${b.x},${b.y}`);
    path.setAttribute('class','edge'); svg.appendChild(path);
  }
  interactions.forEach(e=>edge(e.from, e.to));
}

function renderFase4(){
  const sec=document.getElementById('fase4'); sec.innerHTML='';
  const card=document.createElement('div'); card.className='card';
  card.innerHTML='<h3>Fase 4 · Contratos API (contract-first)</h3>';
  const controls = makeControls(filter);
  const table=document.createElement('table');
  table.innerHTML=`<thead><tr><th>G</th><th>Contexto</th><th>Método</th><th>Endpoint</th><th>Request (claves)</th><th>Response (claves)</th><th>Códigos</th><th>Escenario</th></tr></thead><tbody></tbody>`;
  const tbody=table.querySelector('tbody');
  endpoints.forEach(e=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${e.g}</td><td>${e.ctx}</td><td><strong>${e.method}</strong></td><td><code>${e.path}</code></td><td>${e.req}</td><td>${e.res}</td><td>${e.codes}</td><td>${e.escenario}</td>`;
    tbody.appendChild(tr);
  });
  function filter(q){ [...tbody.children].forEach(tr=>tr.style.display = tr.textContent.toLowerCase().includes(q) ? '' : 'none'); }
  card.append(controls, table);
  sec.appendChild(card);
}

function renderFase5(){
  const sec=document.getElementById('fase5'); sec.innerHTML='';
  const grid=document.createElement('div'); grid.className='grid';

  const c1=document.createElement('div'); c1.className='card span6';
  c1.innerHTML='<h3>Fase 5 · ADR</h3>';
  const ul=document.createElement('ul'); ul.className='muted';
  adrLog.forEach(a=>{
    const li=document.createElement('li'); li.innerHTML = `<strong>${a.id}</strong> (${a.estado} · ${a.fecha}) — ${a.texto}`; ul.appendChild(li);
  });
  c1.appendChild(ul);

  const c2=document.createElement('div'); c2.className='card span6';
  c2.innerHTML='<h3>Trazabilidad evolutiva (Escenario → Comando → Evento → Endpoint → ADR)</h3>';
  const controls = makeControls(filter);
  const table=document.createElement('table');
  table.innerHTML='<thead><tr><th>Escenario</th><th>BC</th><th>Comando</th><th>Evento</th><th>Contrato</th><th>ADR</th></tr></thead><tbody></tbody>';
  const tbody=table.querySelector('tbody');
  trazabilidad.forEach(r=>{
    const tr=document.createElement('tr'); tr.innerHTML = r.map(x=>`<td>${x}</td>`).join(''); tbody.appendChild(tr);
  });
  function filter(q){ [...tbody.children].forEach(tr=>tr.style.display = tr.textContent.toLowerCase().includes(q) ? '' : 'none'); }
  c2.append(controls, table);

  grid.append(c1,c2);
  sec.appendChild(grid);
}

/* ---------- Render all ---------- */
function escapeHtml(s){ return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'\"'":'&#39;'}[m])); }
function init(){
  mountTabs();
  renderMarco();
  renderRequisitos();
  renderBDD();
  renderFase1();
  renderFase2();
  renderFase3();
  renderFase4();
  renderFase5();
  window.addEventListener('resize', ()=>{ if(document.getElementById('fase3').classList.contains('active')) drawEdges(); });
}
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
