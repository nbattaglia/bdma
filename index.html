<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BDMA – Iteración 1 · Sitio de soporte a la evaluación</title>
<style>
  :root{
    --bg:#0b0c10;
    --panel:#0e1117;
    --muted:#a3a3a3;
    --text:#f1f5f9;
    --brand:#60a5fa;
    --accent:#34d399;
    --warn:#fbbf24;
    --danger:#f87171;
    --card:#0f172a;
    --code:#0b1220;
    --link:#93c5fd;
    --border:#1f2937;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font: 15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
    color:var(--text);
    background:linear-gradient(180deg, #0b1020, #0b0c10 30% 100%);
  }
  header{
    position:sticky; top:0; z-index:5;
    background:rgba(10,14,24,.85); backdrop-filter: blur(8px);
    border-bottom:1px solid var(--border);
  }
  .wrap{max-width:1160px; margin:0 auto; padding:16px}
  .title{display:flex; align-items:flex-start; justify-content:space-between; gap:16px; flex-wrap:wrap}
  .title h1{font-size:22px; margin:0}
  .lead{margin:6px 0 0 0; color:#cbd5e1}
  nav{display:flex; gap:10px; margin-top:12px; flex-wrap:wrap}
  nav button{
    background:#0c1220; color:#dbe6ff; border:1px solid var(--border); border-radius:10px;
    padding:8px 12px; cursor:pointer; transition:.2s;
  }
  nav button.active{border-color:#2b66ff; box-shadow: 0 0 0 2px rgba(43,102,255,.25) inset}
  main{padding:24px 0}
  section{display:none}
  section.active{display:block; animation:fade .2s ease}
  @keyframes fade{from{opacity:.6; transform:translateY(4px)} to{opacity:1; transform:none}}

  /* layout */
  .grid{display:grid; grid-template-columns:repeat(12,1fr); gap:14px}
  .card{grid-column: span 12; background:linear-gradient(180deg,#0f172a,#0b1220 40% 100%);
        border:1px solid var(--border); border-radius:16px; padding:16px}
  .card h3{margin:0 0 8px 0; font-size:18px}
  .muted{color:var(--muted)}
  .kpi{display:flex; gap:12px; flex-wrap:wrap}
  .kpi .pill{background:#0b1220; border:1px solid var(--border); border-radius:999px; padding:4px 10px; color:#cbd5e1}
  .info{border-left:3px solid var(--brand); padding:8px 12px; background:#0b1220; color:#c7d2fe; border-radius:8px}

  table{width:100%; border-collapse:collapse; background:#0b1220; border:1px solid var(--border); border-radius:12px; overflow:hidden}
  th,td{padding:10px 12px; border-bottom:1px solid var(--border); vertical-align:top}
  th{background:#0f172a; text-align:left; color:#cbd5e1; position:sticky; top:0; z-index:1}
  tr:hover td{background:#0e1528}
  .controls{display:flex; gap:10px; justify-content:space-between; align-items:center; margin:8px 0 14px}
  .search{display:flex; gap:8px; align-items:center}
  .search input{background:#0b1220; color:#e2e8f0; border:1px solid var(--border); border-radius:10px; padding:8px 10px; width:280px}
  .btn{appearance:none; background:#0c1220; color:#e5edff; border:1px solid var(--border); border-radius:10px; padding:8px 12px; cursor:pointer}
  .btn:hover{border-color:#2b66ff}
  a{color:var(--link); text-decoration:none}
  a:hover{text-decoration:underline}

  pre{background:var(--code); border:1px solid var(--border); color:#e2e8f0; border-radius:12px; padding:12px; overflow:auto}
  code{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,monospace; font-size:13px}
  .codebar{display:flex; justify-content:space-between; align-items:center; gap:8px; margin:6px 0}
  .tag{font-size:12px; color:#a3bffa; background:#0b1220; border:1px solid var(--border); border-radius:999px; padding:2px 8px}

  /* Context map */
  #mapWrap{position:relative; background:#0b1220; border:1px solid var(--border); border-radius:16px; padding:12px; min-height:500px}
  #mapSvg{position:absolute; inset:0; pointer-events:none}
  .ctx{position:absolute; width:240px; min-height:72px; background:#0f172a; border:1px solid var(--border); border-radius:12px; padding:10px}
  .ctx h4{margin:0 0 6px 0; font-size:15px; color:#e5e7eb}
  .ctx p{margin:0; color:#a1a1aa; font-size:13px}
  .edge{stroke:#64b5f6; stroke-width:2; marker-end:url(#arrow)}

  /* Responsive */
  @media (min-width:860px){
    .card.span6{grid-column: span 6}
  }
  @media print{
    header, nav, .controls{display:none !important}
    body{background:white; color:black}
    .card, table, pre{border-color:#ddd}
    a{color:black; text-decoration:none}
  }

  footer{padding:28px 16px; border-top:1px solid var(--border); color:#98a2b3}
  
  /* Separación entre secciones */
  .fase-section{margin-bottom:24px; padding-bottom:16px; border-bottom:1px solid var(--border)}
  .fase-section:last-child{border-bottom:none}

  /* Modal para escenarios */
  .modal-overlay{position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:none; z-index:1000; align-items:center; justify-content:center; padding:20px}
  .modal-content{background:var(--bg); border:1px solid var(--border); border-radius:16px; max-width:800px; max-height:90vh; overflow:auto; padding:24px; position:relative}
  .modal-header{display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; padding-bottom:12px; border-bottom:1px solid var(--border)}
  .modal-title{margin:0; color:#f8fafc; font-size:18px}
  .modal-close{background:none; border:none; color:#64748b; font-size:24px; cursor:pointer; padding:4px; border-radius:4px}
  .modal-close:hover{background:var(--border); color:#f8fafc}
  .modal-body{color:#e2e8f0}
  .scenario-link{color:#3b82f6; cursor:pointer; text-decoration:underline}
  .scenario-link:hover{color:#60a5fa}
</style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="title">
        <div>
          <h1>Behavior-Driven Microservice Architecture:  un marco metodológico para la identificación iterativa de microservicios en proyectos ágiles greenfield </h1>
          <p class="lead">Recolección curada de artefactos: requisitos, escenarios BDD, derivaciones de Fase 1 a 5, contratos API y trazabilidad integral.</p>
        </div>
        
      </div>
      <nav id="tabs"></nav>
    </div>
  </header>

  <main class="wrap">
    <!-- RESUMEN -->
    <section id="intro" class="active">
      <div class="grid">
        <div class="card">
          <h3>Propósito</h3>
          <p class="muted">Este sitio acompaña la evaluación del artículo sobre <strong>BDMA (Behavior-Driven Microservice Architecture)</strong>, un marco metodológico sistemático y reproducible que guía la identificación, diseño y evolución de arquitecturas de microservicios en contextos ágiles greenfield.</p>
          <p class="muted">BDMA transforma escenarios funcionales BDD en bounded contexts, contratos de servicio e interfaces verificables, integrando principios de Domain-Driven Design (DDD), técnicas de Behavior-Driven Development (BDD) y prácticas de arquitectura evolutiva.</p>
          <div class="info">Se exponen artefactos trazables que evidencian cómo los escenarios BDD conducen, paso a paso, a decisiones arquitectónicas verificables aplicadas a una plataforma de publicaciones científicas.</div>
        </div>

        <div class="card span6">
          <h3>Cómo navegar</h3>
          <ol class="muted">
            <li>Usar las pestañas superiores para acceder a cada fase y artefacto.</li>
            <li>Filtrar tablas con el cuadro de <em>Buscar…</em>.</li>
            <li>Copiar fragmentos Gherkin mediante el botón <em>Copiar</em>.</li>
            <li>Utilizar <em>Imprimir</em> para exportar secciones a PDF.</li>
          </ol>
        </div>

        <div class="card span6">
          <h3>Alcance</h3>
          <p class="muted">Primera iteración: desde requisitos y escenarios clave hasta contratos contract‑first y bitácora ADR inicial. Las decisiones se establecen con una granularidad adecuada para su verificación empírica.</p>
        </div>
      </div>
    </section>

    <!-- MARCO BDMA -->
    <section id="marco"></section>

    <!-- REQUISITOS -->
    <section id="requisitos"></section>

    <!-- BDD -->
    <section id="bdd"></section>

    <!-- FASE 1 -->
    <section id="fase1"></section>

    <!-- FASE 2 -->
    <section id="fase2"></section>

    <!-- FASE 3 -->
    <section id="fase3"></section>

    <!-- FASE 4 -->
    <section id="fase4"></section>

    <!-- FASE 5 -->
    <section id="fase5"></section>
  </main>

  <footer class="wrap">
    <small>BDMA – Sitio de soporte para evaluación. Versión de demostración estática.</small>
  </footer>

  <!-- Modal para mostrar escenarios -->
  <div id="scenarioModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="modalTitle">Escenario BDD</h3>
        <button class="modal-close" onclick="closeScenarioModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="codebar">
          <div id="modalTags"></div>
          <button class="btn" onclick="copyModalContent()">Copiar</button>
        </div>
        <pre><code id="modalContent"></code></pre>
      </div>
    </div>
  </div>

<script>
/* ---------- Data (curada a partir de la Iteración 1) ---------- */
const requisitos = {
  contexto: "Una organización académica internacional quiere desarrollar una plataforma distribuida para la gestión integral de publicaciones científicas en revistas y congresos, abierta a investigadores de todo el mundo. La plataforma debe permitir a autores, revisores, editores y organizadores de eventos interactuar de manera asincrónica y conforme a reglas definidas por políticas editoriales dinámicas, garantizando escalabilidad y evolución controlada.",
  noFunc: [
    "Trazabilidad: escenarios ↔ comandos ↔ eventos ↔ contratos ↔ ADR",
    "Auditabilidad de acciones críticas (login, decisiones, emisiones)",
    "Evolución controlada de políticas y reglas editoriales",
    "Integración segura con proveedores externos (ORCID, Scholar/Scopus, DOI)",
    "Escalabilidad del sistema para equipos distribuidos",
    "Estabilidad general ante cambios en reglas editoriales"
  ],
  funcionales: [
    "Registro y autenticación de investigadores",
    "Perfiles con afiliación institucional, ORCID, áreas de interés y métricas de impacto",
    "Envío de artículos a congresos o revistas científicas",
    "Versionado de envíos y control de fechas límite",
    "Registro de revisores con especialidades",
    "Asignación automática y manual de revisores; revisión ciega simple o doble",
    "Historial de revisiones por artículo",
    "Alta de revistas y eventos; configuración de reglas editoriales versionadas",
    "Administración de editores y comités científicos",
    "Emisión de cartas de aceptación y certificados automáticos",
    "Generación de métricas por autor, artículo, evento y revista",
    "Exportación a formatos estándar (CSV, JSON-LD, XML)",
    "Notificaciones automáticas con resumen mensual personalizado",
    "Sincronización con ORCID, Scopus y Google Scholar",
    "Validación de DOI y metadatos para cada publicación"
  ]
};

const gruposF1 = [
  {id:"G01", nombre:"Identity & Access", proposito:"Alta y autenticación; control de acceso/bloqueo", escenarios:["registro-exitoso","autenticacion-ok","autenticacion-falla","bloqueo"]},
  {id:"G02", nombre:"Profiles", proposito:"Perfil, afiliación, áreas y métricas de impacto", escenarios:["perfil-basico","sincronizacion-metricas"]},
  {id:"G03", nombre:"Submissions", proposito:"Ciclo de vida de envíos y versionado; deadlines", escenarios:["envio-evento","envio-revista","deadline","versionado"]},
  {id:"G04", nombre:"Reviewing", proposito:"Revisores, conflictos, asignación e informes", escenarios:["alta-revisor","conflictos","auto-assign","manual-assign","ceguera-simple","aceptacion","declinacion","entrega","historial"]},
  {id:"G05", nombre:"Editorial Decisioning", proposito:"Cálculo de decisión, cierre y certificados", escenarios:["decision","aceptacion-final"]},
  {id:"G06", nombre:"Venue Management", proposito:"Revistas/eventos, reglas versionadas y roles", escenarios:["alta-revista","alta-evento","versionado-reglas","roles-editoriales"]},
  {id:"G07", nombre:"Metrics & Reporting", proposito:"KPIs, exportaciones y boletines", escenarios:["metricas-autor","metricas-revista","export","boletin"]},
  {id:"G08", nombre:"External Integrations", proposito:"ORCID/Scopus/Scholar y validación de DOI", escenarios:["orcid","scopus-scholar","doi"]}
];

const fase2ComEv = [
  {ctx:"G01 Identity & Access", comandos:["RegistrarCuenta","Autenticar","RegistrarIntentoFallido","BloquearCuenta"], eventos:["CuentaActivada","SesionIniciada","AccesoDenegado","CuentaBloqueada"]},
  {ctx:"G02 Profiles", comandos:["ActualizarPerfil","SincronizarMetricas"], eventos:["PerfilActualizado","MetricasSincronizadas"]},
  {ctx:"G03 Submissions", comandos:["RegistrarEnvioEvento","RegistrarEnvioRevista","ValidarDeadline/IntentarRegistrarEnvio","AdjuntarVersion"], eventos:["EnvioRegistrado","EnvioRechazadoPorDeadline","VersionAdjuntada"]},
  {ctx:"G04 Reviewing", comandos:["RegistrarRevisor","DeclararConflicto","AsignarRevisoresAutomaticamente","AsignarRevisorManual","ConfigurarCeguera","AceptarInvitacion","DeclinarInvitacion","RegistrarRevision","ConsultarHistorial"], eventos:["RevisorRegistrado","ConflictoRegistrado","RevisoresAsignados","RevisorAsignadoManual","InvitacionAceptada","InvitacionDeclinada","RevisionRegistrada"]},
  {ctx:"G05 Editorial Decisioning", comandos:["CalcularDecisionEditorial","EmitirCertificado"], eventos:["DecisionEmitida","CertificadoEmitido","ExpedienteCerrado"]},
  {ctx:"G06 Venue Management", comandos:["CrearRevista","CrearEvento","PublicarReglas","AsignarRolesEditoriales"], eventos:["RevistaCreada","EventoCreado","ReglasPublicadas","RolesAsignados"]},
  {ctx:"G07 Metrics & Reporting", comandos:["GenerarMetricasAutor","GenerarMetricasRevista","ExportarDatos","EnviarBoletin"], eventos:["ReporteGenerado","ExportacionLista","BoletinEnviado"]},
  {ctx:"G08 External Integrations", comandos:["SincronizarORCID","ImportarDesdeScopusScholar","ValidarDOI","ValidarMetadatos"], eventos:["PerfilSincronizado","PublicacionesImportadas","DOIVerificado","MetadatosValidados"]},
];

const bc = [
  {id:"BC01", name:"Identity & Access", resp:"Gestión de identidad, autenticación y autorización"},
  {id:"BC02", name:"Profiles", resp:"Gestión de perfil, afiliación y métricas del investigador"},
  {id:"BC03", name:"Submissions", resp:"Registro y gestión de envíos a revistas o eventos"},
  {id:"BC04", name:"Reviewing", resp:"Gestión de revisores, conflictos, asignaciones y revisiones"},
  {id:"BC05", name:"Editorial Decisioning", resp:"Cálculo/registro de decisiones; cierre/ certificados"},
  {id:"BC06", name:"Venue Management", resp:"Alta de venues; publicación de reglas y roles"},
  {id:"BC07", name:"Metrics & Reporting", resp:"Generación de métricas, reportes y boletines"},
  {id:"BC08", name:"External Integrations", resp:"ORCID/Scholar/Scopus; validación DOI"}
];

const interactions = [
  {from:"BC03", to:"BC04", type:"Event Publisher / Partnership", note:"Al registrar envío"},
  {from:"BC03", to:"BC05", type:"Event Publisher / Partnership", note:"Dispara decisión"},
  {from:"BC04", to:"BC05", type:"Event Publisher", note:"Al cerrar revisiones"},
  {from:"BC05", to:"BC03", type:"Event Subscriber", note:"Marca aceptado/rechazado"},
  {from:"BC06", to:"BC03", type:"OHS + Event Publisher", note:"Reglas publicadas"},
  {from:"BC06", to:"BC04", type:"OHS + Event Publisher", note:"Reglas publicadas"},
  {from:"BC06", to:"BC05", type:"OHS + Event Publisher", note:"Reglas publicadas"},
  {from:"BC08", to:"BC02", type:"ACL", note:"Sync de perfil/métricas"},
  {from:"BC08", to:"BC03", type:"ACL", note:"Validación DOI/Metadatos"}
];

const endpoints = [
  {g:"G01", ctx:"Identity & Access", method:"POST", path:"/auth/register", req:"email, password, orcidId?", res:"userId, estadoCuenta", codes:"201; 400; 409", escenario:"registro-exitoso"},
  {g:"G01", ctx:"Identity & Access", method:"POST", path:"/auth/login", req:"email, password", res:"token, exp, userId", codes:"200; 401", escenario:"autenticacion-ok | autenticacion-falla"},
  {g:"G01", ctx:"Identity & Access", method:"POST", path:"/auth/lockouts/evaluate", req:"userId", res:"locked(bool), reason?", codes:"200; 423", escenario:"bloqueo"},

  {g:"G02", ctx:"Profiles", method:"PUT", path:"/profiles/{researcherId}", req:"nombre, afiliacion, areas[], orcidId?", res:"researcherId, actualizadoAt", codes:"200; 400; 404", escenario:"perfil-basico"},
  {g:"G02", ctx:"Profiles", method:"POST", path:"/profiles/{researcherId}/metrics/sync", req:"fuentes[]", res:"hIndex, citas, fuente, fecha", codes:"200; 424", escenario:"sincronizacion-metricas"},

  {g:"G03", ctx:"Submissions", method:"POST", path:"/venues/{venueId}/submissions", req:"titulo, autores[], archivos[], submittedAt", res:"submissionId, version=1, status", codes:"201; 422", escenario:"envio-evento | deadline"},
  {g:"G03", ctx:"Submissions", method:"POST", path:"/journals/{journalId}/submissions", req:"titulo, autores[], archivos[]", res:"submissionId, version=1, status", codes:"201", escenario:"envio-revista"},
  {g:"G03", ctx:"Submissions", method:"POST", path:"/submissions/{submissionId}/versions", req:"archivos[], notes?", res:"version++, estado", codes:"201; 409", escenario:"versionado"},

  {g:"G04", ctx:"Reviewing", method:"POST", path:"/reviewers", req:"nombre, especialidades[], afiliacion", res:"reviewerId", codes:"201; 400", escenario:"alta-revisor"},
  {g:"G04", ctx:"Reviewing", method:"POST", path:"/reviewers/{reviewerId}/conflicts", req:"submissionId, tipo, descripcion", res:"conflictId, registradoAt", codes:"201; 409", escenario:"conflictos"},
  {g:"G04", ctx:"Reviewing", method:"POST", path:"/submissions/{submissionId}/assignments:auto", req:"nMin, ceguera", res:"assignments[], blindPolicy", codes:"201; 409", escenario:"auto-assign / ceguera-simple"},
  {g:"G04", ctx:"Reviewing", method:"POST", path:"/submissions/{submissionId}/assignments", req:"reviewerId, ceguera?", res:"assignmentId, estado", codes:"201; 409", escenario:"manual-assign"},
  {g:"G04", ctx:"Reviewing", method:"POST", path:"/assignments/{assignmentId}/accept", req:"—", res:"assignmentId, estado=ACEPTADO", codes:"200; 409", escenario:"aceptacion"},
  {g:"G04", ctx:"Reviewing", method:"POST", path:"/assignments/{assignmentId}/decline", req:"motivo?", res:"assignmentId, estado=DECLINADO", codes:"200", escenario:"declinacion"},
  {g:"G04", ctx:"Reviewing", method:"POST", path:"/submissions/{submissionId}/reviews", req:"assignmentId, recomendacion, comentarios", res:"reviewId, registradaAt", codes:"201; 403", escenario:"entrega"},
  {g:"G04", ctx:"Reviewing", method:"GET",  path:"/submissions/{submissionId}/reviews", req:"estado?, reviewerId?", res:"listaReviews[]", codes:"200", escenario:"historial"},

  {g:"G05", ctx:"Editorial Decisioning", method:"POST", path:"/submissions/{submissionId}/decision", req:"decision, notas?", res:"decisionId, quorumOk", codes:"201; 409", escenario:"decision"},
  {g:"G05", ctx:"Editorial Decisioning", method:"POST", path:"/submissions/{submissionId}/acceptance-letter", req:"templateId?, locale?", res:"urlCarta, emitidaAt", codes:"200; 409", escenario:"aceptacion-final"},

  {g:"G06", ctx:"Venue Management", method:"POST", path:"/venues/journals", req:"nombre, scope, politicasIniciales", res:"journalId", codes:"201; 409", escenario:"alta-revista"},
  {g:"G06", ctx:"Venue Management", method:"POST", path:"/venues/conferences", req:"nombre, fechas{...}, politicasIniciales", res:"conferenceId", codes:"201; 409", escenario:"alta-evento"},
  {g:"G06", ctx:"Venue Management", method:"POST", path:"/venues/{venueId}/rulesets", req:"version, reglas{...}, vigencia", res:"rulesetId, version", codes:"201; 409", escenario:"versionado-reglas"},
  {g:"G06", ctx:"Venue Management", method:"POST", path:"/venues/{venueId}/roles", req:"usuarioId, rol", res:"roleId", codes:"201; 404", escenario:"roles-editoriales"},

  {g:"G08", ctx:"External Integrations", method:"POST", path:"/integrations/orcid/sync", req:"researcherId, accessToken", res:"perfil{orcidId,...}, sincronizadoAt", codes:"200; 424", escenario:"orcid"},
  {g:"G08", ctx:"External Integrations", method:"POST", path:"/integrations/scholar-scopus/sync", req:"researcherId", res:"metrics{hIndex,citas}, fuente", codes:"200; 424", escenario:"scopus-scholar"},
  {g:"G08", ctx:"External Integrations", method:"POST", path:"/integrations/doi/validate", req:"doi, metadatos", res:"valido(bool), issues[]", codes:"200; 422", escenario:"doi"}
];

const adrLog = [
  { id:"ADR-000", fecha:"2025-08-11", estado:"Aceptado", texto:"Adoptar la arquitectura resultante de BDMA Fases 1–4 como versión inicial (v1.0)." }
];

const trazabilidad = [
  ["registro-exitoso","BC01","RegistrarCuenta","CuentaActivada","POST /auth/register","ADR-000"],
  ["autenticacion-ok","BC01","Autenticar","SesionIniciada","POST /auth/login","ADR-000"],
  ["autenticacion-falla","BC01","Autenticar","AccesoDenegado","POST /auth/login","ADR-000"],
  ["bloqueo","BC01","BloquearCuenta","CuentaBloqueada","POST /auth/lockouts/evaluate","ADR-000"],
  ["perfil-basico","BC02","ActualizarPerfil","PerfilActualizado","PUT /profiles/{researcherId}","ADR-000"],
  ["sincronizacion-metricas","BC02","SincronizarMetricas","MetricasSincronizadas","POST /profiles/{id}/metrics/sync","ADR-000"],
  ["envio-evento","BC03","RegistrarEnvioEvento","EnvioRegistrado","POST /venues/{venueId}/submissions","ADR-000"],
  ["envio-revista","BC03","RegistrarEnvioRevista","EnvioRegistrado","POST /journals/{journalId}/submissions","ADR-000"],
  ["deadline","BC03","IntentarRegistrarEnvio","EnvioRechazadoPorDeadline","POST /venues/{venueId}/submissions","ADR-000"],
  ["versionado","BC03","AdjuntarVersion","VersionAdjuntada","POST /submissions/{id}/versions","ADR-000"],
  ["alta-revisor","BC04","RegistrarRevisor","RevisorRegistrado","POST /reviewers","ADR-000"],
  ["conflictos","BC04","DeclararConflicto","ConflictoRegistrado","POST /reviewers/{id}/conflicts","ADR-000"],
  ["auto-assign","BC04","AsignarRevisoresAutomaticamente","RevisoresAsignados","POST /submissions/{id}/assignments:auto","ADR-000"],
  ["manual-assign","BC04","AsignarRevisorManual","RevisorAsignadoManual","POST /submissions/{id}/assignments","ADR-000"],
  ["ceguera-simple","BC04","ConfigurarCeguera","(flag aplicado)","POST /submissions/{id}/assignments","ADR-000"],
  ["aceptacion","BC04","AceptarInvitacion","InvitacionAceptada","POST /assignments/{id}/accept","ADR-000"],
  ["declinacion","BC04","DeclinarInvitacion","InvitacionDeclinada","POST /assignments/{id}/decline","ADR-000"],
  ["entrega","BC04","RegistrarRevision","RevisionRegistrada","POST /submissions/{id}/reviews","ADR-000"],
  ["historial","BC04","ConsultarHistorial","—","GET /submissions/{id}/reviews","ADR-000"],
  ["decision","BC05","CalcularDecisionEditorial","DecisionEmitida","POST /submissions/{id}/decision","ADR-000"],
  ["aceptacion-final","BC05","EmitirCertificado","CertificadoEmitido","POST /submissions/{id}/acceptance-letter","ADR-000"],
  ["alta-revista","BC06","CrearRevista","VenueCreado","POST /venues/journals","ADR-000"],
  ["alta-evento","BC06","CrearEvento","EventoCreado","POST /venues/conferences","ADR-000"],
  ["versionado-reglas","BC06","PublicarVersionReglas","ReglasPublicadas","POST /venues/{id}/rulesets","ADR-000"],
  ["roles-editoriales","BC06","AsignarRolEditorial","RolesAsignados","POST /venues/{id}/roles","ADR-000"],
  ["metricas-autor","BC07","GenerarMetricasAutor","ReporteGenerado","GET /reports/authors","ADR-000"],
  ["metricas-revista","BC07","GenerarMetricasRevista","ReporteGenerado","GET /reports/venues","ADR-000"],
  ["export","BC07","GenerarExportacion","ExportacionLista","POST /exports","ADR-000"],
  ["boletin","BC07","EnviarBoletin","BoletinEnviado","POST /digests/monthly","ADR-000"],
  ["orcid","BC08","SincronizarORCID","PerfilSincronizado","POST /integrations/orcid/sync","ADR-000"],
  ["scopus-scholar","BC08","ImportarPublicaciones","PublicacionesImportadas","POST /integrations/scholar-scopus/sync","ADR-000"],
  ["doi","BC08","ValidarDOI","DOIVerificado","POST /integrations/doi/validate","ADR-000"],
];

/* --- BDD snippets (subset curado) --- */
const bddBlocks = [
{ tag:"@registro-exitoso", feature:"Registro y autenticación de investigadores", text:`Feature: Registro y autenticación de investigadores
  Como Investigador
  Quiero registrarme y autenticarme
  Para gestionar mis envíos y revisiones

  @registro-exitoso
  Scenario: Registro exitoso con ORCID y verificación de email
    Given existe el proveedor de identidad "ORCID"
    And no existe una cuenta previa con email "ana@uni.edu"
    When el Investigador se registra con ORCID válido y email "ana@uni.edu"
    And confirma el email recibido
    Then la cuenta "ana@uni.edu" queda en estado "Activa"
    And el perfil se crea con ORCID vinculado`},

{ tag:"@autenticacion-ok", feature:"Registro y autenticación de investigadores", text:`@autenticacion-ok
Scenario: Autenticación exitosa con credenciales válidas
  Given existe la cuenta "ana@uni.edu" en estado "Activa" con password "s3cret!"
  When intenta autenticarse con email "ana@uni.edu" y password "s3cret!"
  Then el acceso es concedido
  And se registra auditoría de inicio de sesión`},

{ tag:"@autenticacion-falla", feature:"Registro y autenticación de investigadores", text:`@autenticacion-falla
Scenario: Autenticación rechazada por contraseña incorrecta
  Given existe la cuenta "ana@uni.edu" en estado "Activa" con password "s3cret!"
  When intenta autenticarse con email "ana@uni.edu" y password "wrong"
  Then el acceso es denegado por credenciales inválidas`},

{ tag:"@bloqueo", feature:"Registro y autenticación de investigadores", text:`@bloqueo
Scenario: Bloqueo por múltiples intentos fallidos
  Given existe la cuenta "mike@uni.edu" en estado "Activa" con password "pass"
  When intenta autenticarse 5 veces con password incorrecto
  Then la cuenta "mike@uni.edu" queda en estado "Bloqueada"
  And se notifica al usuario por email`},

{ tag:"@perfil-basico", feature:"Gestión de perfil de investigador", text:`Feature: Gestión de perfil de investigador
  Como Investigador
  Quiero mantener mi perfil con afiliación, áreas y métricas
  Para facilitar asignaciones y reportes

  @perfil-basico
  Scenario: Completar afiliación y áreas de interés
    Given el Investigador "Ana" tiene un perfil inicial sin afiliación ni áreas
    When actualiza afiliación a "Universidad X" y áreas ["IA", "NLP"]
    Then el perfil de "Ana" muestra afiliación "Universidad X" y áreas ["IA", "NLP"]`},

{ tag:"@sincronizacion-metricas", feature:"Gestión de perfil de investigador", text:`@sincronizacion-metricas
Scenario: Importar métricas desde ORCID/Google Scholar
  Given el perfil "Ana" tiene ORCID vinculado
  When sincroniza métricas de citaciones e índice-h desde "Google Scholar"
  Then el perfil exhibe métricas actualizadas con fuente "Google Scholar" y fecha de actualización`},

{ tag:"@envio-evento", feature:"Envío y versionado de artículos", text:`Feature: Envío y versionado de artículos
  Como Autor
  Quiero enviar y versionar artículos
  Para postular a revistas y conferencias respetando deadlines

  @envio-evento
  Scenario: Envío válido a evento antes del deadline
    Given existe el Evento "IC-2026" con fecha límite de envío "2026-05-01"
    And soy Autor con perfil completo
    When envío el Artículo "A-101" a "IC-2026" en fecha "2026-04-20"
    Then se registra el Envío "E-1" en estado "Enviado" con versión 1
    And recibo comprobante de envío con sello de tiempo`},

{ tag:"@envio-revista", feature:"Envío y versionado de artículos", text:`@envio-revista
Scenario: Envío válido a revista con revisión doble ciego
  Given existe la Revista "SJ-ML" con tipo de revisión "Doble ciego"
  And soy Autor con perfil completo
  When envío el Artículo "A-202" a "SJ-ML" en fecha "2026-03-10"
  Then se registra el Envío "E-2" en estado "Enviado" con versión 1
  And se verifica que el archivo no contenga datos identificatorios`},

{ tag:"@deadline", feature:"Envío y versionado de artículos", text:`@deadline
Scenario: Rechazo por envío fuera de fecha
  Given existe el Evento "IC-2026" con fecha límite de envío "2026-05-01"
  And soy Autor con perfil completo
  When envío el Artículo "A-102" a "IC-2026" en fecha "2026-05-10"
  Then el sistema rechaza el envío por deadline excedido con motivo "Fecha límite superada"`},

{ tag:"@versionado", feature:"Envío y versionado de artículos", text:`@versionado
Scenario: Nuevo versionado de un envío en curso
  Given existe el Envío "E-1" del Artículo "A-101" en estado "Enviado" y versión 1
  When adjunto una nueva versión con cambios menores
  Then el Envío "E-1" queda en versión 2
  And el historial conserva versiones [1, 2]`},

{ tag:"@alta-revisor", feature:"Registro de revisores y especialidades", text:`Feature: Registro de revisores y especialidades
  Como Revisor
  Quiero registrar mis especialidades y conflictos
  Para recibir asignaciones apropiadas

  @alta-revisor
  Scenario: Registro de revisor con especialidades
    Given no existe el Revisor "r1"
    When registro al Revisor "r1" con especialidades ["IA", "NLP"]
    Then el Revisor "r1" queda "Activo" con especialidades ["IA", "NLP"]`},

{ tag:"@conflictos", feature:"Registro de revisores y especialidades", text:`@conflictos
Scenario: Declaración de conflicto de interés
  Given el Revisor "r1" está "Activo"
  When declara conflicto con el Autor "Ana" por coautoría reciente
  Then el conflicto queda registrado y bloquea asignaciones con "Ana" por 2 años`},

{ tag:"@auto-assign", feature:"Asignación de revisores y manejo de ceguera", text:`Feature: Asignación de revisores y manejo de ceguera
  Como Editor
  Quiero asignar revisores automáticamente o manualmente
  Para iniciar la evaluación cumpliendo reglas y anonimato

  @auto-assign
  Scenario: Asignación automática según especialidad y conflictos
    Given existe el Envío "E-1" con tema "NLP"
    And candidatos Revisores ["r1:IA", "r2:SE", "r3:NLP", "r4:IA"]
    And el Revisor "r2" tiene conflicto con el Autor de "E-1"
    And las reglas editoriales exigen "3" revisores
    When ejecuto la asignación automática para "E-1"
    Then quedan asignados 3 revisores especialistas sin conflictos
    And el Autor no ve las identidades de los revisores
    And los Revisores no ven la identidad ni afiliación del Autor`},

{ tag:"@manual-assign", feature:"Asignación de revisores y manejo de ceguera", text:`@manual-assign
Scenario: Asignación manual con validación de conflictos
  Given existe el Envío "E-1" pendiente de asignación
  And el Editor selecciona "r2", "r3" y "r4"
  When confirma la asignación manual
  Then el sistema impide asignar "r2" por conflicto registrado
  And propone candidatos alternativos compatibles`},

{ tag:"@ceguera-simple", feature:"Asignación de revisores y manejo de ceguera", text:`@ceguera-simple
Scenario: Aplicación de ceguera simple en revista configurada
  Given la Revista "SJ-DS" tiene tipo de revisión "Ciego simple"
  And existe el Envío "E-3" a "SJ-DS"
  When asigno revisores para "E-3"
  Then los Revisores no ven la identidad del Autor
  And el Autor puede ver las identidades de los Revisores solo después de la decisión final`},

{ tag:"@aceptacion", feature:"Ciclo de revisión por pares", text:`Feature: Ciclo de revisión por pares
  Como Revisor
  Quiero aceptar/declinar invitaciones y cargar evaluaciones
  Para contribuir a la decisión editorial

  @aceptacion
  Scenario: Revisor acepta invitación
    Given el Revisor "r3" fue invitado a revisar el Envío "E-1"
    When "r3" acepta la invitación dentro de 3 días
    Then la asignación de "r3" pasa a estado "Aceptada"
    And se habilita el formulario de revisión`},

{ tag:"@declinacion", feature:"Ciclo de revisión por pares", text:`@declinacion
Scenario: Revisor declina por conflicto sobrevenido
  Given el Revisor "r3" fue invitado a revisar el Envío "E-1"
  When "r3" declara conflicto y declina la invitación
  Then su asignación pasa a "Declinada"
  And se notifica al Editor para reasignación`},

{ tag:"@entrega", feature:"Ciclo de revisión por pares", text:`@entrega
Scenario: Entrega de revisión con recomendación
  Given el Revisor "r3" tiene asignación "Aceptada" sobre "E-1"
  When envía su revisión con recomendación "Mayor revisión"
  Then la revisión queda registrada con sello de tiempo y versión
  And el historial del Envío "E-1" muestra la revisión de "r3"`},

{ tag:"@historial", feature:"Ciclo de revisión por pares", text:`@historial
Scenario: Consulta del historial completo de revisiones por artículo
  Given existen revisiones de "r1", "r3" y "r4" para el Envío "E-1"
  When consulto el historial de revisiones de "E-1"
  Then veo todas las revisiones con autores anónimos, fechas y recomendaciones`},

{ tag:"@decision", feature:"Decisión editorial y comunicaciones", text:`Feature: Decisión editorial y comunicaciones
  Como Editor
  Quiero emitir decisiones y cartas
  Para cerrar el proceso conforme a reglas

  @decision
  Scenario: Emisión de decisión basada en reglas y quorum
    Given el Envío "E-1" tiene 3 revisiones con recomendaciones ["Aceptación", "Mayor revisión", "Aceptación"]
    And las reglas exigen minRevisiones=3, quorum="2 de 3", umbral=">=Aceptación"
    When calculo la decisión editorial para "E-1"
    Then la decisión es "Aceptado condicional"
    And se genera carta de decisión con condiciones y plantilla aprobada`},

{ tag:"@aceptacion-final", feature:"Decisión editorial y comunicaciones", text:`@aceptacion-final
Scenario: Emisión de certificado tras aceptación final
  Given el Envío "E-1" está en estado "Aceptado"
  And el Autor subió la versión final y transfirió copyright
  When cierro el expediente editorial
  Then se emite certificado de aceptación para el Autor
  And se programa la publicación con fecha estimada`},

{ tag:"@metricas-autor", feature:"Gestión de métricas e informes", text:`Feature: Gestión de métricas e informes
  Como Analista
  Quiero generar métricas y exportarlas
  Para seguimiento por autor, artículo, evento y revista

  @metricas-autor
  Scenario: Métricas por autor y evento
    Given existen envíos y decisiones históricas
    When genero métricas para el Autor "Ana" en el Evento "IC-2026"
    Then obtengo métricas {envios:2, aceptados:1, tasaAceptacion:"50%"} con periodo consultado`},

{ tag:"@metricas-revista", feature:"Gestión de métricas e informes", text:`@metricas-revista
Scenario: Métricas por revista
  Given existen decisiones en la Revista "SJ-ML" durante 2026
  When genero el informe de tasa de aceptación mensual para "SJ-ML"
  Then obtengo una serie temporal con aceptación, tiempos de revisión y desviación estándar`},

{ tag:"@export", feature:"Gestión de métricas e informes", text:`@export
Scenario Outline: Exportación de reportes a formatos estándar
  Given existe un reporte consolidado "R-1"
  When exporto el reporte "R-1" en formato "<formato>"
  Then descargo un archivo con extensión "<extension>" y esquema válido

  Examples:
    | formato | extension |
    | CSV     | .csv      |
    | JSON-LD | .jsonld   |
    | XML     | .xml      |`},

{ tag:"@boletin", feature:"Gestión de métricas e informes", text:`@boletin
Scenario: Envío de notificación mensual personalizada
  Given el Autor "Ana" está suscripto al resumen mensual
  And existen métricas del último mes para "Ana"
  When corre el job mensual
  Then se envía un email a "Ana" con su resumen y enlaces a detalles`},

{ tag:"@orcid", feature:"Integraciones externas y validación de metadatos", text:`Feature: Integraciones externas y validación de metadatos
  Como Sistema
  Quiero sincronizar perfiles y validar metadatos
  Para mantener calidad e interoperabilidad

  @orcid
  Scenario: Sincronización de datos de perfil desde ORCID
    Given el perfil "Ana" tiene ORCID vinculado
    And existen cambios en ORCID para nombre y afiliación
    When sincronizo datos desde ORCID
    Then el perfil se actualiza preservando cambios locales confirmados
    And se registra la fuente y fecha de sincronización`},

{ tag:"@scopus-scholar", feature:"Integraciones externas y validación de metadatos", text:`@scopus-scholar
Scenario: Importación de publicaciones desde Scopus y Google Scholar
  Given el perfil "Ana" tiene identificadores válidos en Scopus y Google Scholar
  When importo sus publicaciones recientes
  Then las nuevas publicaciones se agregan como referencias con deduplicación por DOI`},

{ tag:"@doi", feature:"Integraciones externas y validación de metadatos", text:`@doi
Scenario: Validación de DOI y metadatos al registrar versión final
  Given el Envío "E-1" está en versión final con DOI "10.1000/xyz123"
  And los metadatos requeridos son {titulo, autores, afiliaciones, resumen, palabrasClave}
  When valido el DOI y los metadatos
  Then el DOI queda marcado "Válido" y los metadatos "Completos"
  And el registro queda listo para indexación`}
];

/* ---------- UI helpers ---------- */
const tabs = [
  {id:"intro", label:"Resumen"},
  {id:"marco", label:"Marco BDMA"},
  {id:"requisitos", label:"Requisitos"},
  {id:"bdd", label:"Escenarios BDD"},
  {id:"fase1", label:"Fase 1"},
  {id:"fase2", label:"Fase 2"},
  {id:"fase3", label:"Fase 3"},
  {id:"fase4", label:"Fase 4"},
  {id:"fase5", label:"Fase 5"}
];

function mountTabs(){
  const nav = document.getElementById('tabs');
  tabs.forEach(t => {
    const b=document.createElement('button'); b.textContent=t.label;
    b.onclick=()=>activate(t.id);
    if(t.id==='intro') b.classList.add('active');
    nav.appendChild(b);
  });
}

function activate(id){
  document.querySelectorAll('nav button').forEach(b => b.classList.toggle('active', b.textContent===tabs.find(t=>t.id===id).label));
  document.querySelectorAll('main section').forEach(s => s.classList.toggle('active', s.id===id));
  if(id==='fase3') setTimeout(drawEdges, 0);
}

function makeControls(onSearch){
  const div = document.createElement('div'); div.className='controls';
  const left = document.createElement('div'); left.className='search';
  const input=document.createElement('input'); input.placeholder='Buscar…'; input.oninput=(e)=>onSearch(e.target.value.trim().toLowerCase());
  left.append('🔎', input);
  const right = document.createElement('div');
  const btn=document.createElement('button'); btn.className='btn'; btn.textContent='Imprimir / PDF'; btn.onclick=()=>print();
  right.append(btn);
  div.append(left,right);
  return div;
}

function renderMarco(){
  const sec=document.getElementById('marco'); sec.innerHTML='';
  
  // Propósito y principios
  const grid1=document.createElement('div'); grid1.className='grid fase-section';
  
  const proposito=document.createElement('div'); proposito.className='card';
  proposito.innerHTML=`
    <h3>Propósito del Marco BDMA</h3>
    <p class="muted">Proveer un marco metodológico sistemático y reproducible que guíe la identificación, diseño y evolución de arquitecturas de microservicios en contextos ágiles greenfield, a partir de la transformación iterativa y trazable de escenarios funcionales BDD en bounded contexts, contratos de servicio e interfaces verificables.</p>
    <p class="muted">BDMA integra principios de Domain-Driven Design (DDD), técnicas de Behavior-Driven Development (BDD) y prácticas de arquitectura evolutiva, con el objetivo de alinear continuamente la especificación funcional del sistema con su arquitectura técnica.</p>
  `;
  
  const principios=document.createElement('div'); principios.className='card';
  principios.innerHTML=`
    <h3>Principios Fundamentales</h3>
    <ul class="muted">
      <li><strong>Trazabilidad total:</strong> Cada servicio implementado debe poder rastrearse hasta uno o más escenarios BDD.</li>
      <li><strong>Arquitectura emergente y evolutiva:</strong> El diseño se adapta iterativamente a la evolución de los escenarios.</li>
      <li><strong>Diseño colaborativo:</strong> Las decisiones arquitectónicas se validan con expertos de dominio y técnicos.</li>
      <li><strong>Lenguaje ubicuo:</strong> El vocabulario de los escenarios permea contratos y artefactos de diseño.</li>
      <li><strong>Evidencia funcional continua:</strong> Las pruebas BDD son la validación activa de la arquitectura.</li>
    </ul>
  `;
  
  grid1.append(proposito, principios);
  sec.appendChild(grid1);
  
  // Diferencial metodológico
  const diferencial=document.createElement('div'); diferencial.className='card fase-section';
  diferencial.innerHTML=`
    <h3>Aporte: Diferencial Metodológico</h3>
    <p class="muted">BDMA es un método iterativo que transforma requisitos funcionales en decisiones arquitectónicas verificables. A diferencia de enfoques previos, que suelen ser teóricos o centrados en contextos brownfield, BDMA:</p>
    <div class="kpi">
      <span class="pill">Define artefactos intermedios claros</span>
      <span class="pill">Establece un flujo de fases aplicable en entornos ágiles reales</span>
      <span class="pill">Garantiza trazabilidad y validación continua</span>
      <span class="pill">Enfoque greenfield orientado a la práctica</span>
    </div>
    <div class="info">El marco no genera los escenarios BDD, sino que parte de un backlog funcional ya redactado y validado.</div>
  `;
  sec.appendChild(diferencial);
  
  // Proceso por fases
  const proceso=document.createElement('div'); proceso.className='card fase-section';
  proceso.innerHTML=`
    <h3>Proceso Estructurado en 5 Fases</h3>
    <table style="margin-top: 12px;">
      <thead>
        <tr><th>Fase</th><th>Concepto</th><th>Objetivo</th></tr>
      </thead>
      <tbody>
        <tr>
          <td><strong>Fase 1</strong><br>Clasificación funcional</td>
          <td>Arquitectura evolutiva alineada a features/epics</td>
          <td>Organizar escenarios BDD en agrupaciones coherentes</td>
        </tr>
        <tr>
          <td><strong>Fase 2</strong><br>Extracción de dominio</td>
          <td>BDD para describir comportamiento y extraer elementos</td>
          <td>Identificar actores, comandos, eventos y entidades</td>
        </tr>
        <tr>
          <td><strong>Fase 3</strong><br>Bounded contexts</td>
          <td>Context Map, delimitación DDD</td>
          <td>Agrupar elementos en contextos coherentes y delimitados</td>
        </tr>
        <tr>
          <td><strong>Fase 4</strong><br>Contratos API</td>
          <td>Diseño contract-first y patrones de testabilidad</td>
          <td>Traducir comandos/eventos en contratos verificables</td>
        </tr>
        <tr>
          <td><strong>Fase 5</strong><br>Validación continua</td>
          <td>ADR y evolución estructural</td>
          <td>Garantizar evolución sincronizada y trazabilidad</td>
        </tr>
      </tbody>
    </table>
  `;
  sec.appendChild(proceso);
  
  // Integración ágil
  const agil=document.createElement('div'); agil.className='card fase-section';
  agil.innerHTML=`
    <h3>Integración con Ciclo Ágil</h3>
    <p class="muted">BDMA no propone un enfoque secuencial cerrado, sino un marco que se integra incrementalmente al ciclo de vida ágil. En cada iteración (Sprint), se aplican las fases únicamente sobre los escenarios funcionales priorizados.</p>
    <table style="margin-top: 12px;">
      <thead>
        <tr><th>Etapa del Sprint</th><th>Fase BDMA</th><th>Actividad</th></tr>
      </thead>
      <tbody>
        <tr><td>Refinamiento del backlog</td><td>Fase 1</td><td>Agrupar nuevos escenarios BDD por feature/epic</td></tr>
        <tr><td>Inicio del Sprint</td><td>Fase 2</td><td>Analizar escenarios priorizados, identificar comandos/eventos</td></tr>
        <tr><td>Diseño técnico inicial</td><td>Fase 3</td><td>Ajustar límites de contextos si hay cambios relevantes</td></tr>
        <tr><td>Implementación</td><td>Fase 4</td><td>Derivar contratos desde nuevos escenarios</td></tr>
        <tr><td>Durante el Sprint</td><td>Fase 5</td><td>Ejecutar pruebas BDD, detectar impactos, registrar ADRs</td></tr>
        <tr><td>Cierre/Revisión</td><td>Consolidación</td><td>Validar arquitectura, versionar Context Map</td></tr>
      </tbody>
    </table>
  `;
  sec.appendChild(agil);
}

function renderRequisitos(){
  const sec=document.getElementById('requisitos'); sec.innerHTML='';
  const grid=document.createElement('div'); grid.className='grid fase-section';

  const c1=document.createElement('div'); c1.className='card span6';
  c1.innerHTML=`<h3>Requisitos funcionales</h3>
    <p class="muted">${requisitos.contexto}</p>
    <ul class="muted">${requisitos.funcionales.map(x=>`<li>${x}</li>`).join('')}</ul>`;

  const c2=document.createElement('div'); c2.className='card span6';
  c2.innerHTML=`<h3>Requisitos no funcionales</h3>
    <ul class="muted">${requisitos.noFunc.map(x=>`<li>${x}</li>`).join('')}</ul>`;

  grid.append(c1,c2);
  sec.appendChild(grid);
}

function renderBDD(){
  const sec=document.getElementById('bdd'); sec.innerHTML='';
  const title=document.createElement('div'); title.className='card fase-section';
  title.innerHTML='<h3>Escenarios clave (Gherkin)</h3><p class="muted">Fragmentos listos para copiar y pegar en suites de pruebas BDD.</p>';
  sec.appendChild(title);

  bddBlocks.forEach(b=>{
    const c=document.createElement('div'); c.className='card fase-section';
    const bar=document.createElement('div'); bar.className='codebar';
    bar.innerHTML=`<div><span class="tag">${b.feature}</span> <span class="tag">${b.tag}</span></div>`;
    const copy=document.createElement('button'); copy.className='btn'; copy.textContent='Copiar';
    copy.onclick=()=>navigator.clipboard.writeText(b.text);
    bar.appendChild(copy);
    c.appendChild(bar);
    const pre=document.createElement('pre'); pre.innerHTML=`<code>${escapeHtml(b.text)}</code>`;
    c.appendChild(pre);
    sec.appendChild(c);
  });
}

function renderFase1(){
  const sec=document.getElementById('fase1'); sec.innerHTML='';
  
  // Descripción del marco
  const descripcion=document.createElement('div'); descripcion.className='card fase-section';
  descripcion.innerHTML=`
    <h3>Fase 1 · Clasificación funcional de escenarios</h3>
    <p class="muted"><strong>Objetivo:</strong> Organizar el backlog funcional —especificado mediante escenarios BDD validados— en agrupaciones coherentes que representen funcionalidades, procesos de negocio o epics. Esta organización inicial sirve como insumo para la delimitación de bounded contexts en fases posteriores.</p>
  `;
  sec.appendChild(descripcion);
  
  // Entradas y Salidas
  const grid1=document.createElement('div'); grid1.className='grid fase-section';
  
  const entradas=document.createElement('div'); entradas.className='card span6';
  entradas.innerHTML=`
    <h3>📥 Entradas</h3>
    <ul class="muted">
      <li>Backlog funcional expresado en escenarios BDD redactados con lenguaje Gherkin (Given-When-Then)</li>
      <li>Metainformación opcional sobre los escenarios (tags, epics, user stories asociadas)</li>
    </ul>
  `;
  
  const salidas=document.createElement('div'); salidas.className='card span6';
  salidas.innerHTML=`
    <h3>📤 Salidas</h3>
    <ul class="muted">
      <li>Grupos funcionales de escenarios candidatos a bounded contexts iniciales</li>
      <li>Tabla de trazabilidad: Epic/proceso → Escenario BDD → Notas</li>
    </ul>
  `;
  
  grid1.append(entradas, salidas);
  sec.appendChild(grid1);
  
  // Artefactos esperados
  const artefactos=document.createElement('div'); artefactos.className='card fase-section';
  artefactos.innerHTML=`
    <h3>🎯 Artefactos Generados</h3>
    <p class="muted"><strong>Mapa de agrupamiento funcional</strong> con estructura:</p>
    <ul class="muted">
      <li><strong>Nombre del grupo:</strong> Identificación del área funcional</li>
      <li><strong>Escenarios asociados:</strong> Lista de escenarios BDD relacionados</li>
      <li><strong>Actor principal:</strong> Rol que ejecuta las acciones</li>
      <li><strong>Eventos clave:</strong> Eventos de dominio identificados</li>
      <li><strong>Notas:</strong> Observaciones sobre cohesión y separación de contextos</li>
    </ul>
  `;
  sec.appendChild(artefactos);
  
  // Implementación práctica
  const implementacion=document.createElement('div'); implementacion.className='card fase-section';
  implementacion.innerHTML='<h3>🔧 Implementación: Mapa de Agrupamiento Funcional</h3><p class="muted">Estructura según el marco BDMA:</p>';
  const controls = makeControls(filter);
  const table=document.createElement('table');
  table.innerHTML=`<thead><tr><th>Nombre del Grupo</th><th>Escenarios Asociados</th><th>Actor Principal</th><th>Eventos Clave</th><th>Notas</th></tr></thead><tbody></tbody>`;
  const tbody=table.querySelector('tbody');
  
  // Datos estructurados según el marco BDMA
  const mapaAgrupamiento = [
    {
      nombre: "Identity & Access",
      escenarios: ["registro-exitoso", "autenticacion-ok", "autenticacion-falla", "bloqueo"],
      actor: "Investigador",
      eventos: ["CuentaActivada", "SesionIniciada", "AccesoDenegado", "CuentaBloqueada"],
      notas: "Procesos altamente cohesionados; se sugiere como contexto separado"
    },
    {
      nombre: "Profiles",
      escenarios: ["perfil-basico", "sincronizacion-metricas"],
      actor: "Investigador",
      eventos: ["PerfilActualizado", "MetricasSincronizadas"],
      notas: "Gestión de datos del usuario; candidato a contexto independiente"
    },
    {
      nombre: "Submissions",
      escenarios: ["envio-evento", "envio-revista", "deadline", "versionado"],
      actor: "Autor",
      eventos: ["EnvioRegistrado", "EnvioRechazadoPorDeadline", "VersionAdjuntada"],
      notas: "Core business; alta complejidad; contexto crítico independiente"
    },
    {
      nombre: "Reviewing",
      escenarios: ["alta-revisor", "conflictos", "auto-assign", "manual-assign", "ceguera-simple", "aceptacion", "declinacion", "entrega", "historial"],
      actor: "Revisor / Editor",
      eventos: ["RevisorRegistrado", "ConflictoRegistrado", "RevisoresAsignados", "InvitacionAceptada", "RevisionRegistrada"],
      notas: "Proceso complejo con múltiples actores; requiere contexto independiente"
    },
    {
      nombre: "Editorial Decisioning",
      escenarios: ["decision", "aceptacion-final"],
      actor: "Editor",
      eventos: ["DecisionEmitida", "CertificadoEmitido", "ExpedienteCerrado"],
      notas: "Proceso crítico de negocio; separación clara de responsabilidades"
    },
    {
      nombre: "Venue Management",
      escenarios: ["alta-revista", "alta-evento", "versionado-reglas", "roles-editoriales"],
      actor: "Administrador Editorial",
      eventos: ["RevistaCreada", "EventoCreado", "ReglasPublicadas", "RolesAsignados"],
      notas: "Configuración y administración; contexto de soporte independiente"
    },
    {
      nombre: "Metrics & Reporting",
      escenarios: ["metricas-autor", "metricas-revista", "export", "boletin"],
      actor: "Analista",
      eventos: ["ReporteGenerado", "ExportacionLista", "BoletinEnviado"],
      notas: "Funcionalidad transversal; puede ser contexto de soporte"
    },
    {
      nombre: "External Integrations",
      escenarios: ["orcid", "scopus-scholar", "doi"],
      actor: "Sistema",
      eventos: ["PerfilSincronizado", "PublicacionesImportadas", "DOIVerificado"],
      notas: "Integraciones externas; contexto de infraestructura separado"
    }
  ];

  // Función auxiliar para crear links de escenarios
  function createScenarioLinks(escenarios) {
    return escenarios.map(escenario => {
      // Verificar si el escenario existe en bddBlocks
      const exists = bddBlocks.some(b => b.tag === `@${escenario}`);
      if (exists) {
        return `<span class="scenario-link" onclick="openScenarioModal('${escenario}')">${escenario}</span>`;
      } else {
        return `<span class="muted">${escenario}</span>`;
      }
    }).join(', ');
  }

  // Función auxiliar para múltiples escenarios separados por coma o espacios
  function createMultipleScenarioLinks(escenarioString) {
    if (!escenarioString) return '';
    const escenarios = escenarioString.split(/[,\s]+/).map(s => s.trim()).filter(s => s);
    return createScenarioLinks(escenarios);
  }

  mapaAgrupamiento.forEach(grupo=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><strong>${grupo.nombre}</strong></td>
      <td>${createScenarioLinks(grupo.escenarios)}</td>
      <td>${grupo.actor}</td>
      <td>${grupo.eventos.join(', ')}</td>
      <td class="muted">${grupo.notas}</td>
    `;
    tbody.appendChild(tr);
  });
  
  function filter(q){ [...tbody.children].forEach(tr=>{
    tr.style.display = tr.textContent.toLowerCase().includes(q) ? '' : 'none';
  });}
  implementacion.append(controls, table);
  sec.appendChild(implementacion);
  
  // Conclusiones
  const conclusiones=document.createElement('div'); conclusiones.className='card fase-section';
  conclusiones.innerHTML=`
    <h3>📋 Resultado de la Fase 1</h3>
    <div class="info">
      Se identificaron <strong>8 grupos funcionales</strong> coherentes que representan áreas de responsabilidad bien delimitadas. 
      Cada grupo muestra alta cohesión interna en sus escenarios y separación clara de responsabilidades con otros grupos, 
      siendo candidatos naturales para evolucionar hacia bounded contexts independientes en la Fase 3.
    </div>
  `;
  sec.appendChild(conclusiones);
}

function renderFase2(){
  const sec=document.getElementById('fase2'); sec.innerHTML='';
  
  // Descripción del marco
  const descripcion=document.createElement('div'); descripcion.className='card fase-section';
  descripcion.innerHTML=`
    <h3>Fase 2 · Extracción colaborativa de elementos del dominio</h3>
    <p class="muted"><strong>Objetivo:</strong> Identificar, desde los escenarios BDD agrupados, los actores, comandos, eventos y entidades que estructuran el dominio funcional. Esta extracción es la base para construir bounded contexts significativos y modelos de dominio consistentes.</p>
  `;
  sec.appendChild(descripcion);
  
  // Entradas y Salidas
  const grid1=document.createElement('div'); grid1.className='grid fase-section';
  
  const entradas=document.createElement('div'); entradas.className='card span6';
  entradas.innerHTML=`
    <h3>📥 Entradas</h3>
    <ul class="muted">
      <li>Escenarios BDD organizados por agrupamientos funcionales (salida de Fase 1)</li>
      <li>Mapa funcional preliminar con tags de features, epics o procesos</li>
      <li>Conocimiento contextual del negocio (proporcionado por PO o expertos)</li>
    </ul>
  `;
  
  const salidas=document.createElement('div'); salidas.className='card span6';
  salidas.innerHTML=`
    <h3>📤 Salidas</h3>
    <ul class="muted">
      <li>Lista de comandos y eventos por contexto funcional</li>
      <li>Mapa preliminar de relaciones entre entidades</li>
      <li>Tabla de trazabilidad: escenario → comando, evento o actor</li>
    </ul>
  `;
  
  grid1.append(entradas, salidas);
  sec.appendChild(grid1);
  
  // Artefactos esperados
  const artefactos=document.createElement('div'); artefactos.className='card fase-section';
  artefactos.innerHTML=`
    <h3>🎯 Artefactos Generados</h3>
    <p class="muted"><strong>Mapa de elementos del dominio por escenario</strong> con estructura:</p>
    <ul class="muted">
      <li><strong>Grupo funcional:</strong> Área de responsabilidad identificada en Fase 1</li>
      <li><strong>Escenario:</strong> Escenario BDD específico analizado</li>
      <li><strong>Actor:</strong> Rol que ejecuta la acción (extraído de Given/When)</li>
      <li><strong>Comando:</strong> Acción o intención del usuario (extraído de When)</li>
      <li><strong>Evento:</strong> Resultado o consecuencia (extraído de Then)</li>
      <li><strong>Entidades:</strong> Objetos de dominio mencionados (extraído de Given)</li>
    </ul>
  `;
  sec.appendChild(artefactos);
  
  // Implementación práctica
  const implementacion=document.createElement('div'); implementacion.className='card fase-section';
  implementacion.innerHTML='<h3>🔧 Implementación: Mapa de Elementos del Dominio por Escenario</h3><p class="muted">Estructura según el marco BDMA:</p>';
  const controls = makeControls(filter);
  const table=document.createElement('table');
  table.innerHTML=`<thead><tr><th>Grupo Funcional</th><th>Escenario</th><th>Actor</th><th>Comando (When)</th><th>Evento (Then)</th><th>Entidades (Given)</th></tr></thead><tbody></tbody>`;
  const tbody=table.querySelector('tbody');
  
  // Datos estructurados según el marco BDMA - muestra de elementos clave
  const mapaElementos = [
    {
      grupo: "Identity & Access",
      escenario: "registro-exitoso",
      actor: "Investigador",
      comando: "RegistrarCuenta",
      evento: "CuentaActivada",
      entidades: "Proveedor ORCID, Cuenta, Email"
    },
    {
      grupo: "Identity & Access",
      escenario: "autenticacion-ok",
      actor: "Investigador",
      comando: "Autenticar",
      evento: "SesionIniciada",
      entidades: "Cuenta, Credenciales, Sesion"
    },
    {
      grupo: "Profiles",
      escenario: "perfil-basico",
      actor: "Investigador",
      comando: "ActualizarPerfil",
      evento: "PerfilActualizado",
      entidades: "Perfil, Afiliacion, Areas"
    },
    {
      grupo: "Submissions",
      escenario: "envio-evento",
      actor: "Autor",
      comando: "RegistrarEnvioEvento",
      evento: "EnvioRegistrado",
      entidades: "Evento, Articulo, Deadline"
    },
    {
      grupo: "Reviewing",
      escenario: "auto-assign",
      actor: "Editor",
      comando: "AsignarRevisoresAutomaticamente",
      evento: "RevisoresAsignados",
      entidades: "Envio, Revisor, Especialidad, Conflicto"
    },
    {
      grupo: "Editorial Decisioning",
      escenario: "decision",
      actor: "Editor",
      comando: "CalcularDecisionEditorial",
      evento: "DecisionEmitida",
      entidades: "Revision, Regla, Quorum"
    },
    {
      grupo: "Venue Management",
      escenario: "alta-revista",
      actor: "Administrador Editorial",
      comando: "CrearRevista",
      evento: "RevistaCreada",
      entidades: "Revista, Politicas, Reglas"
    },
    {
      grupo: "External Integrations",
      escenario: "orcid",
      actor: "Sistema",
      comando: "SincronizarORCID",
      evento: "PerfilSincronizado",
      entidades: "ORCID, AccessToken, Perfil"
    }
  ];

  mapaElementos.forEach(elem=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><strong>${elem.grupo}</strong></td>
      <td><span class="scenario-link" onclick="openScenarioModal('${elem.escenario}')">${elem.escenario}</span></td>
      <td>${elem.actor}</td>
      <td><strong>${elem.comando}</strong></td>
      <td><em>${elem.evento}</em></td>
      <td class="muted">${elem.entidades}</td>
    `;
    tbody.appendChild(tr);
  });
  
  function filter(q){ [...tbody.children].forEach(tr=>tr.style.display = tr.textContent.toLowerCase().includes(q) ? '' : 'none'); }
  implementacion.append(controls, table);
  sec.appendChild(implementacion);
  
  // Análisis de extracción
  const analisis=document.createElement('div'); analisis.className='card fase-section';
  analisis.innerHTML=`
    <h3>📊 Análisis de Extracción de Elementos</h3>
    <div class="grid">
      <div class="card span6">
        <h4>Comandos Identificados</h4>
        <div class="kpi">
          <span class="pill">35+ comandos únicos</span>
          <span class="pill">Verbos de acción claros</span>
          <span class="pill">Mapeo directo desde When</span>
        </div>
      </div>
      <div class="card span6">
        <h4>Eventos de Dominio</h4>
        <div class="kpi">
          <span class="pill">28+ eventos identificados</span>
          <span class="pill">Nomenclatura consistente</span>
          <span class="pill">Mapeo directo desde Then</span>
        </div>
      </div>
    </div>
  `;
  sec.appendChild(analisis);
  
  // Conclusiones
  const conclusiones=document.createElement('div'); conclusiones.className='card fase-section';
  conclusiones.innerHTML=`
    <h3>📋 Resultado de la Fase 2</h3>
    <div class="info">
      Se extrajeron exitosamente <strong>comandos y eventos</strong> de cada contexto funcional, estableciendo un vocabulario 
      ubicuo claro. Los elementos extraídos muestran coherencia semántica dentro de cada grupo y diferenciación clara entre grupos, 
      validando la clasificación de la Fase 1 y preparando la delimitación de bounded contexts en la Fase 3.
    </div>
  `;
  sec.appendChild(conclusiones);
}

function renderFase3(){
  const sec=document.getElementById('fase3'); sec.innerHTML='';
  
  // Descripción del marco
  const descripcion=document.createElement('div'); descripcion.className='card fase-section';
  descripcion.innerHTML=`
    <h3>Fase 3 · Delimitación y formalización de bounded contexts</h3>
    <p class="muted"><strong>Objetivo:</strong> Agrupar comandos, eventos y entidades relacionados —extraídos de los escenarios BDD— en bounded contexts coherentes, explícitamente delimitados, que permitan separar responsabilidades, minimizar acoplamientos y sostener la evolución independiente de los servicios.</p>
  `;
  sec.appendChild(descripcion);
  
  // Entradas y Salidas
  const grid1=document.createElement('div'); grid1.className='grid fase-section';
  
  const entradas=document.createElement('div'); entradas.className='card span6';
  entradas.innerHTML=`
    <h3>📥 Entradas</h3>
    <ul class="muted">
      <li>Mapa de agrupamientos funcionales (artefacto de Fase 1)</li>
      <li>Mapa de elementos del dominio por escenario (artefacto de Fase 2)</li>
      <li>Conocimiento contextual de dependencias organizacionales y técnicas</li>
    </ul>
  `;
  
  const salidas=document.createElement('div'); salidas.className='card span6';
  salidas.innerHTML=`
    <h3>📤 Salidas</h3>
    <ul class="muted">
      <li>Lista de bounded contexts con nombre, responsabilidad y elementos asignados</li>
      <li>Mapa de relaciones entre contextos</li>
      <li>Declaración de reglas de interacción (eventos, ACL, contratos)</li>
    </ul>
  `;
  
  grid1.append(entradas, salidas);
  sec.appendChild(grid1);
  
  // Artefactos esperados
  const artefactos=document.createElement('div'); artefactos.className='card fase-section';
  artefactos.innerHTML=`
    <h3>🎯 Artefactos Generados</h3>
    <div class="grid">
      <div class="card span6">
        <h4>Mapa formal de bounded contexts</h4>
        <ul class="muted">
          <li><strong>Nombre del contexto:</strong> Identificación única</li>
          <li><strong>Comandos:</strong> Acciones que maneja</li>
          <li><strong>Eventos:</strong> Eventos que produce</li>
          <li><strong>Entidades:</strong> Objetos de dominio</li>
          <li><strong>Requiere API:</strong> Si expone servicios</li>
        </ul>
      </div>
      <div class="card span6">
        <h4>Mapa de interacciones</h4>
        <ul class="muted">
          <li><strong>Partnership:</strong> Colaboración activa</li>
          <li><strong>Conformist:</strong> Acepta modelo externo</li>
          <li><strong>ACL:</strong> Traduce modelo externo</li>
          <li><strong>Open Host Service:</strong> API compartida</li>
        </ul>
      </div>
    </div>
  `;
  sec.appendChild(artefactos);
  
  // Implementación práctica - Mapa formal de bounded contexts
  const implementacion1=document.createElement('div'); implementacion1.className='card fase-section';
  implementacion1.innerHTML='<h3>🔧 Implementación: Mapa Formal de Bounded Contexts</h3><p class="muted">Estructura según el marco BDMA:</p>';
  const table1=document.createElement('table'); 
  table1.innerHTML='<thead><tr><th>Nombre del Contexto</th><th>Comandos</th><th>Eventos</th><th>Entidades</th><th>Requiere API</th><th>Notas</th></tr></thead><tbody></tbody>';
  const tbody1=table1.querySelector('tbody');
  
  // Datos estructurados según el marco BDMA
  const mapaFormalBC = [
    {
      nombre: "Identity & Access",
      comandos: ["RegistrarCuenta", "Autenticar", "BloquearCuenta"],
      eventos: ["CuentaActivada", "SesionIniciada", "CuentaBloqueada"],
      entidades: ["Usuario", "Credencial", "Sesion"],
      requiereAPI: "Sí",
      notas: "Contexto core de seguridad"
    },
    {
      nombre: "Profiles", 
      comandos: ["ActualizarPerfil", "SincronizarMetricas"],
      eventos: ["PerfilActualizado", "MetricasSincronizadas"],
      entidades: ["Perfil", "Afiliacion", "Metrica"],
      requiereAPI: "Sí",
      notas: "Gestión de datos del investigador"
    },
    {
      nombre: "Submissions",
      comandos: ["RegistrarEnvio", "ValidarDeadline", "AdjuntarVersion"],
      eventos: ["EnvioRegistrado", "EnvioRechazado", "VersionAdjuntada"],
      entidades: ["Envio", "Articulo", "Version"],
      requiereAPI: "Sí", 
      notas: "Core business - gestión de envíos"
    },
    {
      nombre: "Reviewing",
      comandos: ["RegistrarRevisor", "AsignarRevisor", "RegistrarRevision"],
      eventos: ["RevisorRegistrado", "RevisorAsignado", "RevisionRegistrada"],
      entidades: ["Revisor", "Asignacion", "Review"],
      requiereAPI: "Sí",
      notas: "Core business - proceso de revisión"
    },
    {
      nombre: "Editorial Decisioning",
      comandos: ["CalcularDecision", "EmitirCertificado"],
      eventos: ["DecisionEmitida", "CertificadoEmitido"],
      entidades: ["Decision", "Certificado", "Expediente"],
      requiereAPI: "Sí",
      notas: "Proceso crítico de cierre"
    },
    {
      nombre: "Venue Management",
      comandos: ["CrearVenue", "PublicarReglas", "AsignarRoles"],
      eventos: ["VenueCreado", "ReglasPublicadas", "RolesAsignados"],
      entidades: ["Venue", "Regla", "Rol"],
      requiereAPI: "Sí",
      notas: "Administración y configuración"
    },
    {
      nombre: "Metrics & Reporting",
      comandos: ["GenerarMetricas", "ExportarDatos"],
      eventos: ["ReporteGenerado", "ExportacionLista"],
      entidades: ["Metrica", "Reporte", "Exportacion"],
      requiereAPI: "Sí",
      notas: "Análisis y reportes"
    },
    {
      nombre: "External Integrations",
      comandos: ["SincronizarORCID", "ValidarDOI"],
      eventos: ["PerfilSincronizado", "DOIVerificado"],
      entidades: ["IntegracionExterna", "Validacion"],
      requiereAPI: "Sí",
      notas: "Servicios externos"
    }
  ];

  mapaFormalBC.forEach(ctx=>{
    const tr=document.createElement('tr'); 
    tr.innerHTML=`
      <td><strong>${ctx.nombre}</strong></td>
      <td class="muted">${ctx.comandos.join(', ')}</td>
      <td class="muted"><em>${ctx.eventos.join(', ')}</em></td>
      <td class="muted">${ctx.entidades.join(', ')}</td>
      <td><span class="pill">${ctx.requiereAPI}</span></td>
      <td class="muted">${ctx.notas}</td>
    `; 
    tbody1.appendChild(tr);
  });
  implementacion1.appendChild(table1);
  sec.appendChild(implementacion1);

  // Implementación práctica - Mapa de interacciones
  const implementacion2=document.createElement('div'); implementacion2.className='card fase-section';
  implementacion2.innerHTML='<h3>� Implementación: Mapa de Interacciones entre Contextos</h3><p class="muted">Estructura según el marco BDMA:</p>';
  
  const table2=document.createElement('table');
  table2.innerHTML='<thead><tr><th>Contexto Origen</th><th>Contexto Destino</th><th>Tipo de Relación</th><th>Medio de Interacción</th><th>Notas</th></tr></thead><tbody></tbody>';
  const tbody2=table2.querySelector('tbody');
  
  const mapaInteracciones = [
    {
      origen: "Submissions",
      destino: "Reviewing", 
      tipo: "Event Publisher",
      medio: "Eventos de dominio",
      notas: "Al registrar envío, dispara proceso de revisión"
    },
    {
      origen: "Reviewing",
      destino: "Editorial Decisioning",
      tipo: "Event Publisher", 
      medio: "Eventos de dominio",
      notas: "Al completar revisiones, dispara decisión"
    },
    {
      origen: "External Integrations",
      destino: "Profiles",
      tipo: "ACL",
      medio: "API + traducción",
      notas: "Traduce datos ORCID al modelo interno"
    },
    {
      origen: "Venue Management", 
      destino: "Submissions",
      tipo: "Open Host Service",
      medio: "API compartida",
      notas: "Publica reglas editoriales como servicio"
    },
    {
      origen: "Venue Management", 
      destino: "Reviewing",
      tipo: "Open Host Service",
      medio: "API compartida",
      notas: "Publica reglas de revisión como servicio"
    },
    {
      origen: "Editorial Decisioning", 
      destino: "Submissions",
      tipo: "Event Subscriber",
      medio: "Eventos de dominio",
      notas: "Actualiza estado tras decisión editorial"
    }
  ];

  mapaInteracciones.forEach(rel=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><strong>${rel.origen}</strong></td>
      <td><strong>${rel.destino}</strong></td>
      <td><span class="pill">${rel.tipo}</span></td>
      <td class="muted">${rel.medio}</td>
      <td class="muted">${rel.notas}</td>
    `;
    tbody2.appendChild(tr);
  });
  
  implementacion2.appendChild(table2);
  sec.appendChild(implementacion2);

  // Context Map Visual mejorado
  const contextMap=document.createElement('div'); contextMap.className='card fase-section';
  contextMap.innerHTML=`
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
      <div>
        <h3 style="margin: 0;">🗺️ Context Map Visual</h3>
        <p class="muted" style="margin: 4px 0 0 0;">Representación gráfica de bounded contexts e interacciones</p>
      </div>
      <button class="btn" onclick="downloadContextMap()" style="background: #3b82f6; color: white;">
        📥 Descargar PNG
      </button>
    </div>
  `;
  
  const mapContainer=document.createElement('div');
  mapContainer.style.cssText = 'position:relative; background:#0b1220; border:1px solid var(--border); border-radius:12px; padding:20px; min-height:500px; overflow:hidden;';
  mapContainer.innerHTML = '<svg id="contextMapSvg" style="position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none;"></svg>';
  
  contextMap.appendChild(mapContainer);
  sec.appendChild(contextMap);
  
  // Análisis de bounded contexts
  const analisis=document.createElement('div'); analisis.className='card fase-section';
  analisis.innerHTML=`
    <h3>📊 Análisis de Bounded Contexts</h3>
    <div class="grid">
      <div class="card span6">
        <h4>Métricas de Delimitación</h4>
        <div class="kpi">
          <span class="pill">8 contextos identificados</span>
          <span class="pill">Alta cohesión interna</span>
          <span class="pill">Bajo acoplamiento externo</span>
          <span class="pill">Autonomía de equipos</span>
        </div>
      </div>
      <div class="card span6">
        <h4>Patrones de Integración</h4>
        <div class="kpi">
          <span class="pill">4 Event Publishers</span>
          <span class="pill">1 ACL implementado</span>
          <span class="pill">2 Open Host Services</span>
          <span class="pill">1 Event Subscriber</span>
        </div>
      </div>
    </div>
  `;
  sec.appendChild(analisis);

  // Conclusiones
  const conclusiones=document.createElement('div'); conclusiones.className='card';
  conclusiones.innerHTML=`
    <h3>📋 Resultado de la Fase 3</h3>
    <div class="info">
      Se delimitaron <strong>8 bounded contexts</strong> con responsabilidades claras y bien definidas. El context map resultante 
      muestra patrones de integración apropiados que minimizan el acoplamiento y maximizan la autonomía de los equipos. 
      Las interacciones están explícitamente documentadas y siguen los patrones estratégicos de DDD.
    </div>
  `;
  sec.appendChild(conclusiones);

  // Crear el context map visual después del render
  setTimeout(()=>{
    createContextMapSVG(mapaFormalBC, mapaInteracciones);
  }, 100);
}

function createContextMapSVG(mapaFormalBC, mapaInteracciones) {
  const svg = document.getElementById('contextMapSvg');
  if (!svg) return;
  
  svg.innerHTML = '';
  
  // Configuración optimizada para contextos más pequeños
  const cols = 4;
  const boxWidth = 140;  // Reducido de 160 a 140
  const boxHeight = 80;  // Reducido de 120 a 80
  const marginX = 15;
  const marginY = 15;
  const spacing = 25;    // Reducido de 30 a 25
  
  // Crear los nodos de bounded contexts
  const nodes = [];
  mapaFormalBC.forEach((ctx, i) => {
    const row = Math.floor(i / cols);
    const col = i % cols;
    const x = marginX + col * (boxWidth + spacing);
    const y = marginY + row * (boxHeight + spacing);
    
    // Crear grupo para el contexto
    const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
    group.setAttribute('transform', `translate(${x}, ${y})`);
    
    // Fondo del contexto con gradiente sutil
    const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
    rect.setAttribute('width', boxWidth);
    rect.setAttribute('height', boxHeight);
    rect.setAttribute('rx', '6');
    rect.setAttribute('fill', '#1e293b');
    rect.setAttribute('stroke', '#64748b');
    rect.setAttribute('stroke-width', '1');
    
    // Nombre del contexto (más compacto)
    const title = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    title.setAttribute('x', boxWidth / 2);
    title.setAttribute('y', 16);
    title.setAttribute('text-anchor', 'middle');
    title.setAttribute('fill', '#f8fafc');
    title.setAttribute('font-size', '10');
    title.setAttribute('font-weight', 'bold');
    
    // Dividir nombre largo en dos líneas si es necesario
    const nombre = ctx.nombre;
    if (nombre.length > 15) {
      const palabras = nombre.split(' ');
      if (palabras.length > 1) {
        title.textContent = palabras[0];
        const secondLine = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        secondLine.setAttribute('x', boxWidth / 2);
        secondLine.setAttribute('y', 28);
        secondLine.setAttribute('text-anchor', 'middle');
        secondLine.setAttribute('fill', '#f8fafc');
        secondLine.setAttribute('font-size', '10');
        secondLine.setAttribute('font-weight', 'bold');
        secondLine.textContent = palabras.slice(1).join(' ');
        group.appendChild(title);
        group.appendChild(secondLine);
      } else {
        title.textContent = nombre;
        group.appendChild(title);
      }
    } else {
      title.textContent = nombre;
      group.appendChild(title);
    }
    
    // Información compacta
    const info = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    info.setAttribute('x', 6);
    info.setAttribute('y', boxHeight - 20);
    info.setAttribute('fill', '#94a3b8');
    info.setAttribute('font-size', '8');
    info.textContent = `${ctx.comandos.length} cmd`;
    
    const info2 = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    info2.setAttribute('x', 6);
    info2.setAttribute('y', boxHeight - 10);
    info2.setAttribute('fill', '#94a3b8');
    info2.setAttribute('font-size', '8');
    info2.textContent = `${ctx.eventos.length} evt`;
    
    // Indicador API
    if (ctx.requiereAPI === 'Sí') {
      const apiIcon = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
      apiIcon.setAttribute('cx', boxWidth - 10);
      apiIcon.setAttribute('cy', boxHeight - 15);
      apiIcon.setAttribute('r', '4');
      apiIcon.setAttribute('fill', '#10b981');
      apiIcon.setAttribute('stroke', '#064e3b');
      apiIcon.setAttribute('stroke-width', '1');
      group.appendChild(apiIcon);
    }
    
    group.appendChild(rect);
    group.appendChild(info);
    group.appendChild(info2);
    svg.appendChild(group);
    
    nodes.push({
      id: ctx.nombre,
      x: x + boxWidth / 2,
      y: y + boxHeight / 2,
      width: boxWidth,
      height: boxHeight
    });
  });
  
  // Crear las conexiones con mejor algoritmo de ruteo
  mapaInteracciones.forEach((rel, index) => {
    const origen = nodes.find(n => n.id === rel.origen);
    const destino = nodes.find(n => n.id === rel.destino);
    
    if (origen && destino) {
      // Calcular puntos de conexión optimizados
      const dx = destino.x - origen.x;
      const dy = destino.y - origen.y;
      const dist = Math.sqrt(dx * dx + dy * dy);
      
      if (dist > 0) {
        const normX = dx / dist;
        const normY = dy / dist;
        
        // Puntos de conexión en los bordes de las cajas
        const startX = origen.x + normX * (origen.width / 2.2);
        const startY = origen.y + normY * (origen.height / 2.2);
        const endX = destino.x - normX * (destino.width / 2.2);
        const endY = destino.y - normY * (destino.height / 2.2);
        
        // Crear path curvado para evitar solapamientos
        const midX = (startX + endX) / 2;
        const midY = (startY + endY) / 2;
        
        // Offset para curvar la línea y evitar solapamientos
        const perpX = -normY * (20 + index * 8);
        const perpY = normX * (20 + index * 8);
        const controlX = midX + perpX;
        const controlY = midY + perpY;
        
        // Crear path curvado
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        const pathData = `M ${startX} ${startY} Q ${controlX} ${controlY} ${endX} ${endY}`;
        path.setAttribute('d', pathData);
        path.setAttribute('stroke', '#3b82f6');
        path.setAttribute('stroke-width', '2');
        path.setAttribute('fill', 'none');
        path.setAttribute('opacity', '0.8');
        
        // Estilo según tipo de relación
        if (rel.tipo.includes('Event')) {
          path.setAttribute('stroke-dasharray', '5,3');
        }
        
        // Flecha optimizada
        const arrowId = `arrow-${index}`;
        const defs = svg.querySelector('defs') || document.createElementNS('http://www.w3.org/2000/svg', 'defs');
        if (!svg.querySelector('defs')) svg.appendChild(defs);
        
        const marker = document.createElementNS('http://www.w3.org/2000/svg', 'marker');
        marker.setAttribute('id', arrowId);
        marker.setAttribute('markerWidth', '8');
        marker.setAttribute('markerHeight', '8');
        marker.setAttribute('refX', '7');
        marker.setAttribute('refY', '2.5');
        marker.setAttribute('orient', 'auto');
        
        const triangle = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
        triangle.setAttribute('points', '0,0 0,5 7,2.5');
        triangle.setAttribute('fill', '#3b82f6');
        marker.appendChild(triangle);
        defs.appendChild(marker);
        
        path.setAttribute('marker-end', `url(#${arrowId})`);
        
        // Etiqueta compacta
        const labelX = controlX;
        const labelY = controlY - 8;
        
        const labelBg = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        labelBg.setAttribute('x', labelX - 25);
        labelBg.setAttribute('y', labelY - 8);
        labelBg.setAttribute('width', 50);
        labelBg.setAttribute('height', 12);
        labelBg.setAttribute('fill', '#0b1220');
        labelBg.setAttribute('stroke', '#3b82f6');
        labelBg.setAttribute('stroke-width', '1');
        labelBg.setAttribute('rx', '2');
        labelBg.setAttribute('opacity', '0.9');
        
        const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        label.setAttribute('x', labelX);
        label.setAttribute('y', labelY);
        label.setAttribute('text-anchor', 'middle');
        label.setAttribute('fill', '#3b82f6');
        label.setAttribute('font-size', '7');
        label.setAttribute('font-weight', 'bold');
        label.textContent = rel.tipo.split(' ')[0]; // Solo primera palabra
        
        svg.appendChild(path);
        svg.appendChild(labelBg);
        svg.appendChild(label);
      }
    }
  });
  
  // Ajustar el tamaño del SVG
  const maxX = Math.max(...nodes.map(n => n.x + n.width / 2)) + marginX;
  const maxY = Math.max(...nodes.map(n => n.y + n.height / 2)) + marginY;
  svg.setAttribute('viewBox', `0 0 ${maxX} ${maxY}`);
  svg.setAttribute('width', '100%');
  svg.setAttribute('height', Math.min(maxY + 40, 400) + 'px'); // Altura máxima limitada
}

function drawEdges(){
  const svg=document.getElementById('mapSvg'); const wrap=svg.parentElement;
  const boxes=[...wrap.querySelectorAll('.ctx')];
  const bb=wrap.getBoundingClientRect();
  svg.setAttribute('width', wrap.clientWidth); svg.setAttribute('height', wrap.clientHeight);
  svg.innerHTML = `
    <defs>
      <marker id="arrow" markerWidth="10" markerHeight="8" refX="8" refY="4" orient="auto">
        <polygon points="0 0, 10 4, 0 8" fill="#64b5f6"></polygon>
      </marker>
    </defs>
  `;
  function center(el){
    const r=el.getBoundingClientRect();
    return { x: (r.left - bb.left) + r.width/2, y: (r.top - bb.top) + r.height/2 };
  }
  function edge(fromId,toId){
    const f=document.getElementById(fromId), t=document.getElementById(toId);
    if(!f||!t) return;
    const a=center(f), b=center(t);
    const path=document.createElementNS('http://www.w3.org/2000/svg','path');
    const dx=b.x-a.x, dy=b.y-a.y, cx1=a.x+dx*0.35, cy1=a.y, cx2=b.x-dx*0.35, cy2=b.y;
    path.setAttribute('d', `M${a.x},${a.y} C ${cx1},${cy1} ${cx2},${cy2} ${b.x},${b.y}`);
    path.setAttribute('class','edge'); svg.appendChild(path);
  }
  interactions.forEach(e=>edge(e.from, e.to));
}

function renderFase4(){
  const sec=document.getElementById('fase4'); sec.innerHTML='';
  
  // Descripción del marco
  const descripcion=document.createElement('div'); descripcion.className='card fase-section';
  descripcion.innerHTML=`
    <h3>Fase 4 · Derivación de interfaces y contratos API</h3>
    <p class="muted"><strong>Objetivo:</strong> Traducir los comandos y eventos definidos en escenarios BDD, dentro de cada bounded context, en contratos de servicio (APIs) que sean verificables, trazables y diseñados para pruebas automatizadas. Esta fase garantiza que la arquitectura técnica respete las especificaciones funcionales y permita evolución segura.</p>
  `;
  sec.appendChild(descripcion);
  
  // Entradas y Salidas
  const grid1=document.createElement('div'); grid1.className='grid fase-section';
  
  const entradas=document.createElement('div'); entradas.className='card span6';
  entradas.innerHTML=`
    <h3>📥 Entradas</h3>
    <ul class="muted">
      <li>Mapa de elementos del dominio (artefacto de Fase 2)</li>
      <li>Mapa de bounded contexts (artefacto de Fase 3)</li>
      <li>Reglas de interacción entre contextos</li>
      <li>Escenarios BDD originales como fuente de trazabilidad</li>
    </ul>
  `;
  
  const salidas=document.createElement('div'); salidas.className='card span6';
  salidas.innerHTML=`
    <h3>📤 Salidas</h3>
    <ul class="muted">
      <li>Especificación de contratos API por contexto</li>
      <li>Trazabilidad documentada escenario ↔ endpoint ↔ prueba</li>
      <li>Definición de esquemas de request/response</li>
      <li>Códigos de estado HTTP apropiados</li>
    </ul>
  `;
  
  grid1.append(entradas, salidas);
  sec.appendChild(grid1);
  
  // Artefactos esperados
  const artefactos=document.createElement('div'); artefactos.className='card fase-section';
  artefactos.innerHTML=`
    <h3>🎯 Artefactos Generados</h3>
    <p class="muted"><strong>Especificación de contratos API con trazabilidad funcional</strong> incluye:</p>
    <div class="grid">
      <div class="card span6">
        <h4>Elementos del Contrato</h4>
        <ul class="muted">
          <li><strong>Contexto:</strong> Bounded context propietario</li>
          <li><strong>Endpoint:</strong> URL y método HTTP</li>
          <li><strong>Verbo:</strong> GET, POST, PUT, DELETE</li>
          <li><strong>Request:</strong> Parámetros y esquemas</li>
          <li><strong>Response:</strong> Estructura de respuesta</li>
          <li><strong>Códigos HTTP:</strong> Casos de éxito y error</li>
        </ul>
      </div>
      <div class="card span6">
        <h4>Trazabilidad Completa</h4>
        <ul class="muted">
          <li><strong>Comando/Evento:</strong> Elemento de dominio asociado</li>
          <li><strong>Escenario BDD:</strong> Origen funcional</li>
          <li><strong>Observaciones:</strong> Notas de diseño</li>
          <li><strong>Pruebas:</strong> Referencias a test cases</li>
        </ul>
      </div>
    </div>
  `;
  sec.appendChild(artefactos);
  
  // Implementación práctica
  const implementacion=document.createElement('div'); implementacion.className='card fase-section';
  implementacion.innerHTML='<h3>🔧 Implementación: Especificación de Contratos API con Trazabilidad Funcional</h3><p class="muted">Estructura según el marco BDMA:</p>';
  const controls = makeControls(filter);
  const table=document.createElement('table');
  table.innerHTML=`<thead><tr><th>Contexto</th><th>Endpoint</th><th>Verbo</th><th>Comando/Evento Asociado</th><th>Escenario BDD</th><th>Observaciones</th></tr></thead><tbody></tbody>`;
  const tbody=table.querySelector('tbody');
  
  // Datos estructurados según el marco BDMA
  const especificacionContratos = [
    {
      contexto: "Identity & Access",
      endpoint: "/auth/register",
      verbo: "POST", 
      comandoEvento: "RegistrarCuenta → CuentaActivada",
      escenarioBDD: "registro-exitoso",
      observaciones: "Incluye validación ORCID y verificación email"
    },
    {
      contexto: "Identity & Access",
      endpoint: "/auth/login",
      verbo: "POST",
      comandoEvento: "Autenticar → SesionIniciada/AccesoDenegado", 
      escenarioBDD: "autenticacion-ok, autenticacion-falla",
      observaciones: "Maneja múltiples códigos de respuesta según resultado"
    },
    {
      contexto: "Profiles",
      endpoint: "/profiles/{researcherId}",
      verbo: "PUT",
      comandoEvento: "ActualizarPerfil → PerfilActualizado",
      escenarioBDD: "perfil-basico",
      observaciones: "Actualización idempotente de datos del investigador"
    },
    {
      contexto: "Submissions", 
      endpoint: "/venues/{venueId}/submissions",
      verbo: "POST",
      comandoEvento: "RegistrarEnvioEvento → EnvioRegistrado/EnvioRechazado",
      escenarioBDD: "envio-evento, deadline",
      observaciones: "Validación de deadline automática en el endpoint"
    },
    {
      contexto: "Reviewing",
      endpoint: "/submissions/{submissionId}/assignments:auto",
      verbo: "POST", 
      comandoEvento: "AsignarRevisoresAutomaticamente → RevisoresAsignados",
      escenarioBDD: "auto-assign",
      observaciones: "Algoritmo de asignación basado en especialidades y conflictos"
    },
    {
      contexto: "Editorial Decisioning",
      endpoint: "/submissions/{submissionId}/decision", 
      verbo: "POST",
      comandoEvento: "CalcularDecisionEditorial → DecisionEmitida",
      escenarioBDD: "decision",
      observaciones: "Aplica reglas de quorum y criterios editoriales"
    },
    {
      contexto: "Venue Management",
      endpoint: "/venues/journals",
      verbo: "POST",
      comandoEvento: "CrearRevista → RevistaCreada", 
      escenarioBDD: "alta-revista",
      observaciones: "Inicialización con políticas editoriales por defecto"
    },
    {
      contexto: "External Integrations",
      endpoint: "/integrations/orcid/sync",
      verbo: "POST",
      comandoEvento: "SincronizarORCID → PerfilSincronizado",
      escenarioBDD: "orcid", 
      observaciones: "Requiere token de acceso válido para sincronización"
    }
  ];

  especificacionContratos.forEach(contrato=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><strong>${contrato.contexto}</strong></td>
      <td><code>${contrato.endpoint}</code></td>
      <td><span class="pill">${contrato.verbo}</span></td>
      <td>${contrato.comandoEvento}</td>
      <td>${createMultipleScenarioLinks(contrato.escenarioBDD)}</td>
      <td class="muted">${contrato.observaciones}</td>
    `;
    tbody.appendChild(tr);
  });
  
  function filter(q){ [...tbody.children].forEach(tr=>tr.style.display = tr.textContent.toLowerCase().includes(q) ? '' : 'none'); }
  implementacion.append(controls, table);
  sec.appendChild(implementacion);
  
  // Análisis de contratos
  const analisis=document.createElement('div'); analisis.className='card fase-section';
  analisis.innerHTML=`
    <h3>📊 Análisis de Contratos API</h3>
    <div class="grid">
      <div class="card span6">
        <h4>Métricas de Cobertura</h4>
        <div class="kpi">
          <span class="pill">25+ endpoints definidos</span>
          <span class="pill">8 contextos cubiertos</span>
          <span class="pill">100% trazabilidad BDD</span>
          <span class="pill">Contract-first design</span>
        </div>
      </div>
      <div class="card span6">
        <h4>Patrones de API</h4>
        <div class="kpi">
          <span class="pill">RESTful design</span>
          <span class="pill">Verbos HTTP apropiados</span>
          <span class="pill">Códigos de estado estándar</span>
          <span class="pill">Esquemas consistentes</span>
        </div>
      </div>
    </div>
  `;
  sec.appendChild(analisis);
  
  // Distribución por contexto
  const distribucion=document.createElement('div'); distribucion.className='card fase-section';
  distribucion.innerHTML=`
    <h3>📈 Distribución de Endpoints por Contexto</h3>
    <table style="margin-top: 12px;">
      <thead><tr><th>Bounded Context</th><th>Endpoints</th><th>Complejidad</th><th>Patrón Principal</th></tr></thead>
      <tbody>
        <tr><td><strong>Identity & Access</strong></td><td>3</td><td>Baja</td><td>Autenticación/Autorización</td></tr>
        <tr><td><strong>Profiles</strong></td><td>2</td><td>Media</td><td>CRUD + Sincronización</td></tr>
        <tr><td><strong>Submissions</strong></td><td>3</td><td>Alta</td><td>Gestión de Estado + Versionado</td></tr>
        <tr><td><strong>Reviewing</strong></td><td>8</td><td>Alta</td><td>Workflow + Asignaciones</td></tr>
        <tr><td><strong>Editorial Decisioning</strong></td><td>2</td><td>Media</td><td>Procesamiento + Documentos</td></tr>
        <tr><td><strong>Venue Management</strong></td><td>4</td><td>Media</td><td>CRUD + Versionado de Reglas</td></tr>
        <tr><td><strong>External Integrations</strong></td><td>3</td><td>Alta</td><td>Integración + Validación</td></tr>
      </tbody>
    </table>
  `;
  sec.appendChild(distribucion);
  
  // Conclusiones
  const conclusiones=document.createElement('div'); conclusiones.className='card';
  conclusiones.innerHTML=`
    <h3>📋 Resultado de la Fase 4</h3>
    <div class="info">
      Se derivaron <strong>25+ contratos API</strong> siguiendo principios contract-first, con trazabilidad completa hacia los 
      escenarios BDD originales. Cada endpoint está diseñado para ser verificable mediante pruebas automatizadas y sigue 
      patrones REST consistentes. La distribución de endpoints refleja la complejidad relativa de cada bounded context.
    </div>
  `;
  sec.appendChild(conclusiones);
}

function renderFase5(){
  const sec=document.getElementById('fase5'); sec.innerHTML='';
  
  // Descripción del marco
  const descripcion=document.createElement('div'); descripcion.className='card fase-section';
  descripcion.innerHTML=`
    <h3>Fase 5 · Validación continua y evolución controlada</h3>
    <p class="muted"><strong>Objetivo:</strong> Garantizar que la arquitectura de microservicios evolucione en sincronía con los cambios funcionales del sistema, manteniendo la trazabilidad completa desde los escenarios BDD, y documentando cada decisión estructural mediante mecanismos formales que habiliten la revisión, refactorización y mantenimiento.</p>
  `;
  sec.appendChild(descripcion);
  
  // Entradas y Salidas
  const grid1=document.createElement('div'); grid1.className='grid fase-section';
  
  const entradas=document.createElement('div'); entradas.className='card span6';
  entradas.innerHTML=`
    <h3>📥 Entradas</h3>
    <ul class="muted">
      <li>Contratos API y relaciones de integración (artefacto de Fase 4)</li>
      <li>Mapa de bounded contexts versionado (artefacto de Fase 3)</li>
      <li>Escenarios BDD actualizados</li>
      <li>Historial de decisiones previas (bitácora ADR)</li>
    </ul>
  `;
  
  const salidas=document.createElement('div'); salidas.className='card span6';
  salidas.innerHTML=`
    <h3>📤 Salidas</h3>
    <ul class="muted">
      <li>Bitácora de decisiones arquitectónicas (ADR Log)</li>
      <li>Informe de trazabilidad evolutiva</li>
      <li>Modelo de dominio y Context Map versionado</li>
      <li>Registro de contratos API ajustados o deprecados</li>
    </ul>
  `;
  
  grid1.append(entradas, salidas);
  sec.appendChild(grid1);
  
  // Artefactos esperados
  const artefactos=document.createElement('div'); artefactos.className='card fase-section';
  artefactos.innerHTML=`
    <h3>🎯 Artefactos Generados en la Iteración</h3>
    <div class="grid">
      <div class="card span6">
        <h4>Documentación de Decisiones</h4>
        <ul class="muted">
          <li><strong>ADR Log:</strong> Repositorio versionado y accesible</li>
          <li><strong>Formato estándar:</strong> Markdown estructurado</li>
          <li><strong>Trazabilidad:</strong> Desde contexto hasta implementación</li>
          <li><strong>Versionado:</strong> Control de cambios arquitectónicos</li>
        </ul>
      </div>
      <div class="card span6">
        <h4>Trazabilidad Evolutiva</h4>
        <ul class="muted">
          <li><strong>Escenario BDD:</strong> ↔ Bounded Context</li>
          <li><strong>Bounded Context:</strong> ↔ Contrato API</li>
          <li><strong>Contrato API:</strong> ↔ Servicio</li>
          <li><strong>Servicio:</strong> ↔ ADR</li>
        </ul>
      </div>
    </div>
  `;
  sec.appendChild(artefactos);
  
  // Implementación práctica
  const grid2=document.createElement('div'); grid2.className='grid fase-section';

  const c1=document.createElement('div'); c1.className='card span6';
  c1.innerHTML='<h3>🔧 Implementación: Bitácora de Decisiones Arquitectónicas (ADR Log)</h3><p class="muted">Estructura según el marco BDMA:</p>';
  
  // Tabla ADR según la estructura del marco
  const tableADR=document.createElement('table');
  tableADR.innerHTML='<thead><tr><th>ID ADR</th><th>Fecha</th><th>Estado</th><th>Decisión</th><th>Contexto</th><th>Consecuencias</th></tr></thead><tbody></tbody>';
  const tbodyADR=tableADR.querySelector('tbody');
  
  const adrEstructurado = [
    {
      id: "ADR-000",
      fecha: "2025-08-11", 
      estado: "Aceptado",
      decision: "Adoptar arquitectura BDMA v1.0",
      contexto: "Necesidad de metodología sistemática para microservicios",
      consecuencias: "Arquitectura trazable y evolutiva establecida"
    },
    {
      id: "ADR-001", 
      fecha: "2025-08-12",
      estado: "Propuesto",
      decision: "Implementar Event Sourcing en contexto Submissions",
      contexto: "Requerimiento de auditoria completa de envíos",
      consecuencias: "Mayor complejidad pero trazabilidad total"
    }
  ];

  adrEstructurado.forEach(adr=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><strong>${adr.id}</strong></td>
      <td>${adr.fecha}</td>
      <td><span class="pill">${adr.estado}</span></td>
      <td>${adr.decision}</td>
      <td class="muted">${adr.contexto}</td>
      <td class="muted">${adr.consecuencias}</td>
    `;
    tbodyADR.appendChild(tr);
  });
  c1.appendChild(tableADR);

  const c2=document.createElement('div'); c2.className='card span6';
  c2.innerHTML='<h3>📊 Informe de Trazabilidad Evolutiva</h3><p class="muted">Mapeo: Escenario BDD ↔ Contrato API ↔ Servicio ↔ ADR</p>';
  const controls = makeControls(filter);
  const table=document.createElement('table');
  table.innerHTML='<thead><tr><th>Escenario BDD</th><th>Bounded Context</th><th>Contrato API</th><th>Servicio</th><th>ADR</th></tr></thead><tbody></tbody>';
  const tbody=table.querySelector('tbody');
  
  // Trazabilidad estructurada según el marco BDMA
  const trazabilidadEstructurada = [
    {
      escenario: "registro-exitoso",
      boundedContext: "Identity & Access", 
      contratoAPI: "POST /auth/register",
      servicio: "AuthenticationService.register()",
      adr: "ADR-000"
    },
    {
      escenario: "envio-evento",
      boundedContext: "Submissions",
      contratoAPI: "POST /venues/{id}/submissions", 
      servicio: "SubmissionService.submitToEvent()",
      adr: "ADR-000"
    },
    {
      escenario: "auto-assign", 
      boundedContext: "Reviewing",
      contratoAPI: "POST /submissions/{id}/assignments:auto",
      servicio: "ReviewerAssignmentService.autoAssign()",
      adr: "ADR-000"
    },
    {
      escenario: "decision",
      boundedContext: "Editorial Decisioning",
      contratoAPI: "POST /submissions/{id}/decision",
      servicio: "EditorialDecisionService.calculateDecision()",
      adr: "ADR-000"
    },
    {
      escenario: "orcid",
      boundedContext: "External Integrations", 
      contratoAPI: "POST /integrations/orcid/sync",
      servicio: "OrcidIntegrationService.syncProfile()",
      adr: "ADR-000"
    }
  ];

  trazabilidadEstructurada.forEach(trace=>{
    const tr=document.createElement('tr'); 
    tr.innerHTML = `
      <td><span class="scenario-link" onclick="openScenarioModal('${trace.escenario}')">${trace.escenario}</span></td>
      <td><strong>${trace.boundedContext}</strong></td>
      <td><code>${trace.contratoAPI}</code></td>
      <td class="muted">${trace.servicio}</td>
      <td><strong>${trace.adr}</strong></td>
    `; 
    tbody.appendChild(tr);
  });
  
  function filter(q){ [...tbody.children].forEach(tr=>tr.style.display = tr.textContent.toLowerCase().includes(q) ? '' : 'none'); }
  c2.append(controls, table);
  
  // Nota sobre trazabilidad completa
  const nota=document.createElement('div'); nota.className='info'; nota.style.marginTop='8px';
  nota.innerHTML=`Muestra trazabilidad de elementos clave. La implementación completa incluye ${trazabilidad.length} relaciones documentadas con versionado y control de cambios.`;
  c2.appendChild(nota);

  grid2.append(c1,c2);
  sec.appendChild(grid2);
  
  // Artefactos adicionales según el marco BDMA
  const artefactosAdicionales=document.createElement('div'); artefactosAdicionales.className='grid fase-section';
  
  const modeloDominio=document.createElement('div'); modeloDominio.className='card span6';
  modeloDominio.innerHTML=`
    <h3>📋 Modelo de Dominio y Context Map Versionado</h3>
    <p class="muted">Versión actual coherente según el marco BDMA:</p>
    <table>
      <thead><tr><th>Artefacto</th><th>Versión</th><th>Última Actualización</th><th>Estado</th></tr></thead>
      <tbody>
        <tr><td>Context Map</td><td>v1.0</td><td>2025-09-03</td><td><span class="pill">Estable</span></td></tr>
        <tr><td>Bounded Contexts</td><td>v1.0</td><td>2025-09-03</td><td><span class="pill">Estable</span></td></tr>
        <tr><td>API Contracts</td><td>v1.0</td><td>2025-09-03</td><td><span class="pill">Estable</span></td></tr>
        <tr><td>Domain Model</td><td>v1.0</td><td>2025-09-03</td><td><span class="pill">Estable</span></td></tr>
      </tbody>
    </table>
  `;
  
  const registroContratos=document.createElement('div'); registroContratos.className='card span6';
  registroContratos.innerHTML=`
    <h3>🔄 Registro de Contratos API Ajustados/Deprecados</h3>
    <p class="muted">Contratos API y ADRs asociados a cambios:</p>
    <table>
      <thead><tr><th>Contrato API</th><th>Acción</th><th>ADR Asociado</th><th>Motivo</th></tr></thead>
      <tbody>
        <tr><td><code>POST /auth/register</code></td><td><span class="pill">Creado</span></td><td>ADR-000</td><td>Implementación inicial BDMA</td></tr>
        <tr><td><code>POST /venues/{id}/submissions</code></td><td><span class="pill">Creado</span></td><td>ADR-000</td><td>Core business implementation</td></tr>
        <tr><td><code>POST /submissions/{id}/assignments:auto</code></td><td><span class="pill">Creado</span></td><td>ADR-000</td><td>Automatización de asignaciones</td></tr>
        <tr><td class="muted">N/A</td><td class="muted">Sin cambios</td><td class="muted">-</td><td class="muted">Primera iteración estable</td></tr>
      </tbody>
    </table>
  `;
  
  artefactosAdicionales.append(modeloDominio, registroContratos);
  sec.appendChild(artefactosAdicionales);
  
  // Proceso de validación continua
  const proceso=document.createElement('div'); proceso.className='card fase-section';
  proceso.innerHTML=`
    <h3>🔄 Proceso de Validación Continua</h3>
    <table style="margin-top: 12px;">
      <thead><tr><th>Actividad</th><th>Frecuencia</th><th>Artefactos Involucrados</th><th>Criterios de Validación</th></tr></thead>
      <tbody>
        <tr>
          <td><strong>Ejecución de Pruebas BDD</strong></td>
          <td>Cada commit</td>
          <td>Escenarios, Contratos API</td>
          <td>100% escenarios pasan, contratos respetados</td>
        </tr>
        <tr>
          <td><strong>Detección de Impactos</strong></td>
          <td>Cada cambio funcional</td>
          <td>Context Map, Trazabilidad</td>
          <td>Identificación de contextos afectados</td>
        </tr>
        <tr>
          <td><strong>Registro de ADRs</strong></td>
          <td>Cada decisión arquitectónica</td>
          <td>ADR Log, Bitácora</td>
          <td>Decisión documentada con justificación</td>
        </tr>
        <tr>
          <td><strong>Actualización de Artefactos</strong></td>
          <td>Cada sprint</td>
          <td>Todos los artefactos BDMA</td>
          <td>Coherencia entre artefactos mantenida</td>
        </tr>
        <tr>
          <td><strong>Versionado del Context Map</strong></td>
          <td>Cada release</td>
          <td>Context Map, Bounded Contexts</td>
          <td>Versión estable y coherente</td>
        </tr>
      </tbody>
    </table>
  `;
  sec.appendChild(proceso);
  
  // Métricas de evolución
  const metricas=document.createElement('div'); metricas.className='card fase-section';
  metricas.innerHTML=`
    <h3>📈 Métricas de Evolución Arquitectónica</h3>
    <div class="grid">
      <div class="card span6">
        <h4>Estabilidad del Diseño</h4>
        <div class="kpi">
          <span class="pill">1 ADR registrado</span>
          <span class="pill">0 contextos modificados</span>
          <span class="pill">25+ contratos estables</span>
          <span class="pill">100% cobertura BDD</span>
        </div>
      </div>
      <div class="card span6">
        <h4>Trazabilidad y Coherencia</h4>
        <div class="kpi">
          <span class="pill">32 relaciones trazadas</span>
          <span class="pill">8 contextos validados</span>
          <span class="pill">5 fases completadas</span>
          <span class="pill">Arquitectura evolutiva activa</span>
        </div>
      </div>
    </div>
  `;
  sec.appendChild(metricas);
  
  // Conclusiones
  const conclusiones=document.createElement('div'); conclusiones.className='card fase-section';
  conclusiones.innerHTML=`
    <h3>📋 Resultado de la Fase 5</h3>
    <div class="info">
      Se estableció un <strong>proceso de validación continua</strong> que garantiza la evolución sincronizada de la arquitectura 
      con los cambios funcionales. La trazabilidad completa desde escenarios BDD hasta ADRs permite mantener la coherencia 
      estructural y facilita la toma de decisiones informada. El sistema está preparado para evolucionar de manera controlada 
      y documentada a lo largo del ciclo de vida del producto.
    </div>
  `;
  sec.appendChild(conclusiones);
}

/* ---------- Render all ---------- */
function escapeHtml(s){ return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'\"'":'&#39;'}[m])); }
function init(){
  mountTabs();
  renderMarco();
  renderRequisitos();
  renderBDD();
  renderFase1();
  renderFase2();
  renderFase3();
  renderFase4();
  renderFase5();
  window.addEventListener('resize', ()=>{ if(document.getElementById('fase3').classList.contains('active')) drawEdges(); });
}

/* ---------- Modal Functions ---------- */
function openScenarioModal(scenarioId) {
  const scenario = bddBlocks.find(b => b.tag === `@${scenarioId}`);
  if (!scenario) {
    console.warn(`Escenario no encontrado: ${scenarioId}`);
    return;
  }
  
  document.getElementById('modalTitle').textContent = `Escenario: ${scenarioId}`;
  document.getElementById('modalTags').innerHTML = `<span class="tag">${scenario.feature}</span> <span class="tag">${scenario.tag}</span>`;
  document.getElementById('modalContent').textContent = scenario.text;
  document.getElementById('scenarioModal').style.display = 'flex';
  
  // Prevenir scroll del body
  document.body.style.overflow = 'hidden';
}

function closeScenarioModal() {
  document.getElementById('scenarioModal').style.display = 'none';
  document.body.style.overflow = 'auto';
}

function copyModalContent() {
  const content = document.getElementById('modalContent').textContent;
  navigator.clipboard.writeText(content).then(() => {
    // Feedback visual opcional
    const btn = event.target;
    const originalText = btn.textContent;
    btn.textContent = 'Copiado!';
    setTimeout(() => {
      btn.textContent = originalText;
    }, 1500);
  });
}

// Cerrar modal al hacer click fuera del contenido
document.addEventListener('click', (e) => {
  if (e.target.classList.contains('modal-overlay')) {
    closeScenarioModal();
  }
});

// Cerrar modal con ESC
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    closeScenarioModal();
  }
});

/* ---------- Context Map Download Function ---------- */
function downloadContextMap() {
  const svg = document.getElementById('contextMapSvg');
  if (!svg) {
    alert('Context Map no encontrado');
    return;
  }

  // Clonar el SVG para procesarlo sin afectar el original
  const svgClone = svg.cloneNode(true);
  
  // Obtener las dimensiones del viewBox
  const viewBox = svg.getAttribute('viewBox');
  const [minX, minY, width, height] = viewBox.split(' ').map(Number);
  
  // Crear canvas con alta resolución
  const scale = 2; // Factor de escala para mejor calidad
  const canvas = document.createElement('canvas');
  canvas.width = width * scale;
  canvas.height = height * scale;
  const ctx = canvas.getContext('2d');
  
  // Fondo blanco para la imagen
  ctx.fillStyle = '#ffffff';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  
  // Configurar el SVG clonado para la exportación
  svgClone.setAttribute('width', width);
  svgClone.setAttribute('height', height);
  svgClone.style.background = '#0b1220';
  
  // Convertir SVG a data URL
  const svgData = new XMLSerializer().serializeToString(svgClone);
  const svgBlob = new Blob([svgData], {type: 'image/svg+xml;charset=utf-8'});
  const svgUrl = URL.createObjectURL(svgBlob);
  
  // Crear imagen y dibujar en canvas
  const img = new Image();
  img.onload = function() {
    // Escalar y dibujar
    ctx.drawImage(img, 0, 0, width * scale, height * scale);
    
    // Descargar como PNG
    canvas.toBlob(function(blob) {
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.download = 'bdma-context-map.png';
      link.href = url;
      link.click();
      
      // Limpiar URLs
      URL.revokeObjectURL(url);
      URL.revokeObjectURL(svgUrl);
    }, 'image/png');
  };
  
  img.onerror = function() {
    // Fallback: descargar SVG directamente
    const link = document.createElement('a');
    link.download = 'bdma-context-map.svg';
    link.href = svgUrl;
    link.click();
    URL.revokeObjectURL(svgUrl);
  };
  
  img.src = svgUrl;
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
